<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏°‡∏µ‡∏™‡∏ï‡∏¥‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡∏∏‡∏ì!!</title>
    <meta name="apple-mobile-web-app-title" content="‡∏°‡∏µ‡∏™‡∏ï‡∏¥‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡∏∏‡∏ì!!">
    <meta name="theme-color" content="#fbfaf0">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script>google.charts.load('current', {'packages':['sankey']});</script>

    <style>
        /* CI Colors & Theme (Earth Tone 100%) */
        :root {
            --espresso: #4b2613; --eau-trouble: #a79058; --terre-cuite: #a13a1e; 
            --bleu-porcelaine: #8babca; --nuage-de-lait: #fbfaf0; --miel-dore: #f1c166;     
            --white: #ffffff; --gray-light: #f3f4f6; --gray-text: #6b7280;
            --overlay: rgba(0, 0, 0, 0.6); --danger: #ef4444; --success: #22c55e;
            --mint-light: #ecfdf5; --mint-dark: #15803d;
        }

        * { box-sizing: border-box; font-family: 'Kanit', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: #d1d5db; margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden; overscroll-behavior-y: none; }
        .app { width: 100%; max-width: 420px; background-color: var(--nuage-de-lait); height: 100%; position: relative; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .view-section { display: none; flex: 1; overflow-y: auto; padding: 25px 20px calc(100px + env(safe-area-inset-bottom)) 20px; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }

        .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; gap: 8px; }
        .header h1 { color: var(--espresso); margin: 0; font-size: 18px; font-weight: 700; }
        
        .point-badge { background: linear-gradient(135deg, #fef08a, #fde047); color: #854d0e; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; display: inline-flex; align-items: center; gap: 5px; margin-top: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer;}
        .streak-badge { background: linear-gradient(135deg, var(--miel-dore), var(--eau-trouble)); color: var(--white); padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; display: inline-flex; align-items: center; gap: 5px; margin-top: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);}
        .profile-pic { width: 40px; height: 40px; background-color: var(--miel-dore); border-radius: 50%; display: flex; justify-content: center; align-items: center; color: var(--espresso); font-weight: bold; cursor:pointer; background-size: cover; background-position: center; border: 2px solid var(--white); box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-shrink: 0;}
        .settings-btn { background: var(--gray-light); border: none; font-size: 11px; border-radius: 10px; padding: 4px 8px; cursor: pointer; color: var(--espresso); font-weight: bold; }

        /* Cards & Buttons */
        .card { background: var(--white); border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(84, 41, 22, 0.03); border:1px solid #e5e7eb;}
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .card-title { color: var(--espresso); font-size: 15px; font-weight: 700; margin: 0; display:flex; align-items:center; justify-content:space-between;}
        .btn-main { background: var(--espresso); color: var(--white); border: none; width: 100%; padding: 10px 14px; border-radius: 12px; font-size: 13px; font-weight: 600; cursor: pointer; margin-top: 8px; transition: 0.2s;}
        .btn-main:active { transform: scale(0.96); }
        .btn-outline { background: transparent; border: 1px solid var(--espresso); color: var(--espresso); padding: 5px 10px; border-radius: 8px; font-size: 11px; font-weight: bold; cursor: pointer; }

        /* Tanks */
        .tanks-container { display: flex; justify-content: space-between; height: 160px; align-items: flex-end; }
        .tank-wrapper { display: flex; flex-direction: column; align-items: center; width: 22%; cursor: pointer; transition: 0.2s;}
        .tank-bg { background-color: var(--gray-light); width: 45px; height: 110px; border-radius: 25px; position: relative; overflow: hidden; display: flex; align-items: flex-end; margin-bottom: 5px; }
        .tank-fill { width: 100%; border-radius: 25px; transition: height 0.8s ease-out; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 10px; color: var(--white); font-weight: bold; font-size: 11px; }
        .fill-growth { background-color: var(--bleu-porcelaine); } .fill-security { background-color: var(--miel-dore); color: var(--espresso); }
        .fill-essential { background-color: var(--terre-cuite); } .fill-joy { background-color: var(--eau-trouble); }
        .tank-label { font-size: 12px; color: var(--espresso); font-weight: 700; margin-bottom: -2px; }
        .tank-sub { font-size: 9px; color: var(--gray-text); margin-bottom: 2px;}
        .tank-amount { font-size: 16px; color: var(--espresso); font-weight: 700; margin-top:3px; }

        /* Categories & Quests */
        .categories-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
        .cat-btn { background: var(--gray-light); border-radius: 16px; padding: 12px 5px; display: flex; flex-direction: column; align-items: center; cursor: pointer; position: relative; border: 1px solid transparent;}
        .cat-icon { font-size: 24px; margin-bottom: 5px; }
        .cat-name { font-size: 11px; color: var(--espresso); text-align: center; font-weight:500;}
        .quest-item { display: flex; align-items: flex-start; justify-content: space-between; gap: 10px; font-size: 13px; margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 10px; transition: 0.3s;}
        .quest-item.completed { opacity: 0.5; text-decoration: line-through; }

        /* UI Tabs & Swiper */
        .sub-nav-tabs { display: flex; background: var(--gray-light); border-radius: 12px; padding: 4px; margin-bottom: 15px; }
        .tab-btn { flex: 1; background: transparent; border: none; padding: 8px 0; font-size: 12px; font-weight: 600; color: var(--gray-text); border-radius: 10px; cursor: pointer; transition: 0.3s; }
        .tab-btn.active { background: white; color: var(--espresso); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tab-content { display: none; } .tab-content.active { display: block; animation: fadeIn 0.3s; }
        
        .month-swiper { display:flex; justify-content:space-between; align-items:center; background:white; padding:8px 15px; border-radius:12px; margin-bottom:15px; border:1px solid #e5e7eb; box-shadow: 0 2px 5px rgba(0,0,0,0.02);}
        .swiper-btn { background:var(--gray-light); border:none; font-size:12px; color:var(--espresso); border-radius:8px; cursor:pointer; padding:5px 12px; font-weight:bold;}

        .summary-dashboard { background: var(--espresso); border-radius: 20px; padding: 20px; margin-bottom: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .sum-box { text-align: center; padding: 12px; background: rgba(255,255,255,0.08); border-radius: 14px; }
        .sum-box.full-width { grid-column: 1 / -1; background: white; color: var(--espresso); display:flex; justify-content:space-between; align-items:center; padding:15px 20px;}
        .sum-title { font-size: 11px; color: rgba(255,255,255,0.9); margin: 0 0 8px 0; font-weight:500;}
        .sum-val { font-size: 20px; font-weight: bold; margin: 0;}
        .val-in { color: #86efac; } .val-out { color: #fca5a5; }

        /* Insights Restored CSS */
        .health-badge { display: inline-block; padding: 6px 15px; border-radius: 12px; font-weight: bold; font-size: 14px; color: white; margin-bottom: 10px;}
        .data-insight-box { background: var(--white); border-left: 4px solid var(--bleu-porcelaine); padding: 10px 15px; border-radius: 8px; margin-top:10px; border-top:1px solid #eee; border-right:1px solid #eee; border-bottom:1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.02);}
        .ideal-salary-box { background: linear-gradient(135deg, #dcfce7, #bbf7d0); border: 1px solid #86efac; border-radius: 16px; padding: 15px; margin-top: 15px; display:none;}
        .ai-advisor { background: var(--nuage-de-lait); border: 1px dashed var(--eau-trouble); padding: 15px; border-radius: 12px; margin-top: 15px; }

        /* Navigation */
        .bottom-nav { position: absolute; bottom: 0; left: 0; right: 0; background: var(--white); min-height: 75px; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -5px 20px rgba(0,0,0,0.03); border-radius: 24px 24px 0 0; z-index: 50; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--gray-text); font-size: 10px; cursor: pointer; width: 25%; transition: 0.2s; font-weight:500; }
        .nav-item.active { color: var(--espresso); font-weight: 700; transform: translateY(-3px);}
        .nav-icon { font-size: 20px; margin-bottom: 2px; }
        
        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--overlay); backdrop-filter: blur(2px); z-index: 10000; display: none; opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.active { display: flex; opacity: 1; }
        
        .modal-overlay.bottom-sheet { justify-content: center; align-items: flex-end; }
        .modal-content.bottom-sheet { background: var(--nuage-de-lait); width: 100%; border-radius: 30px 30px 0 0; padding: 30px 25px calc(25px + env(safe-area-inset-bottom)); transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.1); max-height: 85vh; overflow-y: auto; position: relative; }
        .modal-overlay.active .modal-content.bottom-sheet { transform: translateY(0); }
        .drag-handle { width: 40px; height: 5px; background: #cbd5e1; border-radius: 3px; position: absolute; top: 12px; left: 50%; transform: translateX(-50%); }

        .modal-overlay.center-popup { justify-content: center; align-items: center; }
        .modal-content.center-popup { background: var(--nuage-de-lait); width: 90%; max-width: 380px; border-radius: 25px; padding: 25px; transform: scale(0.9); transition: transform 0.3s; max-height: 85vh; overflow-y: auto; position: relative; }
        .modal-overlay.active .modal-content.center-popup { transform: scale(1); }

        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; margin-top:5px; }
        .modal-header h2 { margin: 0; font-size: 16px; color: var(--espresso);}
        .close-btn { background: #e2e8f0; border: none; width: 26px; height: 26px; border-radius: 50%; font-weight: bold; cursor: pointer; color: #475569; display:flex; justify-content:center; align-items:center; font-size:12px;}
        
        /* Form & Misc */
        .form-group { margin-bottom: 15px; text-align:left;} .form-group label { display: block; font-size: 12px; color: var(--espresso); margin-bottom: 5px; font-weight:600;}
        .form-group input, .form-group select { width: 100%; padding: 10px 14px; border-radius: 10px; border: 1px solid #cbd5e1; font-size: 13px; outline: none; background:var(--white); box-sizing: border-box; font-family:'Kanit';}
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed #e5e7eb; }
        .tank-badge { font-size: 9px; padding: 2px 6px; border-radius: 4px; color: white; margin-left: 5px; }
        
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--espresso); color: white; padding: 10px 20px; border-radius: 20px; font-size: 12px; font-weight:bold; z-index: 100000; opacity: 0; transition: 0.3s; pointer-events: none;}
        .toast.show { opacity: 1; }
        .gif-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0, 0.9); z-index: 99999; display: none; justify-content: center; align-items: center; flex-direction: column; opacity: 0; transition: opacity 0.3s; }
        .gif-overlay.show { display: flex; opacity: 1; }
        .gif-overlay img { max-width: 80%; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .chart-container { position: relative; height: 220px; width: 100%; margin-bottom: 20px; display:flex; justify-content:center;}
        
        #onboardingOverlay { position:fixed; top:0; left:0; right:0; bottom:0; background:var(--nuage-de-lait); z-index:999999; display:none; flex-direction:column; padding:40px 20px; text-align:center; overflow-y:auto;}
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="onboardingOverlay">
    <h1 style="color:var(--espresso); margin-top:20px;">üëã ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏ö‡∏≠‡∏™!</h1>
    <p style="color:var(--gray-text); font-size:13px; margin-bottom:30px;">‡∏°‡∏≤‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡πâ AI ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏±‡∏ô</p>
    <div class="card" style="text-align:left;">
        <div class="form-group"><label>1. ‡πÉ‡∏´‡πâ AI ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏ß‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏£?</label><input type="text" id="obName" placeholder="‡πÄ‡∏ä‡πà‡∏ô Dream"></div>
        <div class="form-group"><label>2. ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà? (‡∏£‡∏≠‡∏ö‡∏ö‡∏¥‡∏•)</label><select id="obPayday"><option value="1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1</option><option value="25" selected>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 25</option><option value="28">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 28</option><option value="30">‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option></select></div>
        <div class="form-group"><label>3. ‡∏°‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏µ‡πà‡∏ö‡∏≤‡∏ó?</label><input type="number" id="obTotalMoney" placeholder="0"></div>
        <div class="form-group"><label>4. ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏á‡∏¥‡∏ô</label><select id="obPreset"><option value="balance">‚öñÔ∏è ‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏ä‡∏¥‡∏•‡πÜ (25-50-15-10)</option><option value="invest">üöÄ ‡∏™‡∏≤‡∏¢‡∏•‡∏á‡∏ó‡∏∏‡∏ô (40-35-15-10)</option><option value="debt">üõ°Ô∏è ‡∏£‡∏µ‡∏ö‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏´‡∏ô‡∏µ‡πâ (10-60-20-10)</option></select></div>
    </div>
    <button class="btn-main" onclick="finishOnboarding()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ üöÄ</button>
</div>

<div class="toast" id="toastMsg">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>

<div id="gifOverlay" class="gif-overlay" onclick="closeGifOverlay()">
    <img id="gifImage" src="">
    <h2 id="gifText" style="color:white; margin-top:20px; text-align:center; font-size:16px;"></h2>
</div>

<div class="app">
    <div id="view-home" class="view-section active">
        <div class="header">
            <div class="header-left">
                <h1 id="userGreeting">‡∏°‡∏µ‡∏™‡∏ï‡∏¥‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡∏∏‡∏ì Dream!!!</h1>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <div class="point-badge" onclick="openModal('rewardShopModal')">
                        <span id="userPointsDisplay">ü™ô 0 ‡πÅ‡∏ï‡πâ‡∏°</span>
                    </div>
                    <div class="streak-badge">üî• <span id="streakDisplay">1 ‡∏ß‡∏±‡∏ô</span></div>
                </div>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
                <button class="settings-btn" onclick="openConfigModal()">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
                <div class="profile-pic" id="profilePicDisplay" onclick="document.getElementById('profilePicInput').click()">D</div>
                <input type="file" id="profilePicInput" style="display:none;" accept="image/*" onchange="uploadProfilePic(event)">
            </div>
        </div>

        <div class="card" style="padding: 25px 20px;">
            <div class="card-header" style="margin-bottom:20px;">
                <h2 class="card-title">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô (Tanks)</h2>
                <div style="display:flex; gap:5px;">
                    <button class="btn-outline" style="border-color:var(--bleu-porcelaine); color:var(--bleu-porcelaine);" onclick="openTransferModal()">‚ÜîÔ∏è ‡πÇ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏°‡∏ñ‡∏±‡∏á</button>
                    <button class="btn-outline" onclick="sweepChange()">üßπ ‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©</button>
                </div>
            </div>
            <div class="tanks-container">
                <div class="tank-wrapper" onclick="openTankHistory('growth', 'Growth (‡∏•‡∏á‡∏ó‡∏∏‡∏ô)')">
                    <div class="tank-bg"><div class="tank-fill fill-growth" id="bar-growth">0%</div></div>
                    <div class="tank-label">Growth</div><div class="tank-sub" id="sub-growth">‡∏•‡∏á‡∏ó‡∏∏‡∏ô (25%)</div><div class="tank-amount" id="val-growth">‡∏ø0</div>
                </div>
                <div class="tank-wrapper" onclick="openTankHistory('security', 'Security (‡∏™‡∏≥‡∏£‡∏≠‡∏á)')">
                    <div class="tank-bg"><div class="tank-fill fill-security" id="bar-security">0%</div></div>
                    <div class="tank-label">Security</div><div class="tank-sub" id="sub-security">‡∏™‡∏≥‡∏£‡∏≠‡∏á (50%)</div><div class="tank-amount" id="val-security">‡∏ø0</div>
                </div>
                <div class="tank-wrapper" onclick="openTankHistory('essential', 'Essential (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)')">
                    <div class="tank-bg"><div class="tank-fill fill-essential" id="bar-essential">0%</div></div>
                    <div class="tank-label">Essential</div><div class="tank-sub" id="sub-essential">‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (15%)</div><div class="tank-amount" id="val-essential">‡∏ø0</div>
                </div>
                <div class="tank-wrapper" onclick="openTankHistory('joy', 'Joy (‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï)')">
                    <div class="tank-bg"><div class="tank-fill fill-joy" id="bar-joy">0%</div></div>
                    <div class="tank-label">Joy</div><div class="tank-sub" id="sub-joy">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• (10%)</div><div class="tank-amount" id="val-joy">‡∏ø0</div>
                </div>
            </div>
            <button class="btn-outline" style="width:100%; border-style:dashed; margin-top:25px; padding:10px; color:var(--eau-trouble); border-color:var(--eau-trouble);" onclick="openModal('wishlistModal')">
                ‚è≥ ‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô‡∏î‡∏≠‡∏á‡∏Å‡∏¥‡πÄ‡∏•‡∏™ 7 ‡∏ß‡∏±‡∏ô (<span id="wishlistCount" style="color:var(--danger);">0</span>)
            </button>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 class="card-title">üì§ ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô</h2>
                <div style="display:flex; gap:10px;">
                    <button class="btn-outline" style="border-color:var(--terre-cuite); color:var(--terre-cuite);" onclick="openBulkEntry()">üìù ‡∏£‡∏ß‡∏ö‡∏¢‡∏≠‡∏î</button>
                    <button class="btn-outline" style="border:none; padding:0; text-decoration:underline;" id="editCatBtn" onclick="toggleEditCat()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏°‡∏ß‡∏î</button>
                </div>
            </div>
            <div class="categories-grid" id="homeCategories"></div>
        </div>

        <div class="card" style="background: var(--nuage-de-lait); border: 1px solid var(--eau-trouble);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4 style="margin:0; color:var(--espresso); font-size:15px;">üìú ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏î‡∏±‡∏î‡∏ô‡∏¥‡∏™‡∏±‡∏¢</h4>
                <button class="btn-outline" style="border-color:var(--eau-trouble); color:var(--eau-trouble); padding:4px 8px; font-size:11px;" onclick="openModal('customQuestModal')">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏á</button>
            </div>
            <div id="questList" style="margin-top:10px;"></div>
        </div>

        <div class="card" style="padding: 15px; margin-bottom: 20px; background: var(--white); border:1px solid #e5e7eb;">
            <p style="margin:0 0 5px 0; font-size:12px; color:var(--espresso); font-weight:bold;">üì• ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (Auto ‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô)</p>
            <div style="display: flex; gap: 8px; margin-bottom: 10px; width: 100%;">
                <input type="number" id="mainIncomeInput" placeholder="‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô" style="width: 100px; flex-shrink: 0; border: 1px solid #cbd5e1; padding: 10px; border-radius: 10px; outline: none; font-size:14px; box-sizing: border-box;">
                <select id="incomeCatSelect" style="flex-grow: 1; min-width: 0; border: 1px solid #cbd5e1; padding: 10px; border-radius: 10px; outline: none; background: white; font-size:13px; box-sizing: border-box;" onchange="if(this.value==='add_new') openModal('addIncomeCatModal')"></select>
            </div>
            
            <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                <select id="incomeTargetTank" style="flex: 1; border: 1px solid #cbd5e1; padding: 10px; border-radius: 10px; outline: none; background: var(--nuage-de-lait); color: var(--espresso); font-size:13px; box-sizing: border-box; font-weight:bold;">
                    <option value="auto">ü™Ñ ‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏≠‡∏≠‡πÇ‡∏ï‡πâ‡∏ï‡∏≤‡∏° %</option>
                    <option value="essential">üõí ‡πÄ‡∏Ç‡πâ‡∏≤ Essential 100%</option>
                    <option value="joy">üéâ ‡πÄ‡∏Ç‡πâ‡∏≤ Joy 100%</option>
                    <option value="security">üõ°Ô∏è ‡πÄ‡∏Ç‡πâ‡∏≤ Security 100%</option>
                    <option value="growth">üå± ‡πÄ‡∏Ç‡πâ‡∏≤ Growth 100%</option>
                </select>
                <input type="date" id="incomeDateInput" style="flex: 1; border: 1px solid #cbd5e1; padding: 10px; border-radius: 10px; outline: none; color:var(--espresso); font-size:13px; box-sizing: border-box;">
            </div>
            
            <button class="btn-main" style="margin-top: 0; background:var(--bleu-porcelaine);" onclick="confirmIncome()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</button>
            <p id="incomeCreditWarning" style="margin:8px 0 0 0; font-size:11px; color:var(--danger); display:none; font-weight:bold;">üö® ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏ô‡∏∞‡∏ö‡∏≠‡∏™! ‡∏°‡∏µ‡∏ö‡∏¥‡∏•‡∏ö‡∏±‡∏ï‡∏£/‡∏ú‡πà‡∏≠‡∏ô ‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏¢‡∏π‡πà ‡∏ø<span id="warnCreditAmt">0</span></p>
        </div>
    </div>

    <div id="view-fixed" class="view-section">
        <div class="header"><h1>üìÖ ‡∏†‡∏≤‡∏£‡∏∞ & ‡∏ö‡∏¥‡∏•</h1></div>
        <div class="sub-nav-tabs">
            <button class="tab-btn active" id="btn-tab-credit" onclick="switchSubTab('fixed', 'tab-credit')">‡∏ö‡∏¥‡∏•‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢</button>
            <button class="tab-btn" id="btn-tab-monthly" onclick="switchSubTab('fixed', 'tab-monthly')">‡∏ö‡∏¥‡∏•‡∏õ‡∏£‡∏∞‡∏à‡∏≥</button>
            <button class="tab-btn" id="btn-tab-yearly" onclick="switchSubTab('fixed', 'tab-yearly')">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</button>
        </div>

        <div id="tab-credit" class="tab-content active">
            <div class="card" style="background: var(--nuage-de-lait); border: 1px solid var(--bleu-porcelaine);">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 class="card-title" style="color:var(--bleu-porcelaine); margin:0;">üí≥ ‡∏ö‡∏¥‡∏•‡∏£‡∏≠‡∏ï‡∏±‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h2>
                    <button class="btn-outline" style="padding:4px 8px; border-color:var(--bleu-porcelaine); color:var(--bleu-porcelaine);" onclick="openModal('addLegacyDebtModal')">+ ‡∏ö‡∏¥‡∏•‡πÄ‡∏Å‡πà‡∏≤</button>
                </div>
                <p style="font-size:10px; color:var(--bleu-porcelaine); margin:5px 0 10px 0;">*‡πÄ‡∏á‡∏¥‡∏ô‡∏ñ‡∏π‡∏Å‡∏Å‡∏±‡∏ô‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà Security ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏î "‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</p>
                <div id="creditBillList"></div>
            </div>
        </div>

        <div id="tab-monthly" class="tab-content">
            <div class="card" style="background: var(--nuage-de-lait); border: 1px solid var(--terre-cuite); padding:15px; margin-bottom:15px;">
                <p style="margin:0; font-size:12px; color:var(--espresso);">‡∏†‡∏≤‡∏£‡∏∞‡∏ú‡∏π‡∏Å‡∏û‡∏±‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ <span id="fixedPctTxt" style="font-weight:bold; color:var(--danger);">0%</span></p>
                <div style="width: 100%; height: 6px; background: #e5e7eb; border-radius: 3px; margin: 8px 0 10px 0; overflow: hidden;"><div style="height: 100%; background: var(--danger); width: 0%; transition: width 0.5s;" id="fixedPctBar"></div></div>
            </div>
            <div class="card">
                <h2 class="card-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏•‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
                <div id="fixedCostList"></div>
                <button class="btn-main" style="background:var(--gray-light); color:var(--espresso);" onclick="openAddFixedModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏¥‡∏•‡πÉ‡∏´‡∏°‡πà</button>
            </div>
        </div>

        <div id="tab-yearly" class="tab-content">
            <div class="card" style="background: var(--nuage-de-lait); border: 1px solid var(--miel-dore);">
                <h2 class="card-title" style="color:var(--espresso); margin-bottom:0;">üéØ ‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</h2>
                <p style="font-size:10px; color:var(--gray-text); margin-top:5px;">‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ 12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏ä‡πá‡∏≠‡∏ï‡∏ï‡∏≠‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏õ‡∏µ!</p>
                <div id="yearlyFundList"></div>
                <button class="btn-main" style="background:var(--miel-dore); color:var(--espresso); margin-top:10px;" onclick="openModal('addYearlyModal')">+ ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</button>
            </div>
        </div>
    </div>

    <div id="view-debt" class="view-section">
        <div class="header"><h1>ü§ù ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ (‡πÄ‡∏á‡∏¥‡∏ô‡∏¢‡∏∑‡∏°)</h1><button class="btn-outline" style="border:none; padding:0; text-decoration:underline;" onclick="openModal('debtLogModal')">üïí ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button></div>
        <div class="card" style="background: #fef2f2; border: 1px solid var(--terre-cuite); padding: 25px 20px; text-align: center; margin-bottom: 15px;">
            <p style="margin:0; font-size:13px; color:var(--terre-cuite); font-weight:bold;">‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ (‡∏¢‡∏∑‡∏°‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô)</p>
            <h2 style="margin:10px 0 0 0; font-size:32px; color:var(--danger);" id="totalLiabilityDisplay">‡∏ø0</h2>
        </div>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <button class="btn-main" style="flex:1; background: var(--danger); margin-top:0;" onclick="openModal('addDebtModal')">üì• ‡∏¢‡∏∑‡∏°‡πÉ‡∏´‡∏°‡πà</button>
            <button class="btn-main" style="flex:1; background: var(--success); margin-top:0;" onclick="openModal('payDebtModal')">üì§ ‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏µ‡πâ</button>
            <button class="btn-main" style="width:100%; background: var(--terre-cuite); margin-top:0;" onclick="openModal('addLegacyBorrowedModal')">üìú + ‡∏´‡∏ô‡∏µ‡πâ‡∏¢‡∏∑‡∏°‡πÄ‡∏Å‡πà‡∏≤ (‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡πÅ‡∏≠‡∏õ)</button>
        </div>
        
        <div class="card" style="margin-top:20px;">
            <h3 style="margin: 0 0 15px 0; font-size: 14px;">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ</h3>
            <div class="chart-container" style="height: 180px;"><canvas id="debtChart"></canvas></div>
        </div>
        
        <div class="card" style="margin-top:20px; background:var(--nuage-de-lait); border:1px solid var(--eau-trouble);">
            <h3 style="margin: 0 0 5px 0; font-size: 14px; color:var(--espresso);">üí∏ ‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏°‡∏∏‡∏ô / ‡∏£‡∏≠‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå</h3>
            <p style="font-size:10px; color:var(--gray-text); margin-top:0;">‡πÄ‡∏á‡∏¥‡∏ô‡∏ñ‡∏π‡∏Å‡∏´‡∏±‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (‡∏£‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô)</p>
            <ul id="receivableList" style="list-style: none; padding: 0; margin: 0;"></ul>
        </div>
    </div>

    <div id="view-analytics" class="view-section">
        <div class="header"><h1>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• & ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h1><button class="btn-outline" style="background:var(--gray-light);" onclick="switchTab('view-cashflow', document.querySelectorAll('.nav-item')[2]); drawSankey();">üåä Cashflow</button></div>

        <div class="month-swiper">
            <button class="swiper-btn" onclick="changeMonth(-1)">‚óÄ</button>
            <span id="currentMonthDisplay" style="font-weight:bold; color:var(--espresso); font-size:13px;">‡∏£‡∏≠‡∏ö‡∏ö‡∏¥‡∏•</span>
            <button class="swiper-btn" onclick="changeMonth(1)">‚ñ∂</button>
        </div>

        <div class="sub-nav-tabs" style="margin-bottom: 15px;">
            <button class="tab-btn active" id="btn-tab-overview" onclick="switchAnalyticTab('tab-overview')">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
            <button class="tab-btn" id="btn-tab-insights" onclick="switchAnalyticTab('tab-insights')">‡πÄ‡∏à‡∏≤‡∏∞‡∏•‡∏∂‡∏Å‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</button>
        </div>

        <div id="tab-overview" class="tab-content active">
            <div class="summary-dashboard">
                <div class="sum-box"><p class="sum-title">üì• ‡∏´‡∏≤‡πÑ‡∏î‡πâ (In)</p><p class="sum-val val-in" id="sumIncomeText">‡∏ø0</p></div>
                <div class="sum-box"><p class="sum-title">üì§ ‡πÉ‡∏ä‡πâ‡πÑ‡∏õ (Out)</p><p class="sum-val val-out" id="sumExpenseText">‡∏ø0</p></div>
                <div class="sum-box full-width">
                    <div style="text-align:left;"><p style="margin:0; font-size:12px; color:var(--espresso); font-weight:bold;">üí∞ ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Net)</p><p class="sum-val" id="sumNetText" style="color:var(--success); font-size:20px; margin-top:5px;">‡∏ø0</p></div>
                    <div style="text-align:right;"><p style="margin:0; font-size:11px; color:var(--gray-text);" id="sumPctText">‡πÉ‡∏ä‡πâ‡πÑ‡∏õ 0%</p></div>
                </div>
            </div>
            <div class="card">
                <div class="chart-container" style="height:250px;"><canvas id="analyticsChart"></canvas></div>
                <p id="noDataText" style="text-align:center; display:none; color:var(--gray-text); font-size:12px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
            </div>
        </div>

        <div id="tab-insights" class="tab-content">
            <div class="card" style="text-align:center;">
                <p style="margin:0 0 10px 0; font-size:12px; color:var(--gray-text);">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                <div id="healthBadge" class="health-badge">üöÄ ‡πÄ‡∏•‡πÄ‡∏ß‡∏• 5: ‡∏°‡∏±‡πà‡∏á‡∏Ñ‡∏±‡πà‡∏á‡∏≠‡∏¥‡∏™‡∏£‡∏∞</div>
                <p id="healthDesc" style="margin:5px 0 0 0; font-size:12px; font-weight:500;"></p>
            </div>

            <div id="idealSalaryBox" class="ideal-salary-box" style="display:block;">
                <h3 style="margin:0 0 5px 0; color:#166534; font-size:14px;">üí° ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</h3>
                <p style="margin:0; font-size:11px; color:#15803d;">‡∏à‡∏≤‡∏Å‡πÑ‡∏•‡∏ü‡πå‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÑ‡∏î‡πâ‡∏ä‡∏¥‡∏•‡πÜ ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô (E+J = <span id="idealPctShow">0</span>%) ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö:</p>
                <h2 style="margin:10px 0; font-size:24px; color:#166534; text-align:center;" id="idealSalaryTxt">‡∏ø0 <span style="font-size:12px;">/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span></h2>
                <p style="margin:0; font-size:10px; color:#166534;">*‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ √∑ ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏ö‡∏Å‡∏¥‡∏ô‡πÉ‡∏ä‡πâ</p>
            </div>

            <div class="card" style="background: rgba(139, 171, 202, 0.1);">
                <h3 style="margin:0 0 10px 0; font-size: 14px; color:var(--bleu-porcelaine);">üîç ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å (Insights)</h3>
                <div class="data-insight-box">
                    <p style="margin:0; font-size:11px; color:var(--gray-text);">üõí ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô Joy (‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï)</p>
                    <div style="display:flex; justify-content:space-between; margin-top:5px;">
                        <span style="font-weight:bold; color:var(--terre-cuite); font-size:12px;">‚ú® <span id="insightSmallWin">‡∏Å‡∏¥‡∏ô‡∏á‡∏ö‡πÑ‡∏õ 0%</span></span>
                        <span style="font-weight:bold; color:var(--bleu-porcelaine); font-size:12px;">üéØ <span id="insightBigWin">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 100%</span></span>
                    </div>
                </div>
                <div class="data-insight-box" style="border-left-color: var(--eau-trouble);">
                    <p style="margin:0; font-size:11px; color:var(--gray-text);">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>
                    <h4 style="margin:5px 0 0 0; font-size:14px; color:var(--espresso);">‡∏ß‡∏±‡∏ô<span id="insightDay">-</span></h4>
                </div>
                <div class="data-insight-box" style="border-left-color: var(--danger);">
                    <p style="margin:0; font-size:11px; color:var(--gray-text);">‚ö†Ô∏è ‡πÅ‡∏´‡∏Å‡∏Å‡∏é‡∏î‡∏∂‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏°‡∏ñ‡∏±‡∏á</p>
                    <h4 style="margin:5px 0 0 0; font-size:14px; color:var(--danger);"><span id="insightCrossCount">0</span> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á <span style="font-size:11px; font-weight:normal; color:var(--espresso);">(‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: <span id="insightCrossReason">-</span>)</span></h4>
                </div>
                <div class="data-insight-box" style="border-left-color: var(--success);">
                    <p style="margin:0; font-size:11px; color:var(--gray-text);">üõ°Ô∏è ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏î‡∏∂‡∏á‡∏™‡∏ï‡∏¥ (7-Day Rule)</p>
                    <h4 style="margin:5px 0 0 0; font-size:14px; color:var(--success);">‡∏£‡∏≠‡∏î‡πÑ‡∏õ ‡∏ø<span id="insightSavedTemptation">0</span></h4>
                    <p style="margin:2px 0 0 0; font-size:10px; color:var(--espresso);">‡∏ä‡∏ô‡∏∞‡πÉ‡∏à‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á: <span id="insightWinTemptCount" style="color:var(--success); font-weight:bold;">0</span> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á | ‡πÅ‡∏û‡πâ‡∏Å‡∏¥‡πÄ‡∏•‡∏™: <span id="insightLoseTemptCount" style="color:var(--danger); font-weight:bold;">0</span> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                </div>
                <div class="data-insight-box" style="border-left-color: #8b5cf6;">
                    <p style="margin:0; font-size:11px; color:var(--gray-text);">üîÆ ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏â‡∏±‡∏ô‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï (‡∏´‡∏ô‡∏µ‡πâ‡∏ö‡∏±‡∏ï‡∏£/‡∏ú‡πà‡∏≠‡∏ô)</p>
                    <h4 style="margin:5px 0 0 0; font-size:14px; color:#8b5cf6;">‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏ö‡∏¥‡∏•‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢ ‡∏ø<span id="insightFutureMoney">0</span></h4>
                    <p style="margin:2px 0 0 0; font-size:10px; color:var(--espresso);" id="insightFutureAdvice"></p>
                </div>
            </div>

            <div class="ai-advisor">
                <h4 style="margin:0 0 5px 0; font-size:13px; color:var(--bleu-porcelaine); display:flex; align-items:center; gap:5px;">üëî ‡πÄ‡∏•‡∏Ç‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h4>
                <p id="aiAdviceText" style="margin:0; line-height:1.5; font-size:12px; color:var(--espresso);">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
        </div>
    </div>

    <div id="view-cashflow" class="view-section">
        <div class="header"><h1>üåä ‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</h1><button class="btn-outline" style="background:var(--gray-light);" onclick="document.getElementById('view-cashflow').classList.remove('active'); document.getElementById('view-analytics').classList.add('active');">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö ‚Ü©Ô∏è</button></div>
        <div class="card" style="background: white; border: 1px solid var(--bleu-porcelaine);">
            <p style="font-size:11px; color:var(--gray-text); margin-top:0;">‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏Ç‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ</p>
            <div id="sankey_basic" style="width: 100%; height: 450px; display: flex; justify-content: flex-start; align-items: center; overflow-x: auto;">
                <p style="color:#888;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏≤‡∏ü...</p>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('view-home', this)"><div class="nav-icon">üè†</div>‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</div>
        <div class="nav-item" onclick="switchTab('view-fixed', this)"><div class="nav-icon">üìÖ</div>‡∏ö‡∏¥‡∏•/‡πÄ‡∏õ‡πâ‡∏≤</div>
        <div class="nav-item" onclick="switchTab('view-analytics', this); renderAnalyticsCycle();"><div class="nav-icon">üìä</div>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
        <div class="nav-item" onclick="switchTab('view-debt', this); renderDebtChart();"><div class="nav-icon">ü§ù</div>‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô</div>
    </nav>
</div> 

<div class="modal-overlay bottom-sheet" id="expenseModal" onclick="if(event.target===this) closeModal('expenseModal')">
    <div class="modal-content bottom-sheet">
        <div class="drag-handle"></div>
        <div class="modal-header"><h2 id="expenseTitle">‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô</h2><button class="close-btn" onclick="closeModal('expenseModal')">‚úï</button></div>
        <div class="form-group"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ø)</label><input type="number" id="exAmount" placeholder="0" style="font-size:20px; font-weight:bold; color:var(--danger);" oninput="checkExpenseLogic()"></div>
        <div class="form-group"><label>‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</label>
            <select id="exTank" onchange="checkExpenseLogic()">
                <option value="essential">üõí Essential (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)</option>
                <option value="joy">üéâ Joy (‡∏Å‡∏¥‡πÄ‡∏•‡∏™)</option>
                <option value="security">üõ°Ô∏è Security (‡∏™‡∏≥‡∏£‡∏≠‡∏á)</option>
            </select>
        </div>
        <div class="form-group"><label>üí≥ ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô</label>
            <select id="exPayMethod" onchange="toggleInstallmentInput()">
                <option value="‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢/‡πÇ‡∏≠‡∏ô">üì± ‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢ / ‡πÇ‡∏≠‡∏ô</option>
                <option value="‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
                <option value="‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï">üí≥ ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</option>
                <option value="‡∏ú‡πà‡∏≠‡∏ô (BNPL)">üõçÔ∏è ‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</option>
            </select>
        </div>
        <div class="form-group" id="installmentDiv" style="display:none; background:var(--nuage-de-lait); padding:10px; border-radius:10px; border: 1px dashed var(--bleu-porcelaine);">
            <label style="color:var(--bleu-porcelaine);">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≠‡∏ô</label><input type="number" id="exInstallmentMonths" placeholder="‡πÄ‡∏ä‡πà‡∏ô 3">
        </div>
        <div class="form-group" id="joyTypeDiv" style="display:none; background:var(--nuage-de-lait); padding:10px; border-radius:10px;">
            <label style="color:var(--eau-trouble);">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</label>
            <select id="exJoyType" style="margin-bottom:10px;"><option value="small">‚ú® Small Win (‡∏Å‡∏¥‡∏ô‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß)</option><option value="big">üéØ Big Win (‡∏Ç‡∏≠‡∏á‡∏ä‡∏¥‡πâ‡∏ô‡πÉ‡∏´‡∏ç‡πà)</option></select>
            <label style="color:var(--espresso);">üé≠ ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏ï‡∏≠‡∏ô‡∏ã‡∏∑‡πâ‡∏≠</label>
            <select id="exEmotion"><option value="ü§© ‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á">ü§© ‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á</option><option value="üò© ‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡πÄ‡∏•‡∏¢‡∏ä‡πâ‡∏≠‡∏õ">üò© ‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡πÄ‡∏•‡∏¢‡∏ä‡πâ‡∏≠‡∏õ</option><option value="üßü‚Äç‚ôÇÔ∏è ‡πÇ‡∏î‡∏ô‡∏õ‡πâ‡∏≤‡∏¢‡∏¢‡∏≤">üßü‚Äç‚ôÇÔ∏è ‡πÇ‡∏î‡∏ô‡∏õ‡πâ‡∏≤‡∏¢‡∏¢‡∏≤</option><option value="üçª ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏°">üçª ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏° (‡πÄ‡∏õ‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô)</option></select>
        </div>
        <div class="form-group" id="needDiv" style="display:none; background:var(--nuage-de-lait); padding:10px; border-radius:10px; border: 1px dashed var(--terre-cuite);">
            <label style="color:var(--terre-cuite);">‚öñÔ∏è ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (‡∏´‡πâ‡∏≤‡∏°‡∏´‡∏•‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á!)</label>
            <select id="exNeedRating"><option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (‡∏Ç‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)</option><option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏Å)</option><option value="3">‚≠ê‚≠ê‚≠ê (‡∏Å‡∏∂‡πà‡∏á‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô ‡∏Å‡∏∂‡πà‡∏á‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ)</option><option value="2">‚≠ê‚≠ê (‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å)</option><option value="1">‚≠ê (‡∏£‡∏π‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏Å‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÅ‡∏Ñ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ ü§£)</option></select>
        </div>
        <div class="form-group" style="background:var(--nuage-de-lait); padding:10px; border-radius:10px; border:1px dashed var(--miel-dore);">
            <label style="color:var(--espresso); display:flex; align-items:center; gap:5px; margin-bottom:0; cursor:pointer;">
                <input type="checkbox" id="isReimbursable" onchange="document.getElementById('reimbursableDiv').style.display = this.checked ? 'block' : 'none';" style="width:auto; accent-color:var(--miel-dore);"> ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô (‡∏£‡∏≠‡∏´‡∏≤‡∏£/‡∏£‡∏≠‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå)
            </label>
            <div id="reimbursableDiv" style="display:none; margin-top:10px;">
                <input type="number" id="exReimbursableAmt" placeholder="‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô (‡∏ø)" style="margin-bottom:5px;">
                <input type="text" id="exLendTo" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏¢‡∏∑‡∏°/‡πÅ‡∏Å‡πä‡∏á‡∏Ñ‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô">
            </div>
        </div>
        <div class="form-group"><label>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label><input type="text" id="exNote" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..."></div>
        
        <div class="cross-tank-box" id="crossTankBox" style="background:#fee2e2; border:1px solid var(--danger); display:none; padding:10px; border-radius:10px; margin-bottom:15px;">
            <p style="color:var(--danger); font-weight:bold; margin-top:0;">‚ö†Ô∏è ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠! ‡∏Ç‡∏≤‡∏î‡∏≠‡∏µ‡∏Å <span id="shortfallText">‡∏ø0</span></p>
            <div class="form-group"><label>‡∏î‡∏∂‡∏á‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏°‡∏≤‡πÇ‡∏õ‡∏∞:</label><select id="backupTank"></select></div>
            <div class="form-group" style="margin-bottom:0;"><label style="color:var(--espresso);">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏´‡∏Å‡∏Å‡∏é?</label><select id="crossReason"><option value="‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÜ">üö® ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</option><option value="‡πÅ‡∏û‡πâ‡∏Å‡∏¥‡πÄ‡∏•‡∏™">üòà ‡πÅ‡∏û‡πâ‡∏Å‡∏¥‡πÄ‡∏•‡∏™</option><option value="‡∏•‡∏∑‡∏°‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô">üòÖ ‡∏•‡∏∑‡∏°‡∏Ñ‡∏¥‡∏î</option></select></div>
        </div>
        <button class="btn-main" onclick="submitExpense()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡πà‡∏≤‡∏¢</button>
    </div>
</div>

<div class="modal-overlay bottom-sheet" id="transferModal" onclick="if(event.target===this) closeModal('transferModal')">
    <div class="modal-content bottom-sheet">
        <div class="drag-handle"></div>
        <div class="modal-header"><h2>‚ÜîÔ∏è ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤</h2><button class="close-btn" onclick="closeModal('transferModal')">‚úï</button></div>
        <div class="form-group"><label>‡∏î‡∏∂‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å:</label><select id="tfFrom" onchange="checkTransferFriction()"><option value="essential">üõí Essential</option><option value="joy">üéâ Joy</option><option value="security">üõ°Ô∏è Security</option><option value="growth">üå± Growth</option></select></div>
        <div class="form-group"><label>‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡πÉ‡∏™‡πà‡πÉ‡∏ô:</label><select id="tfTo" onchange="checkTransferFriction()"><option value="joy">üéâ Joy</option><option value="essential">üõí Essential</option><option value="security">üõ°Ô∏è Security</option><option value="growth">üå± Growth</option></select></div>
        <div class="form-group"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ø)</label><input type="number" id="tfAmt" placeholder="0" style="font-size:20px; font-weight:bold;"></div>
        
        <div id="transferFrictionBox" style="display:none; background:#fee2e2; border:1px dashed var(--danger); padding:15px; border-radius:12px; margin-bottom:15px; text-align:center;">
            <p style="color:var(--danger); font-size:13px; font-weight:bold; margin:0 0 10px 0;">üö® ‡∏à‡∏∞‡∏î‡∏∂‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡∏¢‡πå‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏î‡∏¥?</p>
            <p style="color:var(--danger); font-size:11px; margin:0 0 10px 0;">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡∏à‡∏∞‡∏ä‡πâ‡∏≤‡∏•‡∏á‡∏ô‡∏∞ ‡∏û‡∏¥‡∏°‡∏û‡πå <b>"‡∏â‡∏±‡∏ô‡∏ï‡∏ö‡∏∞‡πÅ‡∏ï‡∏Å"</b> ‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</p>
            <input type="text" id="tfConfirmWord" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå ‡∏â‡∏±‡∏ô‡∏ï‡∏ö‡∏∞‡πÅ‡∏ï‡∏Å" style="width:100%; padding:10px; border-radius:8px; border:1px solid #fca5a5; text-align:center; color:var(--danger); font-weight:bold;" onkeyup="checkFrictionWord()">
        </div>
        <button class="btn-main" id="btnTransferSubmit" onclick="processTransfer()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô</button>
    </div>
</div>

<div class="modal-overlay bottom-sheet" id="bulkEntryModal" onclick="if(event.target===this) closeModal('bulkEntryModal')">
    <div class="modal-content bottom-sheet"><div class="drag-handle"></div>
        <div class="modal-header"><h2>üìù Daily Dump</h2><button class="close-btn" onclick="closeModal('bulkEntryModal')">‚úï</button></div>
        <p style="font-size:11px; color:var(--gray-text); margin-top:-10px;">‡∏à‡∏î‡∏£‡∏ß‡∏ö‡∏¢‡∏≠‡∏î‡∏ï‡∏≠‡∏ô‡πÄ‡∏¢‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏•‡∏¢! (‡∏£‡∏±‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™ +15 ‡πÅ‡∏ï‡πâ‡∏°)</p>
        <div style="margin-bottom: 10px; display:flex; align-items:center; gap:10px; background:var(--nuage-de-lait); padding:10px; border-radius:10px;">
            <label style="font-size:12px; color:var(--espresso); font-weight:bold;">‡∏à‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
            <input type="date" id="bulkEntryDate" style="flex:1; border:1px solid #cbd5e1; padding:5px 10px; border-radius:8px; outline:none;">
        </div>
        <div id="bulkRows" style="max-height: 50vh; overflow-y: auto; margin-bottom:15px; padding-right:5px;"></div>
        <button class="btn-outline" style="width:100%; border-style:dashed; margin-bottom:10px; color:var(--espresso); border-color:var(--espresso);" onclick="addBulkRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡∏Å 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        <button class="btn-main" style="background:var(--success);" onclick="submitBulkEntry()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>
</div>

<div class="modal-overlay center-popup" id="configModal" onclick="if(event.target===this) closeModal('configModal')">
    <div class="modal-content center-popup">
        <div class="modal-header"><h2>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå & %</h2><button class="close-btn" onclick="closeModal('configModal')">‚úï</button></div>
        
        <div style="display:flex; gap:10px;">
            <div class="form-group" style="flex:1;"><label>‡∏ä‡∏∑‡πà‡∏≠</label><input type="text" id="userNameInput"></div>
            <div class="form-group" style="flex:1;"><label>‡∏£‡∏≠‡∏ö‡∏ö‡∏¥‡∏• (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà)</label><input type="number" id="cfgPayday" min="1" max="31" placeholder="‡πÄ‡∏ä‡πà‡∏ô 25"></div>
        </div>
        
        <p style="font-size:12px; color:var(--gray-text); margin-top:5px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Preset ‡πÉ‡∏´‡πâ AI ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏¥‡∏î‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤</p>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 15px;">
            <div style="background:var(--gray-light); padding:8px; border-radius:8px; text-align:center; font-size:11px; cursor:pointer; color:var(--espresso); font-weight:bold;" onclick="applyPreset(25,50,15,10)">‚öñÔ∏è ‡∏™‡∏°‡∏î‡∏∏‡∏•<br>(25-50-15-10)</div>
            <div style="background:var(--gray-light); padding:8px; border-radius:8px; text-align:center; font-size:11px; cursor:pointer; color:var(--espresso); font-weight:bold;" onclick="applyPreset(40,35,15,10)">üöÄ ‡∏•‡∏á‡∏ó‡∏∏‡∏ô<br>(40-35-15-10)</div>
            <div style="background:var(--gray-light); padding:8px; border-radius:8px; text-align:center; font-size:11px; cursor:pointer; color:var(--espresso); font-weight:bold;" onclick="applyPreset(10,60,20,10)">üõ°Ô∏è ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏´‡∏ô‡∏µ‡πâ<br>(10-60-20-10)</div>
        </div>
        
        <div style="display:flex; gap:10px;">
            <div class="form-group" style="flex:1;"><label>Growth</label><input type="number" id="cfgG"></div>
            <div class="form-group" style="flex:1;"><label>Security</label><input type="number" id="cfgS"></div>
        </div>
        <div style="display:flex; gap:10px;">
            <div class="form-group" style="flex:1;"><label>Essential</label><input type="number" id="cfgE"></div>
            <div class="form-group" style="flex:1;"><label>Joy</label><input type="number" id="cfgJ"></div>
        </div>
        <button class="btn-main" onclick="saveConfig()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô</button>

        <p style="font-size:13px; color:var(--espresso); margin-top:20px; font-weight:bold; border-top:1px dashed #ccc; padding-top:15px;">üí∞ ‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô (‡∏¢‡∏∂‡∏î‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏à‡∏£‡∏¥‡∏á)</p>
        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <div class="form-group" style="flex:1; margin-bottom:0;"><label style="color:var(--bleu-porcelaine);">Growth</label><input type="number" id="initG"></div>
            <div class="form-group" style="flex:1; margin-bottom:0;"><label style="color:var(--miel-dore);">Security</label><input type="number" id="initS"></div>
        </div>
        <div style="display:flex; gap:10px;">
            <div class="form-group" style="flex:1; margin-bottom:0;"><label style="color:var(--terre-cuite);">Essential</label><input type="number" id="initE"></div>
            <div class="form-group" style="flex:1; margin-bottom:0;"><label style="color:var(--eau-trouble);">Joy</label><input type="number" id="initJ"></div>
        </div>
        <button class="btn-outline" style="width:100%; margin-top:10px; border-color:var(--bleu-porcelaine); color:var(--bleu-porcelaine);" onclick="saveConfig()">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô</button>

        <div style="margin-top:20px; padding-top:15px; border-top:1px dashed #ccc; display:flex; gap:10px;">
            <button class="btn-outline" style="flex:1; border-color:var(--espresso); color:var(--espresso);" onclick="exportData()">üíæ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <label class="btn-outline" style="flex:1; border-color:var(--terre-cuite); color:var(--terre-cuite); text-align:center; cursor:pointer; padding-top:6px;">üìÇ ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•<input type="file" style="display:none;" accept=".json" onchange="importData(event)"></label>
        </div>
        
        <button class="btn-outline" style="width:100%; border-color:var(--danger); color:var(--danger); margin-top:15px;" onclick="clearData()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>
</div>

<div class="modal-overlay center-popup" id="rewardShopModal" onclick="if(event.target===this) closeModal('rewardShopModal')">
    <div class="modal-content center-popup">
        <div class="modal-header"><h2>üõí ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°</h2><button class="close-btn" onclick="closeModal('rewardShopModal')">‚úï</button></div>
        <p style="text-align:center; font-size:14px; margin-top:-10px;">‡πÅ‡∏ï‡πâ‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: <strong style="color:#854d0e; font-size:16px;" id="shopPointsDisplay">0</strong></p>
        
        <div style="max-height: 300px; overflow-y:auto; padding-right:5px;">
            <p style="font-size:11px; font-weight:bold; color:var(--gray-text); margin:0 0 5px 0;">üì± ‡∏´‡∏°‡∏ß‡∏î‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ</p>
            <div class="reward-item" style="border:1px solid #e5e7eb; padding:10px; border-radius:10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;"><div style="font-size:11px;"><h4 style="margin:0; color:var(--bleu-porcelaine);">üéüÔ∏è ‡πÇ‡∏≠‡∏ô Essential ‡πÄ‡∏Ç‡πâ‡∏≤ Joy</h4><p style="margin:0; color:var(--gray-text);">‡∏î‡∏∂‡∏á 500‡∏ø ‡∏°‡∏≤‡∏™‡∏°‡∏ó‡∏ö‡∏ó‡∏∏‡∏ô‡πÅ‡∏ö‡∏ö‡∏ñ‡∏π‡∏Å‡∏Å‡∏é</p></div><button class="btn-outline" style="border-color:var(--bleu-porcelaine); color:var(--bleu-porcelaine); font-size:10px;" onclick="buyReward('üéüÔ∏è ‡πÇ‡∏≠‡∏ô Essential ‡πÄ‡∏Ç‡πâ‡∏≤ Joy 500‡∏ø', 1500)">1500 ‡πÅ‡∏ï‡πâ‡∏°</button></div>
            <div class="reward-item" style="border:1px solid #e5e7eb; padding:10px; border-radius:10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;"><div style="font-size:11px;"><h4 style="margin:0; color:var(--danger);">üßº ‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏≤‡∏õ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h4><p style="margin:0; color:var(--gray-text);">‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏´‡∏Å‡∏Å‡∏é 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p></div><button class="btn-outline" style="border-color:var(--danger); color:var(--danger); font-size:10px;" onclick="buyReward('üßº ‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏≤‡∏õ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥', 1000)">1000 ‡πÅ‡∏ï‡πâ‡∏°</button></div>
            <div class="reward-item" style="border:1px solid #e5e7eb; padding:10px; border-radius:10px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;"><div style="font-size:11px;"><h4 style="margin:0; color:var(--terre-cuite);">üç∞ ‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÑ‡∏£‡πâ‡∏™‡∏≤‡∏£‡∏∞</h4><p style="margin:0; color:var(--gray-text);">‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô E ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ AI ‡πÑ‡∏°‡πà‡∏î‡πà‡∏≤!</p></div><button class="btn-outline" style="border-color:var(--terre-cuite); color:var(--terre-cuite); font-size:10px;" onclick="buyReward('üç∞ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡πÑ‡∏£‡πâ‡∏™‡∏≤‡∏£‡∏∞ 1 ‡∏ä‡∏¥‡πâ‡∏ô', 800)">800 ‡πÅ‡∏ï‡πâ‡∏°</button></div>

            <p style="font-size:11px; font-weight:bold; color:var(--espresso); margin:0 0 5px 0;">üåç ‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏ß‡∏á‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡πÇ‡∏•‡∏Å‡∏à‡∏£‡∏¥‡∏á</p>
            <div class="reward-item" style="border:1px dashed var(--eau-trouble); background:var(--nuage-de-lait); padding:10px; border-radius:10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;"><div style="font-size:11px;"><h4 style="margin:0; color:var(--espresso);">ü§ù ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏¢‡πå‡∏°‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ</h4><p style="margin:0; color:var(--gray-text);">‡∏¢‡∏∑‡πà‡∏ô‡∏à‡∏≠‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô/‡πÅ‡∏ü‡∏ô ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏Ç‡πâ‡∏≤‡∏ß!</p></div><button class="btn-main" style="width:auto; background:var(--eau-trouble); font-size:10px; padding:6px 10px; margin:0;" onclick="buyReward('ü§ù ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏¢‡πå‡∏°‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ', 2000)">2000 ‡πÅ‡∏ï‡πâ‡∏°</button></div>
            <div class="reward-item" style="border:1px dashed var(--eau-trouble); background:var(--nuage-de-lait); padding:10px; border-radius:10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;"><div style="font-size:11px;"><h4 style="margin:0; color:var(--espresso);">üöó ‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô‡∏ü‡∏£‡∏µ 1 ‡∏ß‡∏±‡∏ô</h4><p style="margin:0; color:var(--gray-text);">‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏ô‡πÑ‡∏õ‡∏™‡πà‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏£‡∏ñ‡πÉ‡∏´‡πâ</p></div><button class="btn-main" style="width:auto; background:var(--eau-trouble); font-size:10px; padding:6px 10px; margin:0;" onclick="buyReward('üöó ‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô‡∏ü‡∏£‡∏µ 1 ‡∏ß‡∏±‡∏ô (‡∏°‡∏µ‡∏Ñ‡∏ô‡πÄ‡∏õ‡∏¢‡πå)', 1200)">1200 ‡πÅ‡∏ï‡πâ‡∏°</button></div>
            <div class="reward-item" style="border:1px dashed var(--eau-trouble); background:var(--nuage-de-lait); padding:10px; border-radius:10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;"><div style="font-size:11px;"><h4 style="margin:0; color:var(--espresso);">üõãÔ∏è ‡∏•‡∏∞‡πÄ‡∏ß‡πâ‡∏ô‡∏á‡∏≤‡∏ô‡∏ö‡πâ‡∏≤‡∏ô 1 ‡∏ß‡∏±‡∏ô</h4><p style="margin:0; color:var(--gray-text);">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏•‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏ô! ‡πÇ‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏≥</p></div><button class="btn-main" style="width:auto; background:var(--eau-trouble); font-size:10px; padding:6px 10px; margin:0;" onclick="buyReward('üõãÔ∏è ‡∏•‡∏∞‡πÄ‡∏ß‡πâ‡∏ô‡∏á‡∏≤‡∏ô‡∏ö‡πâ‡∏≤‡∏ô 1 ‡∏ß‡∏±‡∏ô', 1000)">1000 ‡πÅ‡∏ï‡πâ‡∏°</button></div>
            <div class="reward-item" style="border:1px dashed var(--eau-trouble); background:var(--nuage-de-lait); padding:10px; border-radius:10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;"><div style="font-size:11px;"><h4 style="margin:0; color:var(--espresso);">üç≤ ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≤‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß</h4><p style="margin:0; color:var(--gray-text);">‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ" ‡∏â‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏á</p></div><button class="btn-main" style="width:auto; background:var(--eau-trouble); font-size:10px; padding:6px 10px; margin:0;" onclick="buyReward('üç≤ ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≤‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß (‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏ñ‡∏µ‡∏¢‡∏á)', 600)">600 ‡πÅ‡∏ï‡πâ‡∏°</button></div>
        </div>
        <h4 style="margin:15px 0 10px 0; font-size:13px;">üéí ‡∏Ñ‡∏•‡∏±‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h4><div id="inventoryList" style="font-size:12px; color:var(--gray-text);"></div>
    </div>
</div>

<div class="modal-overlay center-popup" id="customQuestModal" onclick="if(event.target===this) closeModal('customQuestModal')">
    <div class="modal-content center-popup">
        <div class="modal-header"><h2>‚ú® ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á</h2><button class="close-btn" onclick="closeModal('customQuestModal')">‚úï</button></div>
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏ó‡∏≥</label><input type="text" id="cqName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ 1 ‡∏ö‡∏ó"></div>
        <div class="form-group"><label>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å (AI ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏ï‡πâ‡∏°)</label>
            <select id="cqDiff">
                <option value="30">üü¢ ‡∏á‡πà‡∏≤‡∏¢ (+30 ‡πÅ‡∏ï‡πâ‡∏°)</option>
                <option value="60">üü° ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (+60 ‡πÅ‡∏ï‡πâ‡∏°)</option>
                <option value="100">üî¥ ‡∏¢‡∏≤‡∏Å (+100 ‡πÅ‡∏ï‡πâ‡∏°)</option>
            </select>
        </div>
        <button class="btn-main" onclick="addCustomQuest()">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏•‡∏∏‡∏¢!</button>
    </div>
</div>

<div class="modal-overlay center-popup" id="wishlistModal" onclick="if(event.target===this) closeModal('wishlistModal')">
    <div class="modal-content center-popup">
        <div class="modal-header"><h2>‚è≥ ‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô‡∏î‡∏≠‡∏á‡∏Å‡∏¥‡πÄ‡∏•‡∏™</h2><button class="close-btn" onclick="closeModal('wishlistModal')">‚úï</button></div>
        <p style="font-size:11px; color:var(--gray-text); margin-top:-10px;">‡∏£‡∏≠‡∏Ñ‡∏£‡∏ö 7 ‡∏ß‡∏±‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à (‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á‡∏£‡∏±‡∏ö +50 ‡πÅ‡∏ï‡πâ‡∏°!)</p>
        <div id="wishlistContainer"></div>
    </div>
</div>

<div class="modal-overlay center-popup" id="addIncomeCatModal" onclick="if(event.target===this) closeModal('addIncomeCatModal')">
    <div class="modal-content center-popup">
        <div class="modal-header"><h2>‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</h2><button class="close-btn" onclick="closeModal('addIncomeCatModal'); renderIncomeCats();">‚úï</button></div>
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</label><input type="text" id="newIncCatName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏±‡∏ô‡∏ú‡∏•"></div>
        <div class="form-group"><label>‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥ 1 ‡∏ï‡∏±‡∏ß</label><input type="text" id="newIncCatIcon" placeholder="üìà" maxlength="2"></div>
        <button class="btn-main" onclick="saveIncomeCategory()">‡∏™‡∏£‡πâ‡∏≤‡∏á</button>
    </div>
</div>

<div class="modal-overlay center-popup" id="addCatModal" onclick="if(event.target===this) closeModal('addCatModal')">
    <div class="modal-content center-popup">
        <div class="modal-header"><h2>‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô</h2><button class="close-btn" onclick="closeModal('addCatModal')">‚úï</button></div>
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î</label><input type="text" id="newCatName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡πÅ‡∏ü"></div>
        <div class="form-group"><label>‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥ 1 ‡∏ï‡∏±‡∏ß</label><input type="text" id="newCatIcon" placeholder="‚òï" maxlength="2"></div>
        <div class="form-group"><label>‡∏´‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label><select id="newCatTank"><option value="essential">Essential</option><option value="joy">Joy</option><option value="security">Security</option></select></div>
        <button class="btn-main" onclick="saveNewCategory()">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°</button>
    </div>
</div>

<div class="modal-overlay center-popup" id="debtLogModal" onclick="if(event.target===this) closeModal('debtLogModal')">
    <div class="modal-content center-popup">
        <div class="modal-header"><h2>üïí ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô</h2><button class="close-btn" onclick="closeModal('debtLogModal')">‚úï</button></div>
        <ul id="debtLogList" style="list-style: none; padding: 0; margin: 0;"></ul>
    </div>
</div>

<div class="modal-overlay center-popup" id="addFixedModal" onclick="if(event.target===this) closeModal('addFixedModal')">
    <div class="modal-content center-popup">
        <div class="modal-header"><h2>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏¥‡∏•/‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</h2><button class="close-btn" onclick="closeModal('addFixedModal')">‚úï</button></div>
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏õ/‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label><input type="text" id="fcName" placeholder="‡πÄ‡∏ä‡πà‡∏ô Netflix"></div>
        <div class="form-group"><label>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (‡∏ø)</label><input type="number" id="fcAmount"></div>
        <div class="form-group"><label>‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥</label><input type="text" id="fcIcon" placeholder="üßæ" maxlength="2"></div>
        <div class="form-group"><label>‡πÉ‡∏´‡πâ‡∏´‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÑ‡∏´‡∏ô?</label><select id="fcTank"><option value="essential">Essential</option><option value="joy">Joy</option><option value="security">Security</option></select></div>
        <div class="form-group" style="margin-top:10px;">
            <label style="color:var(--espresso); display:flex; align-items:center; gap:5px; cursor:pointer;">
                <input type="checkbox" id="fcIsInst" onchange="document.getElementById('fcInstDiv').style.display = this.checked ? 'flex' : 'none';" style="width:auto; accent-color:var(--espresso);"> ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞
            </label>
        </div>
        <div class="form-group" id="fcInstDiv" style="display:none; gap:10px; background:var(--nuage-de-lait); padding:10px; border-radius:10px; border:1px dashed #cbd5e1;">
            <div style="flex:1;"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label><input type="number" id="fcTotalM" placeholder="‡πÄ‡∏ä‡πà‡∏ô 60"></div>
            <div style="flex:1;"><label>‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß (‡∏á‡∏ß‡∏î)</label><input type="number" id="fcPaidM" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2"></div>
        </div>
        <button class="btn-main" onclick="saveFixedCost()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
</div>

<div class="modal-overlay center-popup" id="addYearlyModal" onclick="if(event.target===this) closeModal('addYearlyModal')">
    <div class="modal-content center-popup">
        <div class="modal-header"><h2>üéØ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</h2><button class="close-btn" onclick="closeModal('addYearlyModal')">‚úï</button></div>
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏ñ)</label><input type="text" id="yName"></div>
        <div class="form-group"><label>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≠‡∏õ‡∏µ (‡∏ø)</label><input type="number" id="yAmount"></div>
        <button class="btn-main" onclick="saveYearlyFund()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
</div>

<div class="modal-overlay center-popup" id="editTxModal" onclick="if(event.target===this) closeModal('editTxModal')">
    <div class="modal-content center-popup">
        <div class="modal-header"><h2>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h2><button class="close-btn" onclick="closeModal('editTxModal')">‚úï</button></div>
        <input type="hidden" id="editTxId">
        <div class="form-group"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="editTxDate"></div>
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label><input type="text" id="editTxCat"></div>
        <div class="form-group"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ø)</label><input type="number" id="editTxAmt"></div>
        <div class="form-group"><label>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥</label><input type="text" id="editTxNote"></div>
        <button class="btn-main" onclick="saveEditTransaction()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
    </div>
</div>

<div class="modal-overlay center-popup" id="historyModal" onclick="if(event.target===this) closeModal('historyModal')">
    <div class="modal-content center-popup">
        <div class="modal-header"><h2 id="historyTitle">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h2><button class="close-btn" onclick="closeModal('historyModal')">‚úï</button></div>
        <p id="historyDesc" class="tank-desc-text" style="font-size:11px; color:var(--gray-text); margin-top:-5px;">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</p>
        <div id="growthPortfolioSection" class="goal-box" style="display:none; background:var(--nuage-de-lait); border:1px solid var(--bleu-porcelaine); padding:10px; border-radius:12px; margin-bottom:15px;">
            <h4 style="margin:0 0 10px 0; color:var(--espresso); font-size:12px;">üìà ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏±‡∏î‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏à‡∏≤‡∏Å‡∏≠‡∏≤‡∏¢‡∏∏ (<span id="portAgeDisplay"></span> ‡∏õ‡∏µ)</h4>
            <div style="display:flex; justify-content:space-between; font-size:10px; margin-bottom:5px;">
                <span style="font-weight:bold; color:var(--terre-cuite);">‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á: <span id="portHighPct">0%</span></span>
                <span style="font-weight:bold; color:var(--bleu-porcelaine);">‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥: <span id="portLowPct">0%</span></span>
            </div>
            <div style="height: 12px; background: var(--bleu-porcelaine); border-radius: 6px; overflow: hidden; position: relative; margin-bottom: 5px;"><div id="portBar" style="height: 100%; background: var(--terre-cuite);"></div></div>
        </div>
        <div id="goalSection" class="goal-box" style="display:none; background:white; border:1px solid #ddd; padding:10px; border-radius:12px; margin-bottom:15px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h4 style="margin:0; font-size:13px;" id="goalHeaderTxt">üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</h4>
                <button class="btn-outline" style="padding:2px 8px; font-size:9px;" onclick="editGoal()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            </div>
            <div id="goalDisplay">
                <p style="margin:0 0 5px 0; font-size:14px; font-weight:bold; color:var(--terre-cuite);" id="goalNameTxt">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</p>
                <div style="height: 12px; background: #e5e7eb; border-radius: 6px; overflow: hidden; position: relative; margin-bottom: 5px;"><div id="goalBar" style="height: 100%; background: linear-gradient(90deg, var(--miel-dore), var(--eau-trouble)); transition: width 0.5s; display:flex; justify-content:flex-end; align-items:center; padding-right:5px; color:white; font-size:9px; font-weight:bold;">0%</div></div>
                <p style="margin:5px 0 0 0; font-size:11px;">‡∏™‡∏∞‡∏™‡∏°‡πÑ‡∏î‡πâ <strong id="goalCurrTxt">‡∏ø0</strong> / <span id="goalTargetTxt">‡∏ø0</span></p>
                <p style="margin:5px 0 0 0; font-size:10px; color:var(--danger);" id="goalWarnTxt"></p>
                <div id="goalActionBtn" style="display:none; margin-top:10px;"><button class="btn-main" style="padding:8px; font-size:12px; background:var(--success);" onclick="claimGoal()">üéâ ‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏õ‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡∏ù‡∏±‡∏ô!</button></div>
            </div>
            <div id="goalEdit" style="display:none;">
                <input type="text" id="goalNameInput" style="width:100%; padding:8px; margin-bottom:5px; border-radius:8px; border:1px solid #ccc; font-size:12px;" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢">
                <input type="number" id="goalTargetInput" style="width:100%; padding:8px; margin-bottom:5px; border-radius:8px; border:1px solid #ccc; font-size:12px;" placeholder="‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏ø)">
                <button class="btn-main" style="padding:8px; font-size:12px; margin-top:5px;" onclick="saveGoal()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</button>
            </div>
        </div>
        <p style="text-align: center; margin-top: 5px;">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <strong id="historyBalance" style="font-size:20px; color:var(--espresso);">‡∏ø0</strong></p>
        <div class="chart-container" style="height: 180px;"><canvas id="tankChart"></canvas></div>
        <ul id="historyList" style="list-style:none; padding:0; margin:0;"></ul>
    </div>
</div>

<div class="modal-overlay center-popup" id="addDebtModal" onclick="if(event.target===this) closeModal('addDebtModal')">
    <div class="modal-content center-popup"><div class="modal-header"><h2>üì• ‡∏¢‡∏∑‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏≤</h2><button class="close-btn" onclick="closeModal('addDebtModal')">‚úï</button></div>
    <div class="form-group"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ø)</label><input type="number" id="borrowAmt"></div>
    <div class="form-group"><label>‡∏¢‡∏∑‡∏°‡πÉ‡∏Ñ‡∏£‡∏°‡∏≤ (‡πÄ‡∏Ç‡πâ‡∏≤ Essential)</label><input type="text" id="borrowNote" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏°‡πà, ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô"></div><button class="btn-main" onclick="processBorrow()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button></div>
</div>

<div class="modal-overlay center-popup" id="payDebtModal" onclick="if(event.target===this) closeModal('payDebtModal')">
    <div class="modal-content center-popup"><div class="modal-header"><h2>üì§ ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏µ‡πâ</h2><button class="close-btn" onclick="closeModal('payDebtModal')">‚úï</button></div>
    <div class="form-group"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ø)</label><input type="number" id="paybackAmt"></div>
    <div class="form-group"><label>‡∏Ñ‡∏∑‡∏ô‡πÉ‡∏´‡πâ‡πÉ‡∏Ñ‡∏£?</label><select id="paybackLender"><option value="‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option></select></div>
    <p style="font-size:10px; color:var(--danger); margin-top:-5px;">*‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≠‡∏î Security ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p><button class="btn-main" onclick="processPayback()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button></div>
</div>

<div class="modal-overlay center-popup" id="futureWarningModal" onclick="if(event.target===this) closeModal('futureWarningModal')">
    <div class="modal-content center-popup" style="text-align: center;">
        <div style="font-size: 50px; margin-top: 10px; margin-bottom: 10px;">üîÆ</div>
        <h2 style="color: var(--bleu-porcelaine); margin: 0 0 10px 0; font-size: 20px;">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ... ‡∏â‡∏±‡∏ô‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï!</h2>
        <p style="color: var(--espresso); font-size: 13px; margin-bottom: 15px;">‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤‡∏£‡∏π‡∏î‡∏ö‡∏±‡∏ï‡∏£/‡∏¢‡∏∑‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡πÑ‡∏õ:</p>
        <div style="background: var(--nuage-de-lait); border-radius: 15px; padding: 15px; margin-bottom: 20px; border: 1px dashed #cbd5e1;">
            <h1 style="color: var(--danger); font-size: 32px; margin: 0;">‡∏ø<span id="futureWarningAmt">0</span></h1>
        </div>
        <button class="btn-main" style="background: var(--bleu-porcelaine); font-size: 14px;" onclick="closeModal('futureWarningModal'); switchTab('view-fixed', document.querySelectorAll('.nav-item')[1]);">‡∏û‡∏≤‡πÑ‡∏õ‡∏à‡πà‡∏≤‡∏¢‡∏ö‡∏¥‡∏•‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ üöÄ</button>
    </div>
</div>

<div class="modal-overlay center-popup" id="addLegacyDebtModal" onclick="if(event.target===this) closeModal('addLegacyDebtModal')">
    <div class="modal-content center-popup">
        <div class="modal-header"><h2>üí≥ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏¥‡∏•‡πÄ‡∏Å‡πà‡∏≤ (‡∏ö‡∏±‡∏ï‡∏£/‡∏ú‡πà‡∏≠‡∏ô)</h2><button class="close-btn" onclick="closeModal('addLegacyDebtModal')">‚úï</button></div>
        <p style="font-size:10px; color:var(--danger); margin-top:-10px;">*‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÜ</p>
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ / ‡∏ö‡∏±‡∏ï‡∏£</label><input type="text" id="ldName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏±‡∏ï‡∏£ KBank"></div>
        <div class="form-group"><label>‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢ "‡∏ï‡πà‡∏≠‡∏á‡∏ß‡∏î" (‡∏ø)</label><input type="number" id="ldAmt"></div>
        <div class="form-group"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà</label><input type="number" id="ldMonths" value="1"></div>
        <button class="btn-main" style="background:var(--bleu-porcelaine);" onclick="saveLegacyDebt()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤</button>
    </div>
</div>

<div class="modal-overlay center-popup" id="editFixedModal" onclick="if(event.target===this) closeModal('editFixedModal')">
    <div class="modal-content center-popup">
        <div class="modal-header"><h2>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏¥‡∏•/‡∏ú‡πà‡∏≠‡∏ô</h2><button class="close-btn" onclick="closeModal('editFixedModal')">‚úï</button></div>
        <input type="hidden" id="efcId">
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label><input type="text" id="efcName"></div>
        <div class="form-group"><label>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (‡∏ø)</label><input type="number" id="efcAmount"></div>
        <div class="form-group"><label>‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥</label><input type="text" id="efcIcon" maxlength="2"></div>
        <div class="form-group"><label>‡∏´‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÑ‡∏´‡∏ô?</label><select id="efcTank"><option value="essential">Essential</option><option value="joy">Joy</option><option value="security">Security</option></select></div>
        <div class="form-group" style="margin-top:10px;"><label style="color:var(--espresso); display:flex; align-items:center; gap:5px;"><input type="checkbox" id="efcIsInst" onchange="document.getElementById('efcInstDiv').style.display = this.checked ? 'flex' : 'none';" style="width:auto;"> ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô</label></div>
        <div class="form-group" id="efcInstDiv" style="display:none; gap:10px; background:var(--nuage-de-lait); padding:10px; border-radius:10px;"><div style="flex:1;"><label>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label><input type="number" id="efcTotalM"></div><div style="flex:1;"><label>‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</label><input type="number" id="efcPaidM"></div></div>
        <button class="btn-main" onclick="saveEditFixedCost()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
    </div>
</div>

<div class="modal-overlay center-popup" id="editLegacyDebtModal" onclick="if(event.target===this) closeModal('editLegacyDebtModal')">
    <div class="modal-content center-popup">
        <div class="modal-header"><h2>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤</h2><button class="close-btn" onclick="closeModal('editLegacyDebtModal')">‚úï</button></div>
        <input type="hidden" id="eldId">
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label><input type="text" id="eldName"></div>
        <div class="form-group"><label>‡∏¢‡∏≠‡∏î‡∏ï‡πà‡∏≠‡∏á‡∏ß‡∏î (‡∏ø)</label><input type="number" id="eldAmt"></div>
        <div class="form-group"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠</label><input type="number" id="eldMonths"></div>
        <button class="btn-main" style="background:var(--bleu-porcelaine);" onclick="saveEditLegacyDebt()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
    </div>
</div>

<div class="modal-overlay center-popup" id="addLegacyBorrowedModal" onclick="if(event.target===this) closeModal('addLegacyBorrowedModal')">
    <div class="modal-content center-popup">
        <div class="modal-header"><h2>üìú ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏µ‡πâ‡∏¢‡∏∑‡∏°‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤</h2><button class="close-btn" onclick="closeModal('addLegacyBorrowedModal')">‚úï</button></div>
        <p style="font-size:10px; color:var(--terre-cuite); margin-top:-10px;">*‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°‡∏°‡∏≤‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡πÅ‡∏≠‡∏õ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏Ñ‡πà‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ)</p>
        <div class="form-group"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ø)</label><input type="number" id="lbAmt"></div>
        <div class="form-group"><label>‡∏¢‡∏∑‡∏°‡πÉ‡∏Ñ‡∏£‡∏°‡∏≤?</label><input type="text" id="lbNote" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏°‡πà, ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô"></div>
        <button class="btn-main" style="background:var(--terre-cuite);" onclick="saveLegacyBorrowed()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡πà‡∏≤</button>
    </div>
</div>

<script>
    Chart.register(ChartDataLabels);
    Chart.defaults.set('plugins.datalabels', {
        color: '#ffffff', font: { family: 'Kanit', weight: 'bold', size: 10 },
        formatter: (value, ctx) => {
            let sum = 0; let dataArr = ctx.chart.data.datasets[0].data; dataArr.map(data => sum += data);
            let pct = (value * 100 / sum).toFixed(0); return pct > 5 ? pct + '%' : ''; 
        }
    });

    // --- 1. Variables & Global State ---
    let cfg = { g: 25, s: 50, e: 15, j: 10, payday: 25 }; let userName = 'Dream'; let userAge = 33; let totalIncomeThisMonth = 0; 
    let profileImgBase64 = null; let baseAmounts = { growth: 0, security: 0, essential: 0, joy: 0 }; 
    let currentBalances = { growth: 0, security: 0, essential: 0, joy: 0 };
    let joyGoal = { name: '‡∏ó‡∏£‡∏¥‡∏õ‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô', target: 50000 }; let secGoal = { name: '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', target: 100000 };
    let totalLiability = 0; let transactions = []; let isEditCatMode = false; let currentActiveGoalTank = '';
    let stats = { savedFromTemptation: 0, crossTankCount: 0, achievedJoy: false, achievedSec: false, temptationAbandonedCount: 0, temptationYieldedCount: 0, monthlyGrowthTouched: false };
    let userPoints = 0; let inventory = []; let streakCount = 1; let lastActiveDate = ''; let viewingMonthOffset = 0;
    let incomeCats = [ {id: 1, name: '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', icon: 'üí∞'}, {id: 2, name: '‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°/‡∏ü‡∏£‡∏µ‡πÅ‡∏•‡∏ô‡∏ã‡πå', icon: 'üíª'}, {id: 3, name: '‡∏õ‡∏±‡∏ô‡∏ú‡∏•/‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢', icon: 'üìà'} ];
    const questPool = [
        {id: 1, title: 'üç± ‡∏´‡πà‡∏≠‡∏Ç‡πâ‡∏≤‡∏ß‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô 3 ‡∏ß‡∏±‡∏ô', pts: 50}, {id: 2, title: '‚òï ‡∏á‡∏î‡∏™‡∏±‡πà‡∏á‡∏Å‡∏≤‡πÅ‡∏ü‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå 5 ‡∏ß‡∏±‡∏ô', pts: 80},
        {id: 3, title: 'üôÖ‚Äç‚ôÇÔ∏è ‡πÑ‡∏°‡πà‡∏î‡∏∂‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏•‡∏¢ 7 ‡∏ß‡∏±‡∏ô', pts: 150}, {id: 4, title: 'üèÉ‚Äç‚ôÇÔ∏è ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏ô‡πÅ‡∏ó‡∏ô‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡πâ‡∏≤‡∏á', pts: 50},
        {id: 5, title: 'üßπ ‡∏Å‡∏î‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏•‡∏á‡∏ó‡∏∏‡∏ô', pts: 20}, {id: 6, title: 'üíß ‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÅ‡∏ó‡∏ô‡∏ä‡∏≤‡∏ô‡∏° 3 ‡∏ß‡∏±‡∏ô', pts: 60},
        {id: 7, title: 'üßæ ‡∏à‡πà‡∏≤‡∏¢‡∏ö‡∏¥‡∏•‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö', pts: 100}, {id: 8, title: 'üìä ‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡∏´‡∏ô‡πâ‡∏≤ Analytics ‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', pts: 30},
        {id: 9, title: '‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Sub ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏î‡∏π 1 ‡πÅ‡∏≠‡∏õ', pts: 150}, {id: 10, title: 'üõµ ‡∏ô‡∏±‡πà‡∏á‡∏£‡∏ñ‡πÄ‡∏°‡∏•‡πå/BTS ‡πÅ‡∏ó‡∏ô‡πÅ‡∏ó‡πá‡∏Å‡∏ã‡∏µ‡πà 3 ‡∏ß‡∏±‡∏ô', pts: 50},
        {id: 11, title: 'üö´ ‡∏á‡∏î‡∏™‡∏±‡πà‡∏á Delivery ‡∏°‡∏∑‡πâ‡∏≠‡∏î‡∏∂‡∏Å 3 ‡∏ß‡∏±‡∏ô', pts: 100}, {id: 12, title: 'üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô 1 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå', pts: 200},
        {id: 13, title: 'üõçÔ∏è ‡∏ä‡∏ô‡∏∞‡πÉ‡∏à‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á ‡∏ó‡∏¥‡πâ‡∏á‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ 24h', pts: 100}, {id: 14, title: 'üìö ‡∏ü‡∏±‡∏á Podcast ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô 1 ‡∏ï‡∏≠‡∏ô', pts: 40}
    ];
    let activeQuests = [];
    let customCats = [
        {id: 1, name: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£', icon: 'üçõ', tank: 'essential'}, {id: 2, name: '‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á', icon: 'üöÜ', tank: 'essential'},
        {id: 3, name: '‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß', icon: 'üë®‚Äçüë©‚Äçüëß', tank: 'essential'}, {id: 4, name: '‡∏†‡∏≤‡∏©‡∏µ‡∏™‡∏±‡∏á‡∏Ñ‡∏°', icon: 'üíå', tank: 'joy'},
        {id: 5, name: '‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á', icon: 'üõçÔ∏è', tank: 'joy'}, {id: 6, name: '‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà', icon: '‚òï', tank: 'joy'}
    ];
    let fixedCosts = [{id: 1, name: 'Netflix', icon: 'üé¨', amount: 419, tank: 'joy', paidThisMonth: false}];
    let yearlyFunds = [{id: 1, name: '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå', amount: 12000, current: 0, paidMonths: 0, monthlyVal: 1000}];
    let wishlist = []; let activeExpenseCat = ''; let activeFixedId = null;
    let analyticsChartInstance, tankChartInstance, debtChartInstance;
    const tankDesc = {
        growth: "üå± <strong>Growth (‡∏•‡∏á‡∏ó‡∏∏‡∏ô):</strong> ‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πà‡∏≠‡∏¢‡∏≠‡∏î‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï ‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏∏‡πâ‡∏ô, ‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô",
        security: "üõ°Ô∏è <strong>Security (‡∏™‡∏≥‡∏£‡∏≠‡∏á/‡∏´‡∏ô‡∏µ‡πâ):</strong> ‡πÄ‡∏Å‡∏£‡∏≤‡∏∞‡∏Ñ‡∏∏‡πâ‡∏°‡∏†‡∏±‡∏¢! ‡πÄ‡∏á‡∏¥‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô, ‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ",
        essential: "üõí <strong>Essential (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô):</strong> ‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢ 4 ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£, ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á",
        joy: "üéâ <strong>Joy (‡∏Å‡∏¥‡πÄ‡∏•‡∏™‡∏•‡πâ‡∏ß‡∏ô‡πÜ):</strong> ‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç... ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏™‡∏ï‡∏¥‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ö‡∏≠‡∏™!"
    };

    function showGifOverlay(type) {
        let gifOverlay = document.getElementById('gifOverlay'); let gifImage = document.getElementById('gifImage'); let gifText = document.getElementById('gifText');
        if (type === 'goal') { gifImage.src = "https://media1.tenor.com/m/oRUoS4uBbQIAAAAd/khun-thee-lacorn.gif"; gifText.innerText = "üéâ ‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì! ‡∏û‡∏¥‡∏ä‡∏¥‡∏ï‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"; }
        else if (type === 'crosstank') { gifImage.src = "https://media1.tenor.com/m/kSwhTm-9DYIAAAAd/angry-khun-thee.gif"; gifText.innerText = "‡∏ñ‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏ñ‡∏≠‡∏∞‡∏´‡πå ‡∏ô‡∏µ‡πà‡∏î‡∏∂‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏á‡∏±‡πâ‡∏ô‡πÄ‡∏´‡∏£‡∏≠"; }
        else if (type === 'joy_warn') { gifImage.src = "https://media1.tenor.com/m/orvLKT5PVg0AAAAd/khunthee-catcrce.gif"; gifText.innerText = `‡∏î‡∏∂‡∏á‡∏™‡∏ï‡∏¥‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ö‡∏≠‡∏™! ‡πÉ‡∏´‡πâ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÅ‡∏ä‡πà‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô 7 ‡∏ß‡∏±‡∏ô‡∏ô‡∏∞`; }
        else if (type === 'expense_saved') { gifImage.src = "https://media1.tenor.com/m/XjmdrDMoO_kAAAAC/khun-thee-lacorn.gif"; gifText.innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏ö‡∏≠‡∏™!"; }
        else if (type === 'income') { gifImage.src = "https://media1.tenor.com/m/jYur0uCjtjsAAAAd/khun-thee-lacorn.gif"; gifText.innerText = "‡πÅ‡∏ö‡∏á‡∏Ñ‡πå‡∏û‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô üí∏ ‡∏°‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á"; }
        else if (type === 'wishlist_skip') { gifImage.src = "https://media1.tenor.com/m/2bGj2dzR-d4AAAAC/huh-disgusted.gif"; gifText.innerText = "‡πÑ‡∏î‡πâ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ñ‡∏≠‡∏∞‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå ‡πÄ‡∏≠‡∏≤‡πÉ‡∏´‡πâ‡∏°‡∏±‡∏ô‡∏™‡∏≤‡πÅ‡∏Å‡πà‡πÉ‡∏à‡∏ã‡∏∞‡∏™‡∏¥"; }
        else if (type === 'wishlist_delete') { gifImage.src = "https://media1.tenor.com/m/j7A3Sc2dZ0QAAAAC/khun-thee-pond-naravit.gif"; gifText.innerText = "‡∏â‡∏±‡∏ô‡∏°‡∏≠‡∏á‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡∏ú‡∏¥‡∏î‡∏à‡∏£‡∏¥‡∏á‡πÜ"; }
        gifOverlay.classList.add('show'); setTimeout(() => { closeGifOverlay(); }, 4500);
    }
    function closeGifOverlay() { document.getElementById('gifOverlay').classList.remove('show'); }

    // --- 2. Storage & Init ---
    function loadStorage() {
        try {
            if(localStorage.getItem('wq18_age')) userAge = parseInt(localStorage.getItem('wq18_age'));
            if(localStorage.getItem('wq18_name')) userName = localStorage.getItem('wq18_name');
            if(localStorage.getItem('wq18_pts')) userPoints = parseInt(localStorage.getItem('wq18_pts'));
            if(localStorage.getItem('wq18_inv')) inventory = JSON.parse(localStorage.getItem('wq18_inv'));
            if(localStorage.getItem('wq18_cfg')) cfg = JSON.parse(localStorage.getItem('wq18_cfg'));
            if(localStorage.getItem('wq18_base')) baseAmounts = JSON.parse(localStorage.getItem('wq18_base'));
            if(localStorage.getItem('wq18_curr')) currentBalances = JSON.parse(localStorage.getItem('wq18_curr'));
            if(localStorage.getItem('wq18_tx')) transactions = JSON.parse(localStorage.getItem('wq18_tx'));
            if(localStorage.getItem('wq18_cat')) customCats = JSON.parse(localStorage.getItem('wq18_cat'));
            if(localStorage.getItem('wq18_fc')) fixedCosts = JSON.parse(localStorage.getItem('wq18_fc'));
            if(localStorage.getItem('wq18_yf')) yearlyFunds = JSON.parse(localStorage.getItem('wq18_yf'));
            if(localStorage.getItem('wq18_wl')) wishlist = JSON.parse(localStorage.getItem('wq18_wl'));
            if(localStorage.getItem('wq18_q')) activeQuests = JSON.parse(localStorage.getItem('wq18_q'));
            if(localStorage.getItem('wq18_debt')) totalLiability = parseFloat(localStorage.getItem('wq18_debt'));
            if(localStorage.getItem('wq18_inc')) totalIncomeThisMonth = parseFloat(localStorage.getItem('wq18_inc'));
            if(localStorage.getItem('wq18_joyG')) joyGoal = JSON.parse(localStorage.getItem('wq18_joyG'));
            if(localStorage.getItem('wq18_secG')) secGoal = JSON.parse(localStorage.getItem('wq18_secG'));
            if(localStorage.getItem('wq18_stats')) stats = JSON.parse(localStorage.getItem('wq18_stats'));
            if(localStorage.getItem('wq18_incCat')) incomeCats = JSON.parse(localStorage.getItem('wq18_incCat'));
            if(localStorage.getItem('wq18_profileImg')) profileImgBase64 = localStorage.getItem('wq18_profileImg');
            if(localStorage.getItem('wq18_streak')) streakCount = parseInt(localStorage.getItem('wq18_streak'));
            if(localStorage.getItem('wq18_lastLogin')) lastActiveDate = localStorage.getItem('wq18_lastLogin');
        } catch (e) { console.error("Error loading storage", e); }
        
        // Daily Streak Logic
        let todayStr = new Date().toLocaleDateString('en-CA', {timeZone: 'Asia/Bangkok'});
        if(lastActiveDate !== todayStr) {
            let yest = new Date(); yest.setDate(yest.getDate()-1);
            if(lastActiveDate === yest.toLocaleDateString('en-CA', {timeZone: 'Asia/Bangkok'})) streakCount++; else if(lastActiveDate) streakCount = 1;
            lastActiveDate = todayStr;
        }

        if(!cfg.payday) cfg.payday = 25; // Default Fallback
        if(!localStorage.getItem('wq18_onboarded')) { document.getElementById('onboardingOverlay').style.display = 'flex'; }
        else {
            document.getElementById('userGreeting').innerText = `‡∏°‡∏µ‡∏™‡∏ï‡∏¥‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡∏∏‡∏ì ${userName}!!!`;
            document.getElementById('userNameInput').value = userName; 
            document.getElementById('incomeDateInput').valueAsDate = new Date();
            updateProfilePicUI(); renderIncomeCats(); initQuests(); updateUI();
        }
    }
    
    function saveStorage() {
        localStorage.setItem('wq18_name', userName); localStorage.setItem('wq18_age', userAge); localStorage.setItem('wq18_pts', userPoints); 
        localStorage.setItem('wq18_profileImg', profileImgBase64 || '');
        localStorage.setItem('wq18_inv', JSON.stringify(inventory)); localStorage.setItem('wq18_cfg', JSON.stringify(cfg)); 
        localStorage.setItem('wq18_base', JSON.stringify(baseAmounts)); localStorage.setItem('wq18_curr', JSON.stringify(currentBalances));
        localStorage.setItem('wq18_tx', JSON.stringify(transactions)); localStorage.setItem('wq18_cat', JSON.stringify(customCats));
        localStorage.setItem('wq18_fc', JSON.stringify(fixedCosts)); localStorage.setItem('wq18_yf', JSON.stringify(yearlyFunds));
        localStorage.setItem('wq18_wl', JSON.stringify(wishlist)); localStorage.setItem('wq18_q', JSON.stringify(activeQuests)); 
        localStorage.setItem('wq18_debt', totalLiability); localStorage.setItem('wq18_inc', totalIncomeThisMonth); 
        localStorage.setItem('wq18_joyG', JSON.stringify(joyGoal)); localStorage.setItem('wq18_secG', JSON.stringify(secGoal)); 
        localStorage.setItem('wq18_stats', JSON.stringify(stats)); localStorage.setItem('wq18_incCat', JSON.stringify(incomeCats));
        localStorage.setItem('wq18_streak', streakCount); localStorage.setItem('wq18_lastLogin', lastActiveDate);
        localStorage.setItem('wq18_onboarded', 'true');
    }

    // --- Backup & Restore ---
    function exportData() { let d={...localStorage}; let b=new Blob([JSON.stringify(d)], {type:"application/json"}); let u=URL.createObjectURL(b); let a=document.createElement('a'); a.href=u; a.download=`MeeSati_Backup_${new Date().toLocaleDateString('th-TH')}.json`; a.click(); }
    function importData(e) { let f=e.target.files[0]; if(!f) return; let r=new FileReader(); r.onload=function(ev){ try{let d=JSON.parse(ev.target.result); for(let k in d){localStorage.setItem(k,d[k]);} alert('‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä'); location.reload(); }catch(err){alert('‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö!');} }; r.readAsText(f); }

    // --- 3. UI Navigation & Actions ---
    function switchTab(tabId, navElement) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active'); navElement.classList.add('active');
        if(tabId === 'view-home') { renderCategories(); renderQuests(); renderWishlist(); }
        if(tabId === 'view-fixed') { renderFixedCosts(); renderYearlyFunds(); renderCreditBills(); }
    }
    
    function switchAnalyticTab(tabId) {
        document.querySelectorAll('#view-analytics .tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('#view-analytics .tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active'); document.getElementById(`btn-${tabId}`).classList.add('active');
    }

    function switchSubTab(viewPrefix, tabId) {
        document.querySelectorAll(`#view-${viewPrefix} .tab-content`).forEach(el => el.classList.remove('active'));
        document.querySelectorAll(`#view-${viewPrefix} .tab-btn`).forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active'); document.getElementById(`btn-${tabId}`).classList.add('active');
    }

    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function showToast(msg) { let t = document.getElementById('toastMsg'); t.innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
    function clearData() { if(confirm('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏î‡∏¥‡∏ö‡∏≠‡∏™? (‡∏´‡∏≤‡∏¢‡πÄ‡∏Å‡∏•‡∏µ‡πâ‡∏¢‡∏á‡πÄ‡∏•‡∏¢‡∏ô‡∏∞!)')) { localStorage.clear(); location.reload(); } }

    function updateUI() {
        document.getElementById('sub-growth').innerText = `‡∏•‡∏á‡∏ó‡∏∏‡∏ô (${cfg.g}%)`; document.getElementById('sub-security').innerText = `‡∏™‡∏≥‡∏£‡∏≠‡∏á (${cfg.s}%)`;
        document.getElementById('sub-essential').innerText = `‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (${cfg.e}%)`; document.getElementById('sub-joy').innerText = `‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• (${cfg.j}%)`;
        document.getElementById('userPointsDisplay').innerText = `ü™ô ${userPoints.toLocaleString()} ‡πÅ‡∏ï‡πâ‡∏°`; document.getElementById('shopPointsDisplay').innerText = `${userPoints.toLocaleString()}`;
        document.getElementById('streakDisplay').innerText = `${streakCount} ‡∏ß‡∏±‡∏ô`;

        ['growth', 'security', 'essential', 'joy'].forEach(tank => {
            document.getElementById(`val-${tank}`).innerText = '‡∏ø' + currentBalances[tank].toLocaleString();
            let pct = baseAmounts[tank] > 0 ? (currentBalances[tank] / baseAmounts[tank]) * 100 : 0;
            let bar = document.getElementById(`bar-${tank}`); bar.style.height = `${Math.min(100, Math.max(0, pct))}%`; bar.innerText = pct > 5 ? Math.round(pct) + '%' : ''; 
        });
        renderCategories(); renderFixedCosts(); renderYearlyFunds(); renderQuests(); renderWishlist(); renderInventory(); renderDebtLog(); renderCreditBills(); renderReceivables();
        
        let liabilityDisplay = document.getElementById('totalLiabilityDisplay'); if(liabilityDisplay) liabilityDisplay.innerText = '‡∏ø' + totalLiability.toLocaleString();
        saveStorage();
    }

    // --- Onboarding & Settings Logic ---
    function finishOnboarding() {
        userName = document.getElementById('obName').value || 'User'; cfg.payday = parseInt(document.getElementById('obPayday').value) || 25; 
        let total = parseFloat(document.getElementById('obTotalMoney').value) || 0; let preset = document.getElementById('obPreset').value;
        if(preset==='invest') { cfg.g=40; cfg.s=35; cfg.e=15; cfg.j=10; } else if(preset==='debt') { cfg.g=10; cfg.s=60; cfg.e=20; cfg.j=10; } else { cfg.g=25; cfg.s=50; cfg.e=15; cfg.j=10; }
        
        currentBalances.growth = total*(cfg.g/100); currentBalances.security = total*(cfg.s/100); currentBalances.essential = total*(cfg.e/100); currentBalances.joy = total*(cfg.j/100);
        baseAmounts = {...currentBalances};
        document.getElementById('onboardingOverlay').style.display = 'none';
        document.getElementById('userGreeting').innerText = `‡∏°‡∏µ‡∏™‡∏ï‡∏¥‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡∏∏‡∏ì ${userName}!!!`;
        saveStorage(); updateUI();
    }
    
    function openConfigModal() {
        document.getElementById('userNameInput').value = userName; document.getElementById('cfgPayday').value = cfg.payday || 25;
        document.getElementById('cfgG').value = cfg.g; document.getElementById('cfgS').value = cfg.s; document.getElementById('cfgE').value = cfg.e; document.getElementById('cfgJ').value = cfg.j;
        document.getElementById('initG').value = currentBalances.growth; document.getElementById('initS').value = currentBalances.security; document.getElementById('initE').value = currentBalances.essential; document.getElementById('initJ').value = currentBalances.joy;
        openModal('configModal');
    }
    
    function saveConfig() {
        try {
            userName = document.getElementById('userNameInput').value || userName; cfg.payday = parseInt(document.getElementById('cfgPayday').value) || 25;
            let g = parseInt(document.getElementById('cfgG').value)||0; let s = parseInt(document.getElementById('cfgS').value)||0; let e = parseInt(document.getElementById('cfgE').value)||0; let j = parseInt(document.getElementById('cfgJ').value)||0;
            if(g+s+e+j !== 100) return alert('‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏ß‡∏°‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ 100% ‡∏Ñ‡∏£‡∏±‡∏ö');
            cfg = {g, s, e, j, payday: cfg.payday}; 
            let totalBase = baseAmounts.growth + baseAmounts.security + baseAmounts.essential + baseAmounts.joy;
            if (totalBase > 0) {
                let spentG = baseAmounts.growth - currentBalances.growth; let spentS = baseAmounts.security - currentBalances.security; let spentE = baseAmounts.essential - currentBalances.essential; let spentJ = baseAmounts.joy - currentBalances.joy;
                baseAmounts.growth = totalBase * (cfg.g/100); baseAmounts.security = totalBase * (cfg.s/100); baseAmounts.essential = totalBase * (cfg.e/100); baseAmounts.joy = totalBase * (cfg.j/100);
                currentBalances.growth = baseAmounts.growth - spentG; currentBalances.security = baseAmounts.security - spentS; currentBalances.essential = baseAmounts.essential - spentE; currentBalances.joy = baseAmounts.joy - spentJ;
            }
            document.getElementById('userGreeting').innerText = `‡∏°‡∏µ‡∏™‡∏ï‡∏¥‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡∏∏‡∏ì ${userName}!!!`;
            currentBalances.growth = parseFloat(document.getElementById('initG').value)||0; currentBalances.security = parseFloat(document.getElementById('initS').value)||0; currentBalances.essential = parseFloat(document.getElementById('initE').value)||0; currentBalances.joy = parseFloat(document.getElementById('initJ').value)||0;
            baseAmounts = {...currentBalances};
            updateProfilePicUI(); updateUI(); closeModal('configModal'); showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
        } catch (error) { console.error(error); closeModal('configModal'); }
    }

    function applyPreset(g,s,e,j) { document.getElementById('cfgG').value=g; document.getElementById('cfgS').value=s; document.getElementById('cfgE').value=e; document.getElementById('cfgJ').value=j; }

    function updateProfilePicUI() {
        let picDiv = document.getElementById('profilePicDisplay');
        if (profileImgBase64) { picDiv.style.backgroundImage = `url(${profileImgBase64})`; picDiv.innerText = ''; } else { picDiv.style.backgroundImage = 'none'; picDiv.innerText = userName ? userName.charAt(0).toUpperCase() : 'D'; }
    }
    function uploadProfilePic(event) { let file = event.target.files[0]; if (!file) return; let reader = new FileReader(); reader.onload = function(e) { profileImgBase64 = e.target.result; saveStorage(); updateProfilePicUI(); showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); }; reader.readAsDataURL(file); }

    // --- 4. Main Financial Actions ---
    function confirmIncome() {
        let inc = parseFloat(document.getElementById('mainIncomeInput').value); if(!inc || inc <= 0) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö!');
        let cat = document.getElementById('incomeCatSelect').value; if(cat === 'add_new') return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö');
        let dateVal = document.getElementById('incomeDateInput').value; let dateObj = dateVal ? new Date(dateVal).toISOString() : new Date().toISOString();
        let target = document.getElementById('incomeTargetTank').value;
        if (target === 'auto') {
            transactions.push({ id: Date.now(), type: 'main_income', splitType: 'auto', amount: inc, cat: cat, dateObj: dateObj });
            totalIncomeThisMonth += inc; baseAmounts.growth += inc*(cfg.g/100); currentBalances.growth += inc*(cfg.g/100); baseAmounts.security += inc*(cfg.s/100); currentBalances.security += inc*(cfg.s/100); baseAmounts.essential += inc*(cfg.e/100); currentBalances.essential += inc*(cfg.e/100); baseAmounts.joy += inc*(cfg.j/100); currentBalances.joy += inc*(cfg.j/100);
            showToast('üéâ ‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        } else {
            transactions.push({ id: Date.now(), type: 'main_income', splitType: target, tank: target, amount: inc, cat: cat, note: '‡∏£‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', dateObj: dateObj });
            totalIncomeThisMonth += inc; baseAmounts[target] += inc; currentBalances[target] += inc; showToast(`üéâ ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ ${target} ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
        }
        document.getElementById('mainIncomeInput').value = ''; updateUI(); showGifOverlay('income'); stats.monthlyGrowthTouched = false; saveStorage();
    }

    function renderIncomeCats() { let sel = document.getElementById('incomeCatSelect'); if(!sel) return; sel.innerHTML = ''; incomeCats.forEach(c => { sel.innerHTML += `<option value="${c.name}">${c.icon} ${c.name}</option>`; }); sel.innerHTML += `<option value="add_new">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏ß‡∏î‡πÉ‡∏´‡∏°‡πà</option>`; }
    function saveIncomeCategory() { let n = document.getElementById('newIncCatName').value; let i = document.getElementById('newIncCatIcon').value || 'üí∞'; if(n) { incomeCats.push({id: Date.now(), name: n, icon: i}); saveStorage(); renderIncomeCats(); document.getElementById('incomeCatSelect').value = n; closeModal('addIncomeCatModal'); } }

    function toggleEditCat() { isEditCatMode = !isEditCatMode; document.getElementById('editCatBtn').innerText = isEditCatMode ? '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' : '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'; document.getElementById('editCatBtn').style.color = isEditCatMode ? 'var(--danger)' : 'var(--espresso)'; renderCategories(); }
    function renderCategories() {
        let grid = document.getElementById('homeCategories'); grid.innerHTML = '';
        customCats.forEach(c => {
            let delBtn = isEditCatMode ? `<div onclick="event.stopPropagation(); deleteCategory(${c.id})" style="position:absolute; top:-5px; right:-5px; background:var(--danger); color:white; border-radius:50%; width:15px; height:15px; font-size:10px; display:flex; align-items:center; justify-content:center;">‚úï</div>` : '';
            grid.innerHTML += `<div class="cat-btn" onclick="openExpenseModal('${c.name}', '${c.tank}')">${delBtn}<div class="cat-icon">${c.icon}</div><div class="cat-name">${c.name}</div></div>`;
        });
        grid.innerHTML += `<div class="cat-btn" onclick="openModal('addCatModal')"><div class="cat-icon" style="color:#888;">+</div><div class="cat-name">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</div></div>`;
    }
    function saveNewCategory() { let n=document.getElementById('newCatName').value; let i=document.getElementById('newCatIcon').value||'üìå'; let t=document.getElementById('newCatTank').value; if(n){customCats.push({id:Date.now(),name:n,icon:i,tank:t}); updateUI(); closeModal('addCatModal');} }
    function deleteCategory(id) { customCats = customCats.filter(c => c.id !== id); updateUI(); }

    function openExpenseModal(cat, tank, presetAmount = null) {
        if(isEditCatMode) return;
        activeExpenseCat = cat; document.getElementById('expenseTitle').innerText = `‡∏à‡πà‡∏≤‡∏¢: ${cat}`;
        document.getElementById('exTank').value = tank; document.getElementById('exAmount').value = presetAmount || ''; document.getElementById('exNote').value = ''; document.getElementById('exPayMethod').value = '‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢/‡πÇ‡∏≠‡∏ô';
        if(document.getElementById('isReimbursable')) { document.getElementById('isReimbursable').checked = false; document.getElementById('reimbursableDiv').style.display = 'none'; document.getElementById('exReimbursableAmt').value = ''; document.getElementById('exLendTo').value = ''; }
        toggleInstallmentInput(); checkExpenseLogic(); openModal('expenseModal');
    }
    
    function toggleInstallmentInput() { let payMethod = document.getElementById('exPayMethod').value; if(payMethod === '‡∏ú‡πà‡∏≠‡∏ô (BNPL)' || payMethod === '‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï') { document.getElementById('installmentDiv').style.display = 'block'; } else { document.getElementById('installmentDiv').style.display = 'none'; } }

    function checkExpenseLogic() {
        let amt = parseFloat(document.getElementById('exAmount').value) || 0; let pt = document.getElementById('exTank').value;
        document.getElementById('joyTypeDiv').style.display = (pt === 'joy') ? 'block' : 'none'; document.getElementById('needDiv').style.display = (pt === 'essential') ? 'block' : 'none';
        if(amt > currentBalances[pt]) { 
            document.getElementById('crossTankBox').style.display = 'block'; document.getElementById('shortfallText').innerText = `‡∏ø${(amt-currentBalances[pt]).toLocaleString()}`;
            let sel = document.getElementById('backupTank'); sel.innerHTML = '';
            ['growth', 'security', 'essential', 'joy'].forEach(k => { if(k!==pt && currentBalances[k] >= (amt-currentBalances[pt])) sel.innerHTML += `<option value="${k}">‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å ${k} (‡∏°‡∏µ ‡∏ø${currentBalances[k]})</option>`; });
        } else document.getElementById('crossTankBox').style.display = 'none';
    }
    
    function submitExpense() {
        let amt = parseFloat(document.getElementById('exAmount').value); let pt = document.getElementById('exTank').value; let note = document.getElementById('exNote').value; if(!amt) return;
        let payMethod = document.getElementById('exPayMethod').value; let emotion = pt === 'joy' ? document.getElementById('exEmotion').value : null; let needRating = pt === 'essential' ? parseInt(document.getElementById('exNeedRating').value) : null; let joyType = pt === 'joy' ? document.getElementById('exJoyType').value : null;
        let isReimbursable = document.getElementById('isReimbursable') && document.getElementById('isReimbursable').checked; let reimbursableAmt = isReimbursable ? parseFloat(document.getElementById('exReimbursableAmt').value) || 0 : 0; let lendTo = isReimbursable ? document.getElementById('exLendTo').value || '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô' : '';
        if (isReimbursable && reimbursableAmt >= amt) return alert('‡∏ö‡∏≠‡∏™! ‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏Ñ‡∏£‡∏±‡∏ö!');
        
        // 7-Day Rule Feature
        if(pt === 'joy' && amt >= 2000) {
            if(confirm(`‚ö†Ô∏è ‡∏¢‡∏≠‡∏î ‡∏ø${amt} ‡∏™‡∏π‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏∞!\n‡∏ó‡∏§‡∏©‡∏é‡∏µ 7-Day Rule: ‡∏û‡∏±‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ô "‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô‡∏î‡∏≠‡∏á‡∏Å‡∏¥‡πÄ‡∏•‡∏™" 7 ‡∏ß‡∏±‡∏ô ‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏°?\n\n(‡∏Å‡∏î OK ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≠‡∏á / ‡∏Å‡∏î Cancel ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏≠‡∏°‡πÅ‡∏û‡πâ‡πÑ‡∏°‡πà‡∏ã‡∏∑‡πâ‡∏≠)`)) { 
                wishlist.push({id: Date.now(), cat: activeExpenseCat, tank: pt, amount: amt, note, unlockAt: new Date().getTime() + (7*24*60*60*1000), payMethod, emotion, needRating}); 
                updateUI(); closeModal('expenseModal'); showToast('‚è≥ ‡∏î‡∏≠‡∏á‡∏Å‡∏¥‡πÄ‡∏•‡∏™ 7 ‡∏ß‡∏±‡∏ô ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); return; 
            }
        }
        
        executePayment(amt, pt, note, activeExpenseCat, payMethod, emotion, needRating, reimbursableAmt, lendTo);
        if(activeFixedId) { let f = fixedCosts.find(x => x.id === activeFixedId); if (f) { f.paidThisMonth = true; if (f.isInst) { f.paidM = Math.min(f.totalM, f.paidM + 1); } } activeFixedId = null; }
        if(document.getElementById('isReimbursable')) { document.getElementById('isReimbursable').checked = false; document.getElementById('reimbursableDiv').style.display = 'none'; }
        closeModal('expenseModal');
    }
    
    function executePayment(amt, pt, note, cat, payMethod, emotion, needRating, reimbursableAmt = 0, lendTo = '') {
        let isCross = false; let crossReason = null; let bt = null; let pDeduct = amt; let bDeduct = 0;
        if(amt > currentBalances[pt]) {
            bt = document.getElementById('backupTank') ? document.getElementById('backupTank').value : null;
            if(!bt) return alert('‡∏•‡∏î‡∏™‡πÄ‡∏õ‡∏Ñ‡∏î‡πà‡∏ß‡∏ô‡∏ö‡∏≠‡∏™! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡∏û‡∏≠‡πÇ‡∏õ‡∏∞‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö');
            crossReason = document.getElementById('crossReason').value;
            pDeduct = currentBalances[pt]; bDeduct = amt - currentBalances[pt]; currentBalances[bt] -= bDeduct; currentBalances[pt] = 0;
            stats.crossTankCount++; showToast(`‚ö†Ô∏è ‡πÇ‡∏õ‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å ${bt} (‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${crossReason})`); isCross = true; showGifOverlay('crosstank');
        } else { currentBalances[pt] -= amt; showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏á‡∏ö!'); showGifOverlay('expense_saved'); }
        if (pt === 'growth') stats.monthlyGrowthTouched = true; let joyType = pt === 'joy' ? document.getElementById('exJoyType').value : null;
        let installments = null;
        if(payMethod === '‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï' || payMethod === '‡∏ú‡πà‡∏≠‡∏ô (BNPL)') { let months = payMethod === '‡∏ú‡πà‡∏≠‡∏ô (BNPL)' ? (parseInt(document.getElementById('exInstallmentMonths').value) || 1) : 1; let instAmt = amt / months; installments = []; for(let i=1; i<=months; i++) { installments.push({monthNo: i, amount: instAmt, paid: false}); } currentBalances.security += amt; }
        let actualExpense = amt - reimbursableAmt;
        transactions.push({ id: Date.now(), type:'expense', dateObj: new Date().toISOString(), tank: pt, amount: actualExpense, cat: cat, note, joyType, isCross, crossReason, backupTank: bt, pDeduct, bDeduct, payMethod, emotion, needRating, installments: installments, creditPaid: false });
        if (reimbursableAmt > 0) { transactions.push({ id: Date.now()+1, type: 'receivable', dateObj: new Date().toISOString(), tank: pt, amount: reimbursableAmt, note: lendTo, cat: '‡∏£‡∏≠‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô: ' + cat, paid: false }); }
        updateUI(); if(pt === 'joy' || (isCross && bt === 'joy')) updateGoalUI('joy'); if(pt === 'security' || (isCross && bt === 'security')) updateGoalUI('security');
    }

    // --- Transfer & Sweep ---
    function openTransferModal() { document.getElementById('tfAmt').value = ''; openModal('transferModal'); checkTransferFriction(); }
    function checkTransferFriction() {
        let from = document.getElementById('tfFrom').value; let to = document.getElementById('tfTo').value;
        let frictionBox = document.getElementById('transferFrictionBox'); let submitBtn = document.getElementById('btnTransferSubmit'); let confirmWord = document.getElementById('tfConfirmWord');
        if ((from === 'growth' || from === 'security') && (to === 'joy' || to === 'essential')) {
            frictionBox.style.display = 'block'; submitBtn.style.background = '#ccc'; submitBtn.disabled = true; confirmWord.value = '';
        } else { frictionBox.style.display = 'none'; submitBtn.style.background = 'var(--espresso)'; submitBtn.disabled = false; }
    }
    function checkFrictionWord() {
        let word = document.getElementById('tfConfirmWord').value; let submitBtn = document.getElementById('btnTransferSubmit');
        if (word.trim() === '‡∏â‡∏±‡∏ô‡∏ï‡∏ö‡∏∞‡πÅ‡∏ï‡∏Å') { submitBtn.style.background = 'var(--danger)'; submitBtn.disabled = false; } else { submitBtn.style.background = '#ccc'; submitBtn.disabled = true; }
    }
    function processTransfer() {
        let from = document.getElementById('tfFrom').value; let to = document.getElementById('tfTo').value; let amt = parseFloat(document.getElementById('tfAmt').value);
        if(from === to) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏™‡∏¥‡∏ö‡∏≠‡∏™!'); if(!amt || amt <= 0) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö');
        if(currentBalances[from] < amt) return alert(`‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô ${from} ‡πÑ‡∏°‡πà‡∏û‡∏≠‡πÇ‡∏≠‡∏ô‡∏ô‡∏∞‡∏ö‡∏≠‡∏™!`);
        currentBalances[from] -= amt; currentBalances[to] += amt;
        transactions.push({ id: Date.now(), type: 'transfer', tank: from, toTank: to, amount: amt, cat: '‚ÜîÔ∏è ‡πÇ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤', note: `‡∏à‡∏≤‡∏Å ${from} ‡πÑ‡∏õ ${to}`, dateObj: new Date().toISOString() });
        saveStorage(); updateUI(); closeModal('transferModal'); showToast(`‚ÜîÔ∏è ‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô ‡∏ø${amt} ‡πÑ‡∏õ ${to} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
    }

    function sweepChange() {
        let eChange = currentBalances.essential % 100; let jChange = currentBalances.joy % 100; let total = eChange + jChange;
        if(total <= 0) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏®‡∏©‡πÉ‡∏´‡πâ‡∏õ‡∏±‡∏î‡∏Ñ‡∏£‡∏±‡∏ö‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏õ‡πä‡∏∞!');
        currentBalances.essential -= eChange; currentBalances.joy -= jChange; currentBalances.growth += total;
        transactions.push({ id: Date.now(), type: 'income', tank: 'growth', amount: total, cat: '‡∏Å‡∏ß‡∏≤‡∏î‡πÄ‡∏®‡∏©‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç', dateObj: new Date().toISOString() });
        userPoints += 20; updateUI(); showToast(`üßπ ‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏© ‡∏ø${total} ‡πÑ‡∏õ‡∏•‡∏á‡∏ó‡∏∏‡∏ô! ‡∏£‡∏±‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™ 20 ‡πÅ‡∏ï‡πâ‡∏°`);
    }

    // --- Bulk Entry ---
    let bulkRowId = 0;
    function openBulkEntry() { document.getElementById('bulkEntryDate').valueAsDate = new Date(); document.getElementById('bulkRows').innerHTML = ''; addBulkRow(); addBulkRow(); openModal('bulkEntryModal'); }
    function addBulkRow() {
        bulkRowId++; let row = document.createElement('div'); row.className = 'bulk-row'; row.id = `bulk_${bulkRowId}`; row.style = "display:flex; gap:5px; margin-bottom:10px; align-items:center; background:var(--nuage-de-lait); padding:10px; border-radius:12px;";
        row.innerHTML = `
            <div style="flex:1;">
                <input type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£" style="width:100%; padding:8px; border-radius:8px; border:1px solid #cbd5e1; font-size:13px; margin-bottom:5px;" class="b-cat">
                <div style="display:flex; gap:5px;"><input type="number" placeholder="‡∏ø ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô" style="flex:1; padding:8px; border-radius:8px; border:1px solid #cbd5e1; font-size:13px;" class="b-amt"><select style="flex:1; padding:8px; border-radius:8px; border:1px solid #cbd5e1; font-size:13px;" class="b-tank"><option value="essential">Essential</option><option value="joy">Joy</option><option value="security">Security</option></select></div>
            </div><button onclick="document.getElementById('bulk_${bulkRowId}').remove()" style="background:var(--danger); color:white; border:none; border-radius:50%; width:28px; height:28px; font-weight:bold; cursor:pointer;">‚úï</button>
        `;
        document.getElementById('bulkRows').appendChild(row);
    }
    function submitBulkEntry() {
        let rows = document.querySelectorAll('.bulk-row'); let successCount = 0; let errCount = 0;
        let selectedDate = document.getElementById('bulkEntryDate').value; let finalDateObj = selectedDate ? new Date(selectedDate).toISOString() : new Date().toISOString();
        rows.forEach(r => {
            let cat = r.querySelector('.b-cat').value || '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏ö‡∏¢‡∏≠‡∏î'; let amt = parseFloat(r.querySelector('.b-amt').value); let tank = r.querySelector('.b-tank').value;
            if(amt > 0) {
                if(currentBalances[tank] >= amt) {
                    currentBalances[tank] -= amt; let em = tank==='joy' ? 'ü§© ‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á' : null; let nr = tank==='essential' ? 3 : null;
                    if(tank === 'growth') stats.monthlyGrowthTouched = true;
                    transactions.push({ id: Date.now()+Math.random(), type:'expense', dateObj: finalDateObj, tank: tank, amount: amt, cat: cat, note: 'Daily Dump', payMethod: '‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢/‡πÇ‡∏≠‡∏ô', emotion: em, needRating: nr, creditPaid: false });
                    successCount++;
                } else { errCount++; }
            }
        });
        updateUI();
        if(successCount > 0) { userPoints += 15; } closeModal('bulkEntryModal');
        if(successCount > 0 && errCount === 0) { showToast(`‚úÖ ‡∏£‡∏ß‡∏ö‡∏¢‡∏≠‡∏î ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£! ‡∏£‡∏±‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™ +15 ‡πÅ‡∏ï‡πâ‡∏°`); showGifOverlay('expense_saved'); }
        else if(successCount > 0 && errCount > 0) { showToast(`‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏Ç‡πâ‡∏≤‡∏° ${errCount} ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠)`); showGifOverlay('expense_saved'); }
        else if(errCount > 0) { showToast(`‚ùå ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏¢‡∏™‡∏±‡∏Å‡∏≠‡∏±‡∏ô!`); }
    }

    // --- 5. History & Editing ---
    function openTankHistory(tankId, tankName) {
        currentActiveGoalTank = tankId; document.getElementById('historyTitle').innerText = tankName; document.getElementById('historyDesc').innerHTML = tankDesc[tankId] || ""; document.getElementById('historyBalance').innerText = '‡∏ø' + currentBalances[tankId].toLocaleString();
        let gs = document.getElementById('goalSection'); let gps = document.getElementById('growthPortfolioSection'); gs.style.display = (tankId === 'joy' || tankId === 'security') ? 'block' : 'none'; gps.style.display = (tankId === 'growth') ? 'block' : 'none';
        if(tankId === 'joy' || tankId === 'security') updateGoalUI(tankId);
        if(tankId === 'growth') { let age = userAge > 0 ? userAge : 30; let highRisk = 110 - age; let lowRisk = 100 - highRisk; if(highRisk < 0) highRisk = 0; if(lowRisk < 0) lowRisk = 0; document.getElementById('portAgeDisplay').innerText = age; document.getElementById('portHighPct').innerText = highRisk + '%'; document.getElementById('portLowPct').innerText = lowRisk + '%'; document.getElementById('portBar').style.width = highRisk + '%'; }
        
        let filteredTx = transactions.filter(t => { if (t.tank === tankId && (t.type === 'expense' || t.type === 'income')) return true; if (t.type === 'main_income' && (t.splitType === 'auto' || t.splitType === tankId)) return true; if (t.type === 'transfer' && (t.tank === tankId || t.toTank === tankId)) return true; return false; });
        let list = document.getElementById('historyList'); list.innerHTML = ''; if(filteredTx.length === 0) list.innerHTML = '<li style="text-align:center; padding:20px; color:#888;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</li>';
        let totals = {};
        [...filteredTx].reverse().forEach(t => {
            let d = new Date(t.dateObj).toLocaleDateString('th-TH'); let n = t.note ? ` | ${t.note}` : ''; let isExp = false; let displayAmt = t.amount;
            if (t.type === 'expense') isExp = true; if (t.type === 'transfer' && t.tank === tankId) isExp = true; if (t.type === 'main_income' && t.splitType === 'auto') { displayAmt = t.amount * (cfg[tankId.charAt(0)] / 100); }
            let amtColor = isExp ? 'var(--danger)' : 'var(--success)'; let sign = isExp ? '-' : '+';
            list.innerHTML += `<li class="list-item" id="tx-row-${t.id}"><div class="list-info" id="tx-display-${t.id}"><h4 style="color:var(--espresso); margin:0;">${t.cat}</h4><p style="font-size:10px; color:var(--gray-text); margin:0;">${d}${n}</p></div><div style="display:flex; align-items:center; gap:5px;" id="tx-action-${t.id}"><span class="list-amount" style="color:${amtColor}; font-weight:bold;">${sign}‡∏ø${displayAmt.toLocaleString()}</span>${t.type === 'expense' || (t.type === 'main_income' && t.splitType !== 'auto') ? `<button onclick="openEditTx(${t.id})" style="border:none; background:transparent; color:var(--bleu-porcelaine); font-size:12px; font-weight:bold; cursor:pointer;">[‡πÅ‡∏Å‡πâ]</button>` : ''}<button onclick="undoTransaction(${t.id})" style="border:none; background:transparent; color:var(--gray-text); font-size:12px; cursor:pointer;">[‡∏•‡∏ö]</button></div></li>`;
            if(isExp && t.type === 'expense') totals[t.cat] = (totals[t.cat] || 0) + displayAmt;
        });
        let ctx = document.getElementById('tankChart').getContext('2d'); if(tankChartInstance) tankChartInstance.destroy();
        if(Object.keys(totals).length > 0) { tankChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(totals), datasets: [{ data: Object.values(totals), backgroundColor: ['#a13a1e','#a79058','#8babca','#f1c166', '#4b2613'] }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins:{ legend:{position:'right', labels:{color:'#4b2613', font:{family:'Kanit', size:10}}} } } }); }
        openModal('historyModal');
    }

    function openEditTx(id) { let t = transactions.find(x => x.id === id); if(!t) return; document.getElementById('editTxId').value = t.id; document.getElementById('editTxAmt').value = t.amount; document.getElementById('editTxCat').value = t.cat; document.getElementById('editTxNote').value = t.note || ''; if(t.dateObj) { let d = new Date(t.dateObj); document.getElementById('editTxDate').value = d.toISOString().split('T')[0]; } openModal('editTxModal'); }
    function saveEditTransaction() {
        let id = parseFloat(document.getElementById('editTxId').value); let t = transactions.find(x => x.id === id); if(!t) return;
        let newAmt = parseFloat(document.getElementById('editTxAmt').value) || 0; if (newAmt <= 0) return alert('‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0');
        if (t.type === 'expense') { currentBalances[t.tank] += t.amount; if (currentBalances[t.tank] < newAmt) { currentBalances[t.tank] -= t.amount; return alert('‡∏ö‡∏≠‡∏™! ‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏£‡∏±‡∏ö'); } currentBalances[t.tank] -= newAmt; } else if (t.type === 'income') { currentBalances[t.tank] = (currentBalances[t.tank] - t.amount) + newAmt; }
        t.dateObj = document.getElementById('editTxDate').value ? new Date(document.getElementById('editTxDate').value).toISOString() : t.dateObj; t.cat = document.getElementById('editTxCat').value; t.amount = newAmt; t.note = document.getElementById('editTxNote').value;
        saveStorage(); updateUI(); closeModal('editTxModal'); openTankHistory(t.tank, document.getElementById('historyTitle').innerText); showToast('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
    }
    function undoTransaction(id) {
        let t = transactions.find(x => x.id === id); if(!t) return; if(!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ "${t.cat}" ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°? ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô/‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ`)) return;
        try {
            if(t.type === 'expense') {
                let refundMain = (t.pDeduct !== undefined ? t.pDeduct : t.amount);
                if(t.installments) { let unpaidSum = t.installments.filter(i => !i.paid).reduce((s,i) => s + i.amount, 0); if (currentBalances.security < unpaidSum) { let shortfall = unpaidSum - currentBalances.security; currentBalances.security = 0; refundMain -= shortfall; } else { currentBalances.security -= unpaidSum; } }
                currentBalances[t.tank] += Math.max(0, refundMain);
                if(t.isCross && t.backupTank && t.bDeduct) { currentBalances[t.backupTank] += t.bDeduct; stats.crossTankCount = Math.max(0, stats.crossTankCount - 1); }
            } else if (t.type === 'income') { currentBalances[t.tank] -= t.amount; }
            else if (t.type === 'main_income') { if (t.splitType === 'auto' || !t.splitType) { currentBalances.growth -= t.amount*(cfg.g/100); currentBalances.security -= t.amount*(cfg.s/100); currentBalances.essential -= t.amount*(cfg.e/100); currentBalances.joy -= t.amount*(cfg.j/100); } else { currentBalances[t.splitType] -= t.amount; } totalIncomeThisMonth -= t.amount; }
            else if (t.type === 'transfer') { currentBalances[t.tank] += t.amount; currentBalances[t.toTank] -= t.amount; }
            else if (t.type === 'debt_in') { currentBalances.essential -= t.amount; totalLiability -= t.amount; } 
            else if (t.type === 'legacy_debt_in') { totalLiability -= t.amount; } 
            else if (t.type === 'debt_out') { currentBalances.security += t.amount; totalLiability += t.amount; }
            transactions = transactions.filter(x => x.id !== id); updateUI(); closeModal('historyModal'); renderDebtLog(); showToast('üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        } catch (err) { console.error("Undo Error:", err); alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö"); }
    }

    // --- 6. Goals & Rewards ---
    function updateGoalUI(tank) {
        if(tank !== 'joy' && tank !== 'security') return; let goalObj = tank === 'joy' ? joyGoal : secGoal; let bal = currentBalances[tank]; let color = tank === 'joy' ? 'var(--eau-trouble)' : 'var(--miel-dore)'; let warnText = tank === 'joy' ? '‚ö†Ô∏è ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏ö‡∏≠‡∏™! ‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠ Small Win ‡∏à‡∏∏‡∏Å‡∏à‡∏¥‡∏Å ‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏´‡∏•‡∏≠‡∏î‡∏ô‡∏µ‡πâ‡∏•‡∏î‡∏•‡∏á‡∏ô‡∏∞' : '‚ö†Ô∏è ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏ö‡∏≠‡∏™! ‡∏´‡∏≤‡∏Å‡∏î‡∏∂‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏õ‡πÉ‡∏ä‡πâ ‡∏´‡∏•‡∏≠‡∏î‡∏à‡∏∞‡∏•‡∏î‡∏•‡∏á';
        document.getElementById('goalHeaderTxt').innerText = tank === 'joy' ? 'üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ Big Win' : 'üõ°Ô∏è ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô'; document.getElementById('goalNameTxt').innerText = goalObj.name; document.getElementById('goalTargetTxt').innerText = '‡∏ø' + goalObj.target.toLocaleString(); document.getElementById('goalCurrTxt').innerText = '‡∏ø' + bal.toLocaleString(); document.getElementById('goalWarnTxt').innerText = warnText;
        let pct = goalObj.target > 0 ? (bal / goalObj.target) * 100 : 0; let bar = document.getElementById('goalBar'); bar.style.width = `${Math.min(100, Math.max(0, pct))}%`; bar.innerText = pct > 5 ? Math.round(pct) + '%' : ''; bar.style.background = pct >= 100 ? 'var(--success)' : `linear-gradient(90deg, var(--miel-dore), ${color})`;
        if(pct >= 100) { document.getElementById('goalActionBtn').style.display = 'block'; if(tank === 'joy' && !stats.achievedJoy) { stats.achievedJoy = true; saveStorage(); showGifOverlay('goal'); } if(tank === 'security' && !stats.achievedSec) { stats.achievedSec = true; saveStorage(); showGifOverlay('goal'); } } else { document.getElementById('goalActionBtn').style.display = 'none'; if(tank === 'joy') stats.achievedJoy = false; if(tank === 'security') stats.achievedSec = false; }
    }
    function editGoal() { document.getElementById('goalDisplay').style.display = 'none'; document.getElementById('goalEdit').style.display = 'block'; document.getElementById('goalActionBtn').style.display = 'none'; if(currentActiveGoalTank === 'joy') { document.getElementById('goalNameInput').value = joyGoal.name; document.getElementById('goalTargetInput').value = joyGoal.target; } else { document.getElementById('goalNameInput').value = secGoal.name; document.getElementById('goalTargetInput').value = secGoal.target; } }
    function saveGoal() { let name = document.getElementById('goalNameInput').value; let target = parseFloat(document.getElementById('goalTargetInput').value); if(name && target) { if(currentActiveGoalTank === 'joy') joyGoal = {name, target}; else secGoal = {name, target}; saveStorage(); } document.getElementById('goalEdit').style.display = 'none'; document.getElementById('goalDisplay').style.display = 'block'; updateGoalUI(currentActiveGoalTank); }
    function claimGoal() { let t = currentActiveGoalTank; let g = t === 'joy' ? joyGoal : secGoal; if(confirm(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢‡∏ö‡∏≠‡∏™! ‡∏à‡∏∞‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô ‡∏ø${g.target.toLocaleString()} ‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "${g.name}" ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?`)) { currentBalances[t] -= g.target; userPoints += 500; transactions.push({ id: Date.now(), type:'expense', dateObj: new Date().toISOString(), tank: t, amount: g.target, cat: '‡∏û‡∏¥‡∏ä‡∏¥‡∏ï‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢!', note: g.name, creditPaid: false }); showToast('‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏£‡∏±‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™ 500 ‡πÅ‡∏ï‡πâ‡∏° üéâ'); updateUI(); openTankHistory(t, t === 'joy' ? 'Joy (‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï)' : 'Security (‡∏™‡∏≥‡∏£‡∏≠‡∏á)'); } }

    function buyReward(itemName, cost) { if(userPoints < cost) return alert(`‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Ç‡∏≤‡∏î‡∏≠‡∏µ‡∏Å ${cost - userPoints} ‡πÅ‡∏ï‡πâ‡∏°`); if(confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ä‡πâ ${cost} ‡πÅ‡∏ï‡πâ‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏Å "${itemName}" ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?`)) { userPoints -= cost; inventory.push({id: Date.now(), name: itemName}); updateUI(); showToast(`üéâ ‡πÅ‡∏•‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß`); } }
    function renderInventory() { let inv = document.getElementById('inventoryList'); inv.innerHTML = ''; if(!inventory || inventory.length === 0) { inv.innerHTML = '<p style="text-align:center; font-size:12px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</p>'; return; } inventory.forEach(i => { inv.innerHTML += `<div style="background:var(--nuage-de-lait); border:1px solid var(--eau-trouble); padding:10px; border-radius:8px; margin-bottom:5px; display:flex; justify-content:space-between; align-items:center;"><span style="color:var(--espresso); font-weight:bold; font-size:11px;">üéüÔ∏è ${i.name}</span><button class="btn-main" style="width:auto; padding:4px 12px; margin:0; background:var(--eau-trouble); font-size:11px;" onclick="useReward(${i.id}, '${i.name}')">‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</button></div>`; }); }
    function useReward(id, name) { 
        if(confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á "${name}" ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°? (‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ô‡∏∞)`)) { 
            if(name === 'üéüÔ∏è ‡πÇ‡∏≠‡∏ô Essential ‡πÄ‡∏Ç‡πâ‡∏≤ Joy 500‡∏ø') {
                if(currentBalances.essential < 500) return alert('‡∏ö‡∏≠‡∏™! ‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô Essential ‡πÑ‡∏°‡πà‡∏û‡∏≠ 500‡∏ø ‡πÉ‡∏´‡πâ‡πÇ‡∏¢‡∏Å‡∏ô‡∏∞'); currentBalances.essential -= 500; currentBalances.joy += 500;
                transactions.push({ id: Date.now(), type: 'income', tank: 'joy', amount: 500, cat: 'üéüÔ∏è ‡πÇ‡∏¢‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÅ‡∏ï‡πâ‡∏°', note: '‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å Essential', dateObj: new Date().toISOString() });
                transactions.push({ id: Date.now()+1, type: 'expense', tank: 'essential', amount: 500, cat: 'üéüÔ∏è ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏ï‡πâ‡∏°‡πÇ‡∏¢‡∏Å‡πÄ‡∏á‡∏¥‡∏ô', note: '‡πÇ‡∏≠‡∏ô‡πÑ‡∏õ Joy', payMethod: '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î', dateObj: new Date().toISOString(), creditPaid: false });
            }
            else if(name === 'üßº ‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏≤‡∏õ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥') { if(stats.crossTankCount <= 0) return alert('‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ö‡∏≠‡∏™‡∏Ç‡∏≤‡∏ß‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö! ‡πÄ‡∏Å‡πá‡∏ö‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏ñ‡∏≠‡∏∞‡∏ô‡∏∞'); stats.crossTankCount -= 1; alert('‚ú® ‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏≤‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! AI ‡∏•‡∏∑‡∏°‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡πà‡∏≤‡∏ö‡∏≠‡∏™‡πÄ‡∏Ñ‡∏¢‡∏î‡∏∂‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏°‡∏ñ‡∏±‡∏á 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏™‡∏ö‡∏≤‡∏¢‡πÉ‡∏à‡πÑ‡∏î‡πâ!'); }
            else if(name === 'ü§ù ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏¢‡πå‡∏°‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ' || name === 'üöó ‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô‡∏ü‡∏£‡∏µ 1 ‡∏ß‡∏±‡∏ô (‡∏°‡∏µ‡∏Ñ‡∏ô‡πÄ‡∏õ‡∏¢‡πå)' || name === 'üç≤ ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≤‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß (‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏ñ‡∏µ‡∏¢‡∏á)' || name === 'üõãÔ∏è ‡∏•‡∏∞‡πÄ‡∏ß‡πâ‡∏ô‡∏á‡∏≤‡∏ô‡∏ö‡πâ‡∏≤‡∏ô 1 ‡∏ß‡∏±‡∏ô') { alert(`üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢‡∏ö‡∏≠‡∏™!! ‡∏£‡∏µ‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡∏¢‡∏∑‡πà‡∏ô‡πÉ‡∏™‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏ß‡∏á‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á:\n\nüëâ "${name}"\n\n(‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏î‡∏•‡∏á‡πÅ‡∏≠‡∏õ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏µ‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö‡∏à‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß ü§£)`); }
            else if(name === 'üç∞ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡πÑ‡∏£‡πâ‡∏™‡∏≤‡∏£‡∏∞ 1 ‡∏ä‡∏¥‡πâ‡∏ô') {
                let cost = prompt(`‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå VIP! ‡∏ö‡∏≠‡∏™‡∏ã‡∏∑‡πâ‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏Å‡∏µ‡πà‡∏ö‡∏≤‡∏ó? (‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏ö‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏¢‡∏≠‡∏î‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ AI ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö)`); let amt = parseFloat(cost); if(isNaN(amt) || amt <= 0) return alert('‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏ô‡∏∞‡∏ö‡∏≠‡∏™!'); if(currentBalances.essential < amt) return alert('‡∏ö‡∏≠‡∏™! ‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô Essential ‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏´‡∏±‡∏Å‡∏ô‡∏∞!'); currentBalances.essential -= amt;
                transactions.push({ id: Date.now(), type:'expense', dateObj: new Date().toISOString(), tank: 'essential', amount: amt, cat: `üéÅ VIP: ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÅ‡∏ï‡πâ‡∏°‡πÅ‡∏•‡∏Å‡∏°‡∏≤`, note: name, payMethod: '‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢/‡πÇ‡∏≠‡∏ô', emotion: 'ü§© ‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á', needRating: 5, creditPaid: false, isCross: false }); alert(`‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô ‡∏ø${amt} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏¢‡∏≠‡∏î‡∏ï‡∏£‡∏á‡πÄ‡∏õ‡πä‡∏∞ ‡∏ö‡∏≠‡∏™‡∏Å‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏£‡πà‡∏≠‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ú‡∏¥‡∏î!`);
            }
            inventory = inventory.filter(x => x.id !== id); saveStorage(); updateUI(); showToast(`‚úÖ ‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå "${name}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!`); 
        } 
    }

    // --- 7. Quests & Wishlist ---
    function renderWishlist() { let c = document.getElementById('wishlistContainer'); c.innerHTML = ''; if(wishlist.length===0) c.innerHTML = '<p style="text-align:center; color:#888; font-size:12px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏î‡∏≠‡∏á ‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å‡∏ö‡∏≠‡∏™!</p>'; let now = new Date().getTime(); wishlist.forEach(w => { let remain = Math.max(0, Math.ceil((w.unlockAt - now)/(1000*60*60*24))); let btn = remain <= 0 ? `<button class="btn-main" style="padding:5px; background:var(--success); font-size:11px;" onclick="buyWishlist(${w.id})">‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏•‡∏¢!</button>` : `<button class="btn-main" style="padding:5px; background:#ddd; color:#888; font-size:11px;" disabled>‡∏£‡∏≠ ${remain} ‡∏ß‡∏±‡∏ô</button>`; c.innerHTML += `<div class="list-item" style="border-left: 4px solid var(--eau-trouble); padding: 10px; border-radius: 8px; margin-top: 10px; background:var(--nuage-de-lait); border-top:1px solid #cbd5e1; border-right:1px solid #cbd5e1; border-bottom:1px solid #cbd5e1;"><h4 style="color:var(--espresso); margin:0;">${w.cat} (‡∏ø${w.amount})</h4><div style="display:flex; gap:10px; margin-top:5px;"><button class="btn-outline" style="padding:5px; color:var(--danger); border-color:var(--danger);" onclick="deleteWishlist(${w.id}, ${w.amount})">‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á (+50 ‡πÅ‡∏ï‡πâ‡∏°)</button>${btn}</div></div>`; }); }
    function buyWishlist(id) { let w = wishlist.find(x=>x.id===id); if(!w) return; wishlist = wishlist.filter(x=>x.id!==id); stats.temptationYieldedCount++; executePayment(w.amount, w.tank, w.note, w.cat, w.payMethod, w.emotion, w.needRating); renderWishlist(); closeModal('wishlistModal'); }
    function deleteWishlist(id, amt) { wishlist = wishlist.filter(x=>x.id!==id); stats.savedFromTemptation += amt; stats.temptationAbandonedCount++; userPoints += 50; updateUI(); showToast('üéâ ‡∏ä‡∏ô‡∏∞‡∏Å‡∏¥‡πÄ‡∏•‡∏™‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß! ‡∏£‡∏±‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™ 50 ‡πÅ‡∏ï‡πâ‡∏°'); saveStorage(); showGifOverlay('wishlist_delete'); }

    function initQuests() { if(!activeQuests || activeQuests.length === 0) { activeQuests = []; activeQuests.push(questPool[0], questPool[1]); } }
    function renderQuests() {
        let ql = document.getElementById('questList'); ql.innerHTML = '';
        activeQuests.forEach((q, idx) => { let chk = q.done ? 'checked' : ''; let classes = q.done ? 'quest-item completed' : 'quest-item'; ql.innerHTML += `<div class="${classes}"><div style="display:flex; gap:10px; align-items:center;"><input type="checkbox" ${chk} onchange="toggleQuest(${idx}, this.checked)"> <div><strong style="color:var(--espresso);">${q.title}</strong><br><span style="color:var(--gray-text); font-size:10px;">üéÅ +${q.pts} ‡πÅ‡∏ï‡πâ‡∏°</span></div></div> <button class="btn-outline" style="padding:2px 5px; font-size:10px; border-color:var(--gray-text); color:var(--gray-text);" onclick="skipQuest(${idx})">üîÑ</button></div>`; });
    }
    function toggleQuest(index, isDone) { if(!isDone) return; let q = activeQuests[index]; q.done = true; userPoints += q.pts; showToast(`üéâ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå! ‡∏£‡∏±‡∏ö +${q.pts} ‡πÅ‡∏ï‡πâ‡∏°`); renderQuests(); setTimeout(() => { skipQuest(index); }, 800); }
    function skipQuest(index) { let excludeIds = activeQuests.map(x=>x.id); let available = questPool.filter(q => !excludeIds.includes(q.id)); if(available.length === 0) activeQuests[index] = {...questPool[0], done: false, id: Date.now() + Math.random()}; else { let r = Math.floor(Math.random() * available.length); activeQuests[index] = {...available[r], done: false, id: Date.now() + Math.random()}; } updateUI(); }
    function addCustomQuest() { let n = document.getElementById('cqName').value; let diff = parseInt(document.getElementById('cqDiff').value) || 30; if(n) { let newQ = {id: Date.now(), title: n, pts: diff, done: false}; questPool.push(newQ); activeQuests[0] = newQ; updateUI(); closeModal('customQuestModal'); showToast('‡∏•‡∏∏‡∏¢‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!'); } }

    // --- 8. Fixed Costs, Credit Bills & Yearly ---
    function renderFixedCosts() {
        let list = document.getElementById('fixedCostList'); list.innerHTML = ''; let totalFixed = 0;
        fixedCosts.forEach(f => {
            totalFixed += f.amount; let titleText = f.name; let subText = `<span class="tank-badge bg-${f.tank}" style="margin-left:0;">${f.tank}</span>`; let progressHTML = ''; let btn = f.paidThisMonth ? `<span style="color:var(--success); font-size:11px; font-weight:bold;">‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚úîÔ∏è</span>` : `<button class="btn-outline" style="border-color:var(--espresso); color:var(--espresso);" onclick="payFixedBtn(${f.id})">‡∏à‡πà‡∏≤‡∏¢‡∏ö‡∏¥‡∏•</button>`;
            if (f.isInst && f.totalM > 0) { let pct = (f.paidM / f.totalM) * 100; progressHTML = `<div style="margin-top: 10px; display: flex; align-items: center; gap: 8px;"><div style="flex: 1; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);"><div style="height: 100%; width: ${pct}%; background: linear-gradient(90deg, var(--bleu-porcelaine), var(--espresso)); border-radius: 3px;"></div></div><span style="font-size: 10px; color: var(--espresso); font-weight: 600; white-space: nowrap;">‡∏á‡∏ß‡∏î ${f.paidM}/${f.totalM}</span></div>`; if (f.paidM >= f.totalM) btn = `<span style="color:var(--success); font-size:11px; font-weight:bold;">üéâ ‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß!</span>`; }
            let editBtn = `<span style="color:var(--bleu-porcelaine); cursor:pointer; font-weight:bold; font-size:11px; margin-right:8px;" onclick="openEditFixedModal(${f.id})">[‡πÅ‡∏Å‡πâ]</span>`; let delBtn = `<span style="color:var(--danger); cursor:pointer; font-weight:bold; font-size:14px;" onclick="deleteFixedCost(${f.id})">‚úï</span>`;
            list.innerHTML += `<div class="list-item" style="display:flex; flex-direction:column; align-items:stretch; padding: 12px 0;"><div style="display:flex; justify-content:space-between; align-items:center; width:100%;"><div class="list-info" style="display:flex; align-items:center; gap:10px; flex:1; min-width:0; padding-right:10px;"><span style="font-size:24px; flex-shrink:0;">${f.icon}</span><div style="min-width:0;"><h4 style="margin:0; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:var(--espresso);">${titleText}</h4><div style="margin-top:4px;">${subText}</div></div></div><div style="display:flex; align-items:center; flex-shrink:0;"><span style="font-weight:bold; color:var(--danger); font-size:13px; margin-right:10px;">‡∏ø${f.amount.toLocaleString()}</span>${btn}<div style="display:flex; align-items:center; margin-left:10px; border-left:1px solid #cbd5e1; padding-left:10px;">${editBtn} ${delBtn}</div></div></div>${progressHTML}</div>`;
        });
        let pct = totalIncomeThisMonth > 0 ? (totalFixed / totalIncomeThisMonth) * 100 : 0;
        document.getElementById('fixedPctTxt').innerText = pct.toFixed(1) + '%'; document.getElementById('fixedPctBar').style.width = Math.min(100, pct) + '%'; document.getElementById('fixedPctBar').style.background = pct > 15 ? 'var(--danger)' : 'var(--terre-cuite)';
    }
    function openAddFixedModal() { document.getElementById('fcName').value = ''; document.getElementById('fcAmount').value = ''; document.getElementById('fcIcon').value = ''; document.getElementById('fcTank').value = 'essential'; document.getElementById('fcIsInst').checked = false; document.getElementById('fcInstDiv').style.display = 'none'; document.getElementById('fcTotalM').value = ''; document.getElementById('fcPaidM').value = ''; openModal('addFixedModal'); }
    function saveFixedCost() { let n=document.getElementById('fcName').value; let a=parseFloat(document.getElementById('fcAmount').value); let i=document.getElementById('fcIcon').value||'üßæ'; let t=document.getElementById('fcTank').value; let isInst = document.getElementById('fcIsInst').checked; let totalM = parseInt(document.getElementById('fcTotalM').value) || 0; let paidM = parseInt(document.getElementById('fcPaidM').value) || 0; if(n && a){ fixedCosts.push({ id: Date.now(), name: n, icon: i, amount: a, tank: t, paidThisMonth: false, isInst: isInst, totalM: totalM, paidM: paidM }); updateUI(); closeModal('addFixedModal'); } }
    function deleteFixedCost(id) { if(confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ?')) { fixedCosts = fixedCosts.filter(f => f.id !== id); updateUI(); } }
    function payFixedBtn(id) { let item = fixedCosts.find(f => f.id === id); activeFixedId = id; openExpenseModal(item.name, item.tank, item.amount); }
    function openEditFixedModal(id) { let f = fixedCosts.find(x => x.id === id); if(!f) return; document.getElementById('efcId').value = f.id; document.getElementById('efcName').value = f.name; document.getElementById('efcAmount').value = f.amount; document.getElementById('efcIcon').value = f.icon; document.getElementById('efcTank').value = f.tank; document.getElementById('efcIsInst').checked = f.isInst || false; document.getElementById('efcInstDiv').style.display = f.isInst ? 'flex' : 'none'; document.getElementById('efcTotalM').value = f.totalM || ''; document.getElementById('efcPaidM').value = f.paidM || ''; openModal('editFixedModal'); }
    function saveEditFixedCost() { let id = parseInt(document.getElementById('efcId').value); let f = fixedCosts.find(x => x.id === id); if(!f) return; f.name = document.getElementById('efcName').value; f.amount = parseFloat(document.getElementById('efcAmount').value) || 0; f.icon = document.getElementById('efcIcon').value || 'üßæ'; f.tank = document.getElementById('efcTank').value; f.isInst = document.getElementById('efcIsInst').checked; f.totalM = parseInt(document.getElementById('efcTotalM').value) || 0; f.paidM = parseInt(document.getElementById('efcPaidM').value) || 0; saveStorage(); updateUI(); closeModal('editFixedModal'); showToast('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏¥‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); }

    function renderYearlyFunds() {
        let list = document.getElementById('yearlyFundList'); list.innerHTML = '';
        yearlyFunds.forEach(y => {
            if(y.paidMonths === undefined) y.paidMonths = 0; if(y.monthlyVal === undefined) y.monthlyVal = Math.round(y.amount / 12);
            let dots = ''; for(let i=0; i<12; i++) { dots += `<div style="width: 12px; height: 12px; border-radius: 50%; background: ${i < y.paidMonths ? 'var(--eau-trouble)' : '#e2e8f0'}; border: 1px solid ${i < y.paidMonths ? 'var(--eau-trouble)' : '#cbd5e1'}; transition: 0.3s;"></div>`; }
            let doneBtn = y.paidMonths >= 12 ? `<span style="color:var(--success); font-size:11px; font-weight:bold;">‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß!</span>` : `<div style="display:flex; align-items:center; gap:5px;"><select id="ySource-${y.id}" style="font-size:10px; padding:2px; border-radius:5px; border:1px solid #cbd5e1; outline:none; background:white; font-family:'Kanit';"><option value="essential">‡∏à‡∏≤‡∏Å Essential</option><option value="joy">‡∏à‡∏≤‡∏Å Joy</option></select><button class="btn-outline" style="padding:4px 8px; border-color:var(--eau-trouble); color:var(--eau-trouble); font-size:10px;" onclick="addToYearly(${y.id})">+ ‡∏´‡∏¢‡∏≠‡∏î 1 ‡∏á‡∏ß‡∏î</button></div>`;
            list.innerHTML += `<div style="background:white; padding:12px; border-radius:10px; margin-top:10px; border:1px solid #cbd5e1;"><div style="display:flex; justify-content:space-between; margin-bottom:5px;"><b style="color:var(--espresso); font-size:13px;">${y.name}</b> <span style="font-size:11px; color:var(--eau-trouble); font-weight:bold;">‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà ${y.paidMonths}/12</span></div><div style="display: flex; gap: 4px; margin-top: 8px; justify-content: space-between;">${dots}</div><div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;"><div style="font-size:11px; color:var(--gray-text);">‡∏´‡∏±‡∏Å‡∏á‡∏ß‡∏î‡∏•‡∏∞: <input type="number" style="width:50px; padding:2px 4px; font-size:11px; border-radius: 8px; border: 1px solid #ccc; font-weight:bold; color:var(--terre-cuite); text-align:right; font-family:'Kanit';" value="${y.monthlyVal}" onchange="updateYMonthVal(${y.id}, this.value)"></div>${doneBtn}</div></div>`;
        });
    }
    function updateYMonthVal(id, val) { let y = yearlyFunds.find(x=>x.id===id); if(y && val>=0) { y.monthlyVal = parseFloat(val); saveStorage(); } }
    function addToYearly(id) { let y = yearlyFunds.find(x=>x.id===id); let sourceTank = document.getElementById(`ySource-${y.id}`).value; if(currentBalances[sourceTank] < y.monthlyVal) return alert(`‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ ${sourceTank} ‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏´‡∏¢‡∏≠‡∏î‡∏Ñ‡∏£‡∏±‡∏ö ‡∏î‡∏∂‡∏á‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞!`); currentBalances[sourceTank] -= y.monthlyVal; currentBalances.security += y.monthlyVal; y.current += y.monthlyVal; y.paidMonths += 1; updateUI(); showToast(`‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà ${y.paidMonths} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å ${sourceTank})!`); }
    function saveYearlyFund() { let n=document.getElementById('yName').value; let a=parseFloat(document.getElementById('yAmount').value); if(n&&a){yearlyFunds.push({id:Date.now(), name:n, amount:a, current:0, paidMonths:0, monthlyVal: Math.round(a/12)}); updateUI(); closeModal('addYearlyModal');} }

    function renderCreditBills() {
        let list = document.getElementById('creditBillList'); let pendingInstallments = [];
        transactions.forEach(t => { if((t.type === 'expense' || t.type === 'legacy_debt') && t.installments) { let nextUnpaid = t.installments.find(i => !i.paid); if(nextUnpaid) pendingInstallments.push({ tx: t, inst: nextUnpaid, totalInst: t.installments.length }); } });
        let totalUnpaidThisMonth = pendingInstallments.reduce((s, item) => s + item.inst.amount, 0);
        let warnEl = document.getElementById('incomeCreditWarning'); if (totalUnpaidThisMonth > 0) { warnEl.style.display = 'block'; document.getElementById('warnCreditAmt').innerText = totalUnpaidThisMonth.toLocaleString(); } else { warnEl.style.display = 'none'; }
        list.innerHTML = '';
        if (pendingInstallments.length === 0) { list.innerHTML = '<p style="text-align:center; font-size:11px; color:var(--bleu-porcelaine); margin-top:15px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏¥‡∏•‡∏ö‡∏±‡∏ï‡∏£/‡∏ú‡πà‡∏≠‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö! üéâ</p>'; return; }
        pendingInstallments.forEach(item => {
            let t = item.tx; let inst = item.inst; let d = new Date(t.dateObj).toLocaleDateString('th-TH'); let noteHtml = t.note ? ` <span style="color:var(--espresso); font-weight:normal;">(${t.note})</span>` : ''; let titleText = item.totalInst > 1 ? `${t.cat}${noteHtml} (‡∏á‡∏ß‡∏î ${inst.monthNo}/${item.totalInst})` : `${t.cat}${noteHtml}`;
            let editBtn = t.type === 'legacy_debt' ? `<button style="background:transparent; border:none; color:var(--bleu-porcelaine); font-size:11px; cursor:pointer; padding:0; font-weight:bold; margin-right:5px;" onclick="openEditLegacyDebt(${t.id})">[‡πÅ‡∏Å‡πâ]</button>` : '';
            list.innerHTML += `<div class="list-item" style="display:flex; justify-content:space-between; align-items:center; padding:10px 0;"><div class="list-info" style="display:flex; align-items:center; gap:8px; flex:1; min-width:0;"><span style="font-size:18px;">üí≥</span><div style="min-width:0;"><h4 style="margin:0; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:var(--espresso);">${titleText} <span style="font-size:9px; color:var(--danger);">[‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢]</span></h4><p style="margin:0; font-size:10px; color:var(--gray-text);">${d} | ‡∏ø${inst.amount.toLocaleString()}</p></div></div><div style="display:flex; align-items:center; gap:8px;"><button class="btn-main" style="width:auto; padding:4px 8px; margin:0; background:var(--bleu-porcelaine); font-size:10px;" onclick="payCreditBill(${t.id}, ${inst.monthNo})">‡∏à‡πà‡∏≤‡∏¢</button><div style="display:flex; align-items:center; border-left:1px solid #cbd5e1; padding-left:8px;">${editBtn}<button style="background:transparent; border:none; color:var(--danger); font-size:12px; cursor:pointer; padding:0; font-weight:bold;" onclick="undoTransaction(${t.id})">‚úï</button></div></div></div>`;
        });
    }
    function payCreditBill(txId, monthNo) { if(confirm('‡∏à‡πà‡∏≤‡∏¢‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°‡∏ö‡∏≠‡∏™?\n(‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ Security ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå)')) { let t = transactions.find(x => x.id === txId); if(t && t.installments) { let inst = t.installments.find(i => i.monthNo === monthNo); if(inst) { inst.paid = true; currentBalances.security -= inst.amount; saveStorage(); updateUI(); showToast('‚úÖ ‡∏à‡πà‡∏≤‡∏¢‡∏ö‡∏¥‡∏•‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å Security ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!'); } } } }
    function openLegacyDebtModal() { document.getElementById('ldName').value = ''; document.getElementById('ldAmt').value = ''; document.getElementById('ldMonths').value = '1'; openModal('addLegacyDebtModal'); }
    function saveLegacyDebt() { let name = document.getElementById('ldName').value; let amt = parseFloat(document.getElementById('ldAmt').value); let months = parseInt(document.getElementById('ldMonths').value) || 1; if(!name || !amt || amt <= 0) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö‡∏ö‡∏≠‡∏™!'); let installments = []; for(let i=1; i<=months; i++) { installments.push({monthNo: i, amount: amt, paid: false}); } transactions.push({ id: Date.now(), type: 'legacy_debt', dateObj: new Date().toISOString(), cat: '‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤: ' + name, note: '‡∏¢‡∏Å‡∏¢‡∏≠‡∏î‡∏°‡∏≤', amount: amt * months, installments: installments }); saveStorage(); updateUI(); closeModal('addLegacyDebtModal'); showToast('‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏¥‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); }
    function openEditLegacyDebt(id) { let t = transactions.find(x => x.id === id); if(!t || t.type !== 'legacy_debt') return; document.getElementById('eldId').value = t.id; document.getElementById('eldName').value = t.cat.replace('‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤: ', ''); let unpaid = t.installments.filter(i => !i.paid); let amt = unpaid.length > 0 ? unpaid[0].amount : 0; document.getElementById('eldAmt').value = amt; document.getElementById('eldMonths').value = unpaid.length; openModal('editLegacyDebtModal'); }
    function saveEditLegacyDebt() { let id = parseFloat(document.getElementById('eldId').value); let t = transactions.find(x => x.id === id); if(!t) return; let name = document.getElementById('eldName').value; let amt = parseFloat(document.getElementById('eldAmt').value); let remainMonths = parseInt(document.getElementById('eldMonths').value) || 1; if(!name || !amt || amt <= 0) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö!'); t.cat = '‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤: ' + name; let paidInsts = t.installments.filter(i => i.paid); let newInsts = [...paidInsts]; let startMonthNo = paidInsts.length > 0 ? paidInsts[paidInsts.length - 1].monthNo + 1 : 1; for(let i=0; i<remainMonths; i++) { newInsts.push({ monthNo: startMonthNo + i, amount: amt, paid: false }); } t.installments = newInsts; t.amount = newInsts.reduce((sum, i) => sum + i.amount, 0); saveStorage(); updateUI(); closeModal('editLegacyDebtModal'); showToast('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); }

    function processBorrow() { let a = parseFloat(document.getElementById('borrowAmt').value); let n = document.getElementById('borrowNote').value || '‡∏¢‡∏∑‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'; if(!a) return; totalLiability += a; currentBalances.essential += a; transactions.push({ id: Date.now(), type: 'debt_in', tank: 'essential', amount: a, cat: '‡∏¢‡∏∑‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏≤‡πÇ‡∏õ‡∏∞', note: n, dateObj: new Date().toISOString() }); updateUI(); renderDebtChart(); closeModal('addDebtModal'); showToast(`üì• ‡∏¢‡∏∑‡∏°‡πÄ‡∏á‡∏¥‡∏ô ${n} ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ Essential ‡πÅ‡∏•‡πâ‡∏ß!`); }
    function processPayback() { let a = parseFloat(document.getElementById('paybackAmt').value); let l = document.getElementById('paybackLender').value; if(!a) return; if(a > currentBalances.security) { alert(`‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô Security ‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏µ‡πâ‡∏ô‡∏∞‡∏ö‡∏≠‡∏™!`); return; } currentBalances.security -= a; totalLiability = Math.max(0, totalLiability - a); transactions.push({ id: Date.now(), type: 'debt_out', tank: 'security', amount: a, cat: '‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏µ‡πâ', note: l, dateObj: new Date().toISOString() }); updateUI(); renderDebtChart(); closeModal('payDebtModal'); showToast(`üì§ ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏´‡∏±‡∏Å‡∏à‡∏≤‡∏Å Security ‡πÅ‡∏•‡πâ‡∏ß!`); }
    function renderDebtLog() {
        let list = document.getElementById('debtLogList'); list.innerHTML = ''; let debtTx = transactions.filter(t => t.type === 'debt_in' || t.type === 'legacy_debt_in' || t.type === 'debt_out'); let lenders = new Set();
        [...debtTx].reverse().forEach(t => { let color = (t.type === 'debt_in' || t.type === 'legacy_debt_in') ? 'color:var(--danger)' : 'color:var(--success)'; let sign = (t.type === 'debt_in' || t.type === 'legacy_debt_in') ? '+' : '-'; let d = new Date(t.dateObj).toLocaleDateString('th-TH'); list.innerHTML += `<li class="list-item"><div class="list-info"><h4 style="color:var(--espresso); margin:0; font-size:13px;">${t.cat}</h4><p style="font-size:10px; color:var(--gray-text); margin:0;">${d} | ${t.note}</p></div><div style="display:flex; align-items:center; gap:5px;"><span class="list-amount" style="${color}; font-weight:bold; font-size:13px;">${sign}‡∏ø${t.amount.toLocaleString()}</span> <button onclick="undoTransaction(${t.id})" style="border:none; background:transparent; color:var(--gray-text); font-size:11px; cursor:pointer;">[‡∏•‡∏ö]</button></div></li>`; if(t.type === 'debt_in' || t.type === 'legacy_debt_in') lenders.add(t.note); });
        let pbSelect = document.getElementById('paybackLender'); if(pbSelect) { pbSelect.innerHTML = ''; if(lenders.size === 0) pbSelect.innerHTML = '<option value="‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>'; else lenders.forEach(l => pbSelect.innerHTML += `<option value="${l}">${l}</option>`); }
    }
    function renderDebtChart() {
        let debtInTx = transactions.filter(t => t.type === 'debt_in' || t.type === 'legacy_debt_in'); let debtOutTx = transactions.filter(t => t.type === 'debt_out'); let lenderBalances = {};
        debtInTx.forEach(t => lenderBalances[t.note] = (lenderBalances[t.note] || 0) + t.amount); debtOutTx.forEach(t => lenderBalances[t.note] = (lenderBalances[t.note] || 0) - t.amount);
        for(let key in lenderBalances) { if(lenderBalances[key] <= 0) delete lenderBalances[key]; }
        let ctx = document.getElementById('debtChart').getContext('2d'); if(debtChartInstance) debtChartInstance.destroy();
        if(Object.keys(lenderBalances).length === 0) { document.getElementById('debtChart').parentElement.style.display = 'none'; } else { document.getElementById('debtChart').parentElement.style.display = 'flex'; debtChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(lenderBalances), datasets: [{ data: Object.values(lenderBalances), backgroundColor: ['#a13a1e','#a79058','#f1c166','#8babca'] }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '50%', plugins:{ legend:{position:'right', labels:{color:'#4b2613', font:{family:'Kanit', size:11}}} } } }); }
    }
    function openLegacyBorrowedModal() { document.getElementById('lbAmt').value = ''; document.getElementById('lbNote').value = ''; openModal('addLegacyBorrowedModal'); }
    function saveLegacyBorrowed() { let amt = parseFloat(document.getElementById('lbAmt').value); let note = document.getElementById('lbNote').value || '‡∏¢‡∏∑‡∏°‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'; if(!amt || amt <= 0) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö'); totalLiability += amt; transactions.push({ id: Date.now(), type: 'legacy_debt_in', tank: 'none', amount: amt, cat: '‡∏´‡∏ô‡∏µ‡πâ‡∏¢‡∏∑‡∏°‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤', note: note, dateObj: new Date().toISOString() }); saveStorage(); updateUI(); if(typeof renderDebtChart === 'function') renderDebtChart(); closeModal('addLegacyBorrowedModal'); showToast(`üìú ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!`); }

    function renderReceivables() {
        let list = document.getElementById('receivableList'); if(!list) return; list.innerHTML = ''; let pendingRx = transactions.filter(t => t.type === 'receivable' && !t.paid);
        if(pendingRx.length === 0) { list.innerHTML = '<li style="font-size:11px; color:var(--gray-text);">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏¥‡∏•‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå (‡∏™‡∏ö‡∏≤‡∏¢‡πÉ‡∏à‡πÑ‡∏î‡πâ‡∏ö‡∏≠‡∏™!)</li>'; return; }
        pendingRx.forEach(r => {
            list.innerHTML += `<li class="list-item" style="border-bottom:1px dashed var(--eau-trouble);"><div class="list-info"><h4 style="margin:0; font-size:12px; color:var(--espresso);">${r.cat} <span class="tank-badge bg-${r.tank}">${r.tank}</span></h4><p style="margin:0; font-size:10px; color:var(--eau-trouble);">‡∏à‡∏≤‡∏Å: ${r.note}</p></div><div style="display:flex; align-items:center; gap:5px;"><span style="color:var(--eau-trouble); font-weight:bold; font-size:13px;">‡∏ø${r.amount.toLocaleString()}</span><button class="btn-main" style="width:auto; padding:4px 8px; font-size:10px; background:var(--eau-trouble); margin:0;" onclick="resolveReceivable(${r.id})">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß</button></div></li>`;
        });
    }
    function resolveReceivable(id) { let r = transactions.find(t => t.id === id); if(r && confirm(`‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡∏ø${r.amount} ‡∏à‡∏≤‡∏Å ${r.note} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?`)) { r.paid = true; currentBalances[r.tank] += r.amount; saveStorage(); updateUI(); showToast(`‚úÖ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô ‡∏ø${r.amount} ‡πÄ‡∏Ç‡πâ‡∏≤ ${r.tank} ‡πÅ‡∏•‡πâ‡∏ß!`); } }

    // --- 9. Analytics & AI Storytelling ---
    function evaluateHealth() {
        let hDesc = document.getElementById('healthDesc'); let hBadge = document.getElementById('healthBadge');
        if(!hDesc || !hBadge) return;
        let emergencyPct = secGoal.target > 0 ? currentBalances.security / secGoal.target : 0; 
        let dRatio = totalIncomeThisMonth > 0 ? (totalLiability / totalIncomeThisMonth) : (totalLiability > 0 ? 1 : 0);
        let lvl = 3; let bTxt = "‚öñÔ∏è ‡πÄ‡∏•‡πÄ‡∏ß‡∏• 3: ‡∏ó‡∏£‡∏á‡∏ï‡∏±‡∏ß"; let bCol = "var(--miel-dore)"; let text = "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡∏∂‡∏á‡∏ô‡∏∞‡∏ö‡∏≠‡∏™ ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢!";
        if(dRatio > 0.5 || (emergencyPct < 0.1 && totalLiability > 0)) { lvl=1; bTxt="üö® ‡πÄ‡∏•‡πÄ‡∏ß‡∏• 1: ‡∏ß‡∏¥‡∏Å‡∏§‡∏ï‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô"; bCol="var(--danger)"; text="‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏°‡∏≤‡∏Å‡∏ö‡∏≠‡∏™! ‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏¢‡∏≠‡∏∞‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á ‡πÄ‡∏•‡∏Ç‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏á‡∏î‡∏ñ‡∏±‡∏á Joy ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ!"; }
        else if(emergencyPct < 0.3) { lvl=2; bTxt="‚ö†Ô∏è ‡πÄ‡∏•‡πÄ‡∏ß‡∏• 2: ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á"; bCol="var(--terre-cuite)"; text="‡∏´‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏¢‡∏≠‡∏∞‡πÅ‡∏ï‡πà‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏ô‡∏∞‡∏ö‡∏≠‡∏™ ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡πÄ‡∏ï‡∏¥‡∏°‡∏ñ‡∏±‡∏á Security ‡∏î‡πà‡∏ß‡∏ô‡πÜ"; }
        else if(emergencyPct >= 0.5 && currentBalances.growth > 0) { lvl=4; bTxt="üõ°Ô∏è ‡πÄ‡∏•‡πÄ‡∏ß‡∏• 4: ‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á"; bCol="var(--bleu-porcelaine)"; text="‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏∏‡πà‡∏ô‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏≠‡∏±‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÉ‡∏ô Growth ‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏¢‡∏ö‡∏≠‡∏™"; }
        else if(emergencyPct >= 1 && currentBalances.growth > secGoal.target) { lvl=5; bTxt="üöÄ ‡πÄ‡∏•‡πÄ‡∏ß‡∏• 5: ‡∏°‡∏±‡πà‡∏á‡∏Ñ‡∏±‡πà‡∏á‡∏≠‡∏¥‡∏™‡∏£‡∏∞"; bCol="var(--success)"; text="‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏ö‡∏ö! ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å‡∏ö‡∏≠‡∏™ ‡πÄ‡∏Å‡πà‡∏á‡∏™‡∏∏‡∏î‡πÜ"; }
        hBadge.innerText = bTxt; hBadge.style.background = bCol; hDesc.innerText = text;
    }

    function changeMonth(dir) { viewingMonthOffset += dir; if(viewingMonthOffset > 0) viewingMonthOffset = 0; renderAnalyticsCycle(); }
    
    function renderAnalyticsCycle() {
        evaluateHealth();
        let now = new Date(); let pd = cfg.payday || 25;
        let currentCycleStart = new Date(now.getFullYear(), now.getMonth(), pd);
        if(now.getDate() < pd) currentCycleStart.setMonth(currentCycleStart.getMonth() - 1);
        let cycleStart = new Date(currentCycleStart); cycleStart.setMonth(cycleStart.getMonth() + viewingMonthOffset);
        let cycleEnd = new Date(cycleStart); cycleEnd.setMonth(cycleEnd.getMonth() + 1); cycleEnd.setDate(cycleEnd.getDate() - 1);
        cycleStart.setHours(0,0,0,0); cycleEnd.setHours(23,59,59,999);
        
        let mNames = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
        document.getElementById('currentMonthDisplay').innerText = `${cycleStart.getDate()} ${mNames[cycleStart.getMonth()]} ${cycleStart.getFullYear().toString().substr(2,2)} - ${cycleEnd.getDate()} ${mNames[cycleEnd.getMonth()]} ${cycleEnd.getFullYear().toString().substr(2,2)}`;

        let cycleTx = transactions.filter(t => { let d = new Date(t.dateObj); return d >= cycleStart && d <= cycleEnd; });
        let exTx = cycleTx.filter(t=>t.type==='expense'); let inTx = cycleTx.filter(t=>t.type==='main_income');
        
        let sumIn = inTx.reduce((s,t)=>s+t.amount,0); let sumEx = exTx.reduce((s,t)=>s+t.amount,0);
        document.getElementById('sumIncomeText').innerText = `‡∏ø${sumIn.toLocaleString()}`; document.getElementById('sumExpenseText').innerText = `‡∏ø${sumEx.toLocaleString()}`; document.getElementById('sumNetText').innerText = `‡∏ø${(sumIn-sumEx).toLocaleString()}`;
        document.getElementById('sumPctText').innerText = `‡πÉ‡∏ä‡πâ‡πÑ‡∏õ ${sumIn>0 ? Math.round((sumEx/sumIn)*100) : 0}%`;

        // Insights Update (Original UI Mapping)
        let targetSpendPct = (cfg.e + cfg.j) / 100; document.getElementById('idealPctShow').innerText = (cfg.e + cfg.j);
        let avgMonthlyExp = 0; let expenseTxsAll = transactions.filter(t=>t.type==='expense');
        if(expenseTxsAll.length > 0) { 
            let minDate = expenseTxsAll.reduce((min, t) => { let d = new Date(t.dateObj); return d < min ? d : min; }, now); 
            let daysActive = (now - minDate)/(1000*3600*24); let monthsActive = Math.max(1, daysActive / 30); 
            let allTimeExp = expenseTxsAll.reduce((s,t)=>s+t.amount, 0); avgMonthlyExp = allTimeExp / monthsActive; 
        }
        let idealSal = targetSpendPct > 0 ? avgMonthlyExp / targetSpendPct : 0; 
        document.getElementById('idealSalaryBox').style.display = 'block';
        document.getElementById('idealSalaryTxt').innerHTML = idealSal > 0 ? `‡∏ø${Math.round(idealSal).toLocaleString()} <span style="font-size:11px;">/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>` : `‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...`;

        let joyTxs = cycleTx.filter(t => t.tank === 'joy'); 
        let smallWinAmt = joyTxs.filter(t => t.joyType === 'small').reduce((s,t) => s+t.amount, 0); 
        let bigWinAmt = joyTxs.filter(t => t.joyType === 'big').reduce((s,t) => s+t.amount, 0);
        let totalJoyFund = currentBalances.joy + smallWinAmt + bigWinAmt; 
        let smallWinEatPct = totalJoyFund > 0 ? Math.round((smallWinAmt / totalJoyFund) * 100) : 0; 
        let bigWinRemainPct = 100 - smallWinEatPct;
        document.getElementById('insightSmallWin').innerText = `‡∏Å‡∏¥‡∏ô‡∏á‡∏ö‡πÑ‡∏õ ${smallWinEatPct}%`; 
        document.getElementById('insightBigWin').innerText = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 100%`;

        let dayNames = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏Ø', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå']; let dayCounts = [0,0,0,0,0,0,0];
        exTx.forEach(t => { let d = new Date(t.dateObj).getDay(); dayCounts[d] += t.amount; }); 
        let maxDayIdx = dayCounts.indexOf(Math.max(...dayCounts));
        document.getElementById('insightDay').innerText = Math.max(...dayCounts) > 0 ? dayNames[maxDayIdx] : '-';

        let crossTxs = cycleTx.filter(t => t.isCross); 
        document.getElementById('insightCrossCount').innerText = crossTxs.length;
        let reasons = {}; crossTxs.forEach(t => { if(t.crossReason) reasons[t.crossReason] = (reasons[t.crossReason] || 0) + 1; }); 
        let topReason = Object.keys(reasons).length > 0 ? Object.keys(reasons).reduce((a, b) => reasons[a] > reasons[b] ? a : b) : '-';
        document.getElementById('insightCrossReason').innerText = topReason;

        document.getElementById('insightSavedTemptation').innerText = stats.savedFromTemptation.toLocaleString();
        document.getElementById('insightWinTemptCount').innerText = stats.temptationAbandonedCount || 0;
        document.getElementById('insightLoseTemptCount').innerText = stats.temptationYieldedCount || 0;

        let futureMoneySum = transactions.flatMap(t => t.installments || []).filter(i => !i.paid).reduce((s,i) => s + i.amount, 0);
        document.getElementById('insightFutureMoney').innerText = futureMoneySum.toLocaleString();
        let futurePct = sumIn > 0 ? (futureMoneySum / sumIn) * 100 : 0; 
        let futureAdviceTxt = `‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô ${Math.round(futurePct)}% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö<br>`;
        if (futurePct === 0) futureAdviceTxt += `<span style="color:var(--success);">‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å‡∏ö‡∏≠‡∏™! ‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏¢</span>`; 
        else if (futurePct <= 15) futureAdviceTxt += `<span style="color:var(--success);">‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÅ‡∏ï‡πà‡∏Å‡πá‡∏≠‡∏¢‡πà‡∏≤‡∏£‡∏π‡∏î‡πÄ‡∏û‡∏•‡∏¥‡∏ô‡∏ô‡∏∞</span>`; 
        else if (futurePct <= 30) futureAdviceTxt += `<span style="color:var(--terre-cuite);">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏¢‡∏≠‡∏∞‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞‡∏ö‡∏≠‡∏™! ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏ä‡πá‡∏≠‡∏ï‡∏ô‡∏∞</span>`; 
        else futureAdviceTxt += `<span style="color:var(--danger); font-weight:bold;">‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏°‡∏≤‡∏Å! ‡∏¢‡∏∑‡∏°‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡∏°‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 30% ‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏π‡∏î‡∏î‡πà‡∏ß‡∏ô!</span>`;
        document.getElementById('insightFutureAdvice').innerHTML = futureAdviceTxt;

        // AI Storytelling Generator
        let winR = (stats.temptationAbandonedCount + stats.temptationYieldedCount) > 0 ? (stats.temptationAbandonedCount / (stats.temptationAbandonedCount + stats.temptationYieldedCount))*100 : 0;
        let dti = sumIn > 0 ? (totalLiability / sumIn) * 100 : (totalLiability > 0 ? 100 : 0);
        
        let story = ``;
        if (sumIn === 0) story += "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡∏¢‡∏ö‡∏≠‡∏™! ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏Å‡∏î‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡∏ô‡∏∞";
        else if (sumEx > sumIn) story += `üö® <b>‡∏ß‡∏¥‡∏Å‡∏§‡∏ï‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏≠‡∏™!</b> ‡∏£‡∏≠‡∏ö‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏∞‡∏•‡∏∏‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß (‡∏ï‡∏¥‡∏î‡∏•‡∏ö ‡∏ø${(sumEx-sumIn).toLocaleString()}) ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏õ‡∏¢‡πå‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏î‡πà‡∏ß‡∏ô!`;
        else if (winR > 70) story += `‚ú® <b>‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡∏ô‡∏±‡∏Å‡∏™‡∏π‡πâ!</b> ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏ô‡∏∞‡πÉ‡∏à‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏ö‡πà‡∏≠‡∏¢‡∏°‡∏≤‡∏Å ‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏Ç‡∏≠‡∏á‡πÅ‡∏ä‡πà‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏¢‡∏≠‡∏∞‡πÄ‡∏•‡∏¢ ‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏≠‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÑ‡∏õ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏ç‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞!`;
        else if (crossTxs.length > 3) story += `‚ö†Ô∏è <b>‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏û‡∏±‡∏á!</b> ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏î‡∏∂‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ö‡πà‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö % ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏à‡∏£‡∏¥‡∏á ‡∏•‡∏≠‡∏á‡∏Å‡∏î "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤" ‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô Essential ‡πÉ‡∏´‡πâ‡πÄ‡∏¢‡∏≠‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡∏î‡∏π‡πÑ‡∏´‡∏°?`;
        else story += `‚öñÔ∏è <b>‡∏ó‡∏£‡∏á‡∏ï‡∏±‡∏ß‡πÑ‡∏î‡πâ‡∏î‡∏µ:</b> ‡∏£‡∏≠‡∏ö‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏Ñ‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏£‡∏≠‡∏î‡∏°‡∏≤‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö‡∏ö‡∏≠‡∏™ ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏î‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ ‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏ç‡πà‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô!`;
        
        if (smallWinEatPct > 50) { story += `<br><br>üö® <b>‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏¥‡πÄ‡∏•‡∏™:</b> ‡∏ö‡∏≠‡∏™‡πÄ‡∏≠‡∏≤ Small Win ‡∏Å‡∏¥‡∏ô‡∏á‡∏ö Big Win ‡πÑ‡∏õ‡∏ï‡∏±‡πâ‡∏á ${smallWinEatPct}% ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞! ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà‡∏à‡∏∞‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏ô‡∏µ‡πà‡∏¢!`; }
        let stressedAmt = exTx.filter(t=>t.emotion==='üò© ‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡πÄ‡∏•‡∏¢‡∏ä‡πâ‡∏≠‡∏õ').reduce((s,t)=>s+t.amount,0);
        if(stressedAmt > 0) { story += `<br><br>üé≠ <b>‡∏ä‡πâ‡∏≠‡∏õ‡∏ö‡∏≥‡∏ö‡∏±‡∏î:</b> ‡∏ö‡∏≠‡∏™‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏õ‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏° '‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î' ‡∏ø${stressedAmt.toLocaleString()} ‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡∏Æ‡∏µ‡∏•‡πÉ‡∏à‡∏ü‡∏£‡∏µ‡πÜ ‡∏î‡∏π‡∏ö‡πâ‡∏≤‡∏á‡∏ô‡∏∞`; }

        document.getElementById('aiAdviceText').innerHTML = story;

        // Chart
        let totals = {}; exTx.forEach(t => totals[t.cat] = (totals[t.cat] || 0) + t.amount);
        let ctx = document.getElementById('analyticsChart').getContext('2d'); if(analyticsChartInstance) analyticsChartInstance.destroy();
        if(Object.keys(totals).length === 0) { document.getElementById('analyticsChart').style.display='none'; document.getElementById('noDataText').style.display='block'; }
        else {
            document.getElementById('analyticsChart').style.display='block'; document.getElementById('noDataText').style.display='none';
            analyticsChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(totals), datasets: [{ data: Object.values(totals), backgroundColor: ['#4b2613','#a79058','#a13a1e','#8babca','#f1c166'] }] }, options: { responsive: true, maintainAspectRatio: false, cutout:'55%', plugins:{ legend:{position:'right', labels:{color:'#4b2613', font:{family:'Kanit', size:11}}} } } });
        }
    }

    function drawSankey() {
        if (!document.getElementById('view-cashflow').classList.contains('active')) return;
        let container = document.getElementById('sankey_basic'); container.innerHTML = '<p style="color:var(--gray-text);">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≤‡∏¢‡∏ô‡πâ‡∏≥...</p>'; container.style.justifyContent = "flex-start";
        let data = new google.visualization.DataTable(); data.addColumn('string', 'From'); data.addColumn('string', 'To'); data.addColumn('number', 'Amount (‡∏ø)');
        let rows = []; let pd = cfg.payday || 25; let now = new Date(); let currentCycleStart = new Date(now.getFullYear(), now.getMonth(), pd); if(now.getDate() < pd) currentCycleStart.setMonth(currentCycleStart.getMonth() - 1); let cycleStart = new Date(currentCycleStart); cycleStart.setMonth(cycleStart.getMonth() + viewingMonthOffset); let cycleEnd = new Date(cycleStart); cycleEnd.setMonth(cycleEnd.getMonth() + 1); cycleEnd.setDate(cycleEnd.getDate() - 1); cycleStart.setHours(0,0,0,0); cycleEnd.setHours(23,59,59,999);
        let mTx = transactions.filter(t => { let d = new Date(t.dateObj); return d >= cycleStart && d <= cycleEnd; });
        let inG=0, inS=0, inE=0, inJ=0; mTx.filter(t=>t.type==='main_income').forEach(t=>{inG+=t.amount*(cfg.g/100);inS+=t.amount*(cfg.s/100);inE+=t.amount*(cfg.e/100);inJ+=t.amount*(cfg.j/100);});
        if(inE>0)rows.push(['‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö','üõí Essential',inE]); if(inJ>0)rows.push(['‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö','üéâ Joy',inJ]); if(inS>0)rows.push(['‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö','üõ°Ô∏è Security',inS]); if(inG>0)rows.push(['‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö','üå± Growth',inG]);
        let exp={essential:{}, joy:{}, security:{}, growth:{}}; mTx.filter(t=>t.type==='expense').forEach(t=>{if(!exp[t.tank])return; exp[t.tank][t.cat] = (exp[t.tank][t.cat]||0)+t.amount;});
        const nameMap = { 'essential': 'üõí Essential', 'joy': 'üéâ Joy', 'security': 'üõ°Ô∏è Security', 'growth': 'üå± Growth' };
        ['essential','joy','security','growth'].forEach(tk=>{ let tN = nameMap[tk]; let ts=0; for(let c in exp[tk]){rows.push([tN, c, exp[tk][c]]); ts+=exp[tk][c];} let rem = (tk==='essential'?inE:tk==='joy'?inJ:tk==='security'?inS:inG) - ts; if(rem>0) rows.push([tN, `üí∞ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (${tk})`, rem]); });
        if(rows.length===0){container.innerHTML='<p style="color:var(--gray-text); font-size:12px;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏Ñ‡∏£‡∏±‡∏ö‡∏ö‡∏≠‡∏™</p>';return;} data.addRows(rows);
        new google.visualization.Sankey(container).draw(data, {width: 800, height: 450, sankey:{node:{label:{fontName:'Kanit',fontSize:12, color: '#4b2613', bold: true}, colors: ['#8babca', '#a13a1e', '#f1c166', '#a79058', '#22c55e']}}});
    }

    window.onload = () => { loadStorage(); };
</script>
</body>
</html>