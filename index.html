<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏°‡∏µ‡∏™‡∏ï‡∏¥‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡∏∏‡∏ì!!</title>
    <meta name="apple-mobile-web-app-title" content="‡∏°‡∏µ‡∏™‡∏ï‡∏¥‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡∏∏‡∏ì!!">
    <link rel="icon" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#fbfaf0">
    
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script>google.charts.load('current', {'packages':['sankey']});</script>

    <style>
        /* CI Colors & Theme */
        :root {
            --espresso: #542916; --eau-trouble: #a79058; --terre-cuite: #a13a1e; 
            --bleu-porcelaine: #8babca; --nuage-de-lait: #fbfaf0; --miel-dore: #f1c166;     
            --white: #ffffff; --gray-light: #f0f0f0; --gray-text: #888888; --overlay: rgba(84, 41, 22, 0.8);
            --danger: #ef4444; --success: #22c55e;
        }

        * { box-sizing: border-box; font-family: 'Kanit', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: #d1d5db; margin: 0; display: flex; justify-content: center; height: 100vh; height: 100dvh; overflow: hidden; overscroll-behavior-y: none; }

        .app { width: 100%; max-width: 420px; background-color: var(--nuage-de-lait); height: 100vh; height: 100dvh; position: relative; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .view-section { display: none; flex: 1; overflow-y: auto; padding: 25px 20px calc(90px + env(safe-area-inset-bottom)) 20px; overscroll-behavior-y: contain; -webkit-overflow-scrolling: touch; }
        .view-section.active { display: block; }

        .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; gap: 8px; }
        .header-left { display: flex; flex-direction: column; flex: 1; min-width: 0; }
        .header h1 { color: var(--espresso); margin: 0; font-size: 18px; font-weight: 700; line-height: 1.3; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .point-badge { background: linear-gradient(135deg, #fef08a, #fde047); color: #854d0e; padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: bold; display: inline-flex; align-items: center; gap: 5px; margin-top: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; align-self: flex-start;}
        .point-badge:active { transform: scale(0.95); }
        .shop-btn { background: var(--espresso); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 10px; display: flex; justify-content: center; align-items: center; cursor: pointer; }

        .profile-pic { width: 45px; height: 45px; background-color: var(--miel-dore); border-radius: 50%; display: flex; justify-content: center; align-items: center; color: var(--espresso); font-weight: bold; cursor:pointer; background-size: cover; background-position: center; overflow: hidden; border: 2px solid var(--white); box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-shrink: 0; }
        .settings-btn { background: var(--gray-light); border: none; font-size: 12px; border-radius: 12px; padding: 4px 8px; cursor: pointer; color: var(--espresso); font-weight: bold; white-space: nowrap; }

        /* Cards */
        .card { background: var(--white); border-radius: 24px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(84, 41, 22, 0.05); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .card-title { color: var(--espresso); font-size: 18px; font-weight: 700; margin: 0; display:flex; align-items:center; justify-content:space-between;}
        .btn-main { background: var(--espresso); color: var(--white); border: none; width: 100%; padding: 15px; border-radius: 15px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; transition: 0.2s;}
        .btn-main:active { transform: scale(0.98); }
        .btn-outline { background: transparent; border: 1px solid var(--espresso); color: var(--espresso); padding: 6px 12px; border-radius: 10px; font-size: 12px; font-weight: bold; cursor: pointer; }

        /* Income Input */
        .income-card { display: flex; gap: 10px; margin-bottom: 20px; }
        .income-card input { flex: 1; border: 1px solid #ddd; padding: 12px 15px; border-radius: 12px; font-size: 16px; outline: none; }
        .income-card button { background: var(--espresso); color: var(--white); border: none; padding: 0 20px; border-radius: 12px; font-weight: 600; cursor: pointer; }
        
        /* Tanks Display */
        .tanks-container { display: flex; justify-content: space-between; height: 160px; align-items: flex-end; }
        .tank-wrapper { display: flex; flex-direction: column; align-items: center; width: 22%; cursor: pointer; transition: 0.2s;}
        .tank-wrapper:active { transform: scale(0.95); }
        .tank-bg { background-color: var(--gray-light); width: 45px; height: 110px; border-radius: 25px; position: relative; overflow: hidden; display: flex; align-items: flex-end; margin-bottom: 5px; }
        .tank-fill { width: 100%; border-radius: 25px; transition: height 0.8s ease-out; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 10px; color: var(--white); font-weight: bold; font-size: 11px; }
        
        .fill-growth { background-color: var(--bleu-porcelaine); } .fill-security { background-color: var(--miel-dore); color: var(--espresso); }
        .fill-essential { background-color: var(--terre-cuite); } .fill-joy { background-color: var(--eau-trouble); }
        .fill-debt { background-color: var(--danger); }
        
        .tank-label { font-size: 13px; color: var(--espresso); font-weight: 700; margin-bottom: -2px; }
        .tank-sub { font-size: 10px; color: var(--gray-text); margin-bottom: 2px;}
        .tank-amount { font-size: 11px; color: var(--espresso); font-weight: 600; }

        /* Categories */
        .categories-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
        .cat-btn { background: var(--gray-light); border-radius: 16px; padding: 12px 5px; display: flex; flex-direction: column; align-items: center; cursor: pointer; position: relative; border: 1px solid transparent;}
        .cat-btn:active { background: #e2e8f0; }
        .cat-btn.add-new { border: 1px dashed var(--gray-text); background: transparent; }
        .cat-icon { font-size: 24px; margin-bottom: 5px; }
        .cat-name { font-size: 11px; color: var(--espresso); text-align: center; font-weight:500;}
        .delete-btn { position: absolute; top: -8px; right: -8px; background: var(--danger); color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 12px; display: flex; justify-content: center; align-items: center; border: 2px solid white; cursor: pointer; z-index: 2;}

        /* Fixed Cost & Goals */
        .fixed-cost-bar { width: 100%; height: 10px; background: #ddd; border-radius: 5px; margin: 10px 0; overflow: hidden;}
        .fixed-cost-fill { height: 100%; background: var(--danger); width: 0%; transition: width 0.5s; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed #eee; }
        .inline-edit-input { width: 70px; padding: 4px 8px; border-radius: 8px; border: 1px solid #ccc; font-size: 14px; font-family:'Kanit'; font-weight:bold; color:var(--terre-cuite); text-align:right;}
        .tank-badge { font-size: 9px; padding: 2px 6px; border-radius: 4px; color: white; margin-left: 5px; }
        .bg-essential { background: var(--terre-cuite); } .bg-joy { background: var(--eau-trouble); } .bg-security { background: var(--miel-dore); color: var(--espresso); }

        .goal-box { background: rgba(167, 144, 88, 0.1); border: 1px solid var(--eau-trouble); padding: 15px; border-radius: 15px; margin-bottom: 15px; }
        .goal-input { border: none; background: transparent; font-size: 16px; font-weight: bold; color: var(--espresso); width: 100%; outline: none; border-bottom: 1px dashed var(--eau-trouble); margin-bottom: 10px;}
        .goal-progress-bg { height: 16px; background: #e5e7eb; border-radius: 8px; overflow: hidden; position: relative; margin-bottom: 5px;}
        .goal-progress-fill { height: 100%; background: linear-gradient(90deg, var(--miel-dore), var(--eau-trouble)); transition: width 0.5s; display:flex; justify-content:flex-end; align-items:center; padding-right:5px; color:white; font-size:10px; font-weight:bold;}

        /* Sinking Funds Dots */
        .sinking-dots { display: flex; gap: 4px; margin-top: 8px; justify-content: space-between;}
        .sinking-dot { width: 14px; height: 14px; border-radius: 50%; background: #e2e8f0; border: 1px solid #cbd5e1; transition: 0.3s;}
        .sinking-dot.filled { background: var(--bleu-porcelaine); border-color: var(--bleu-porcelaine); box-shadow: 0 0 5px rgba(139, 171, 202, 0.5);}

        /* Gamification Quests & Rewards */
        .quest-box { background: linear-gradient(135deg, #fef3c7, #ffedd5); border: 1px solid #fcd34d; border-radius: 16px; padding: 15px; margin-bottom: 20px;}
        .quest-item { display: flex; align-items: flex-start; justify-content: space-between; gap: 10px; font-size: 13px; margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 10px; transition: 0.3s;}
        .quest-item input { width: 18px; height: 18px; accent-color: var(--eau-trouble); margin-top: 2px;}
        .quest-item.completed { opacity: 0.5; text-decoration: line-through; }
        .skip-btn { background: transparent; border: none; font-size: 16px; cursor: pointer; color: #888; padding: 0; transition:0.2s;}
        
        .reward-item { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.02);}
        .reward-info h4 { margin: 0; color: var(--espresso); font-size: 14px;}
        .reward-info p { margin: 2px 0 0 0; color: var(--gray-text); font-size: 11px;}
        .reward-cost { font-weight: bold; color: #854d0e; font-size: 14px; background: #fef08a; padding: 4px 8px; border-radius: 8px; display: flex; align-items: center; gap: 4px; white-space: nowrap;}

        .wishlist-btn { width: 100%; background: #fef08a; border: 1px solid #eab308; color: #854d0e; font-weight: bold; border-radius: 12px; padding: 10px; text-align: center; cursor: pointer; margin-top: 10px;}
        .wishlist-item { background: #fff; border: 1px solid #ddd; border-left: 4px solid var(--eau-trouble); padding: 10px; border-radius: 8px; margin-top: 10px;}

        /* AI & Insights */
        .health-badge { display: inline-block; padding: 6px 15px; border-radius: 12px; font-weight: bold; font-size: 15px; color: white; margin-bottom: 10px;}
        .ai-advisor { background: rgba(139, 171, 202, 0.15); border: 1px solid var(--bleu-porcelaine); padding: 15px; border-radius: 15px; margin-top: 20px; font-size: 13px; color: var(--espresso); }
        .preset-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .preset-btn { background: #f8fafc; border: 1px solid #cbd5e1; padding: 8px; border-radius: 10px; font-size: 11px; cursor: pointer; color: var(--espresso); font-weight:600; text-align:center;}
        
        .cross-tank-box { background: #fee2e2; padding: 15px; border-radius: 12px; border: 1px solid #f87171; display: none; margin-bottom: 15px; }
        .data-insight-box { background: var(--white); border-left: 4px solid var(--bleu-porcelaine); padding: 10px 15px; border-radius: 8px; margin-top:10px; box-shadow: 0 2px 5px rgba(0,0,0,0.02);}

        /* Net Summary Dashboard */
        .summary-dashboard { background: var(--espresso); color: white; border-radius: 16px; padding: 15px; margin-bottom: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .sum-box { text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 12px;}
        .sum-box.full-width { grid-column: 1 / -1; background: white; color: var(--espresso); margin-top: 5px;}
        .sum-title { font-size: 11px; opacity: 0.8; margin: 0 0 5px 0;}
        .sum-val { font-size: 18px; font-weight: bold; margin: 0;}
        .val-in { color: #86efac; } .val-out { color: #fca5a5; }
        
        .ideal-salary-box { background: linear-gradient(135deg, #dcfce7, #bbf7d0); border: 1px solid #86efac; border-radius: 16px; padding: 15px; margin-top: 15px; display:none;}

        /* GIF Overlay */
        .gif-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(84, 41, 22, 0.95); backdrop-filter: blur(5px); z-index: 99999; display: none; justify-content: center; align-items: center; flex-direction: column; opacity: 0; transition: opacity 0.3s; }
        .gif-overlay.show { display: flex; opacity: 1; }
        .gif-overlay img { max-width: 80%; max-height: 40vh; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); object-fit: cover;}
        .gif-overlay h2 { color: white; margin-top: 20px; font-size: 22px; text-align: center; text-shadow: 0 2px 4px rgba(0,0,0,0.5); padding: 0 20px; line-height: 1.4;}

        /* Nav & Modals */
        /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö 5 ‡∏õ‡∏∏‡πà‡∏° (20%) */
        .bottom-nav { position: absolute; bottom: 0; left: 0; right: 0; background: var(--white); min-height: 75px; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -5px 15px rgba(0,0,0,0.05); border-radius: 20px 20px 0 0; z-index: 50; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--gray-text); font-size: 11px; cursor: pointer; width: 20%; transition: 0.2s; }
        .nav-item.active { color: var(--espresso); font-weight: bold; transform: translateY(-3px);}
        .nav-icon { font-size: 22px; margin-bottom: 2px; }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--overlay); backdrop-filter: blur(3px); z-index: 10000; display: none; justify-content: center; align-items: flex-end; }
        .modal-content { background: var(--nuage-de-lait); width: 100%; border-radius: 30px 30px 0 0; padding: 25px; transform: translateY(100%); transition: transform 0.3s; max-height: 85vh; overflow-y: auto; }
        .modal-overlay.active { display: flex; } .modal-overlay.active .modal-content { transform: translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .modal-header h2 { margin: 0; font-size: 20px; color: var(--espresso);}
        .tank-desc-text { font-size: 13px; color: var(--gray-text); margin-top: 0; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #ddd;}
        .close-btn { background: #e2e8f0; border: none; width: 32px; height: 32px; border-radius: 50%; font-weight: bold; cursor: pointer; color: #475569;}
        .form-group { margin-bottom: 15px; } .form-group label { display: block; font-size: 13px; color: var(--gray-text); margin-bottom: 5px; font-weight:600;}
        .form-group input, .form-group select { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #cbd5e1; font-size: 16px; outline: none; background:var(--white); box-sizing: border-box;}

        .chart-container { position: relative; height: 220px; width: 100%; margin-bottom: 20px; display:flex; justify-content:center;}
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--success); color: white; padding: 12px 24px; border-radius: 20px; font-size: 14px; font-weight:bold; z-index: 1000; opacity: 0; transition: 0.3s; pointer-events: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15);}
        .toast.show { opacity: 1; }
        @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }
    </style>
</head>
<body>

<div class="toast" id="toastMsg">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>

<div id="gifOverlay" class="gif-overlay" onclick="closeGifOverlay()">
    <img id="gifImage" src="">
    <h2 id="gifText"></h2>
    <p style="color:#ddd; font-size:12px; margin-top:10px;">(‡πÅ‡∏ï‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î)</p>
</div>

<div class="app">
    <div id="view-home" class="view-section active">
        <div class="header">
            <div class="header-left">
                <h1 id="userGreeting">‡∏°‡∏µ‡∏™‡∏ï‡∏¥‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡∏∏‡∏ì Dream!!!</h1>
                <div class="point-badge" onclick="openModal('rewardShopModal')">
                    <span id="userPointsDisplay">ü™ô 0 ‡πÅ‡∏ï‡πâ‡∏°</span>
                    <button class="shop-btn">üõí</button>
                </div>
            </div>
            <div style="display:flex; gap:8px; align-items:center; flex-shrink:0;">
                <button class="settings-btn" onclick="openConfigModal()">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
                <div class="profile-pic" id="profilePicDisplay" onclick="document.getElementById('profilePicInput').click()">D</div>
                <input type="file" id="profilePicInput" style="display:none;" accept="image/*" onchange="uploadProfilePic(event)">
            </div>
        </div>

        <div class="card" style="padding: 15px; margin-bottom: 20px;">
            <p style="margin:0 0 5px 0; font-size:12px; color:var(--gray-text); font-weight:bold;">üì• ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</p>
            <div style="display: flex; gap: 8px; margin-bottom: 10px; width: 100%;">
                <input type="number" id="mainIncomeInput" placeholder="‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô" style="width: 100px; flex-shrink: 0; border: 1px solid #ddd; padding: 10px; border-radius: 12px; outline: none; font-size:14px; box-sizing: border-box;">
                <select id="incomeCatSelect" style="flex-grow: 1; min-width: 0; border: 1px solid #ddd; padding: 10px; border-radius: 12px; outline: none; background: white; font-size:13px; box-sizing: border-box;" onchange="if(this.value==='add_new') openModal('addIncomeCatModal')"></select>
            </div>
            <div style="display: flex; gap: 5px;">
                <input type="date" id="incomeDateInput" style="flex: 1; border: 1px solid #ddd; padding: 10px; border-radius: 12px; outline: none; color:var(--gray-text); font-size:13px; box-sizing: border-box;">
                <button class="btn-main" style="flex: 1; margin-top: 0; padding: 10px; font-size:14px;" onclick="confirmIncome()">‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£‡πÄ‡∏á‡∏¥‡∏ô</button>
            </div>
            <p id="incomeCreditWarning" style="margin:8px 0 0 0; font-size:11px; color:var(--danger); display:none; font-weight:bold;">üö® ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏ô‡∏∞‡∏ö‡∏≠‡∏™! ‡∏°‡∏µ‡∏ö‡∏¥‡∏•‡∏ö‡∏±‡∏ï‡∏£/‡∏ú‡πà‡∏≠‡∏ô ‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏¢‡∏π‡πà ‡∏ø<span id="warnCreditAmt">0</span> (‡πÄ‡∏á‡∏¥‡∏ô‡∏ñ‡∏π‡∏Å‡∏Å‡∏±‡∏ô‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≠‡∏ô‡∏£‡∏π‡∏î ‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏ú‡∏•‡∏≠‡πÄ‡∏≠‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏•‡πà‡∏∞!)</p>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title" style="font-size: 16px;">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô (Tanks)</h2>
                <button class="btn-outline" onclick="sweepChange()">üßπ ‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡∏•‡∏á‡∏ó‡∏∏‡∏ô</button>
            </div>
            <div class="tanks-container">
                <div class="tank-wrapper" onclick="openTankHistory('growth', 'Growth (‡∏•‡∏á‡∏ó‡∏∏‡∏ô)')">
                    <div class="tank-bg"><div class="tank-fill fill-growth" id="bar-growth">0%</div></div>
                    <div class="tank-label">Growth</div><div class="tank-sub" id="sub-growth">‡∏•‡∏á‡∏ó‡∏∏‡∏ô (25%)</div><div class="tank-amount" id="val-growth">‡∏ø0</div>
                </div>
                <div class="tank-wrapper" onclick="openTankHistory('security', 'Security (‡∏™‡∏≥‡∏£‡∏≠‡∏á)')">
                    <div class="tank-bg"><div class="tank-fill fill-security" id="bar-security">0%</div></div>
                    <div class="tank-label">Security</div><div class="tank-sub" id="sub-security">‡∏™‡∏≥‡∏£‡∏≠‡∏á (50%)</div><div class="tank-amount" id="val-security">‡∏ø0</div>
                </div>
                <div class="tank-wrapper" onclick="openTankHistory('essential', 'Essential (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)')">
                    <div class="tank-bg"><div class="tank-fill fill-essential" id="bar-essential">0%</div></div>
                    <div class="tank-label">Essential</div><div class="tank-sub" id="sub-essential">‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (15%)</div><div class="tank-amount" id="val-essential">‡∏ø0</div>
                </div>
                <div class="tank-wrapper" onclick="openTankHistory('joy', 'Joy (‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï)')">
                    <div class="tank-bg"><div class="tank-fill fill-joy" id="bar-joy">0%</div></div>
                    <div class="tank-label">Joy</div><div class="tank-sub" id="sub-joy">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• (10%)</div><div class="tank-amount" id="val-joy">‡∏ø0</div>
                </div>
            </div>
            
            <div class="wishlist-btn" onclick="openModal('wishlistModal')" style="margin-top:15px; background:white; border:1px dashed #eab308;">
                ‚è≥ ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏î‡∏∂‡∏á‡∏™‡∏ï‡∏¥ (‡∏î‡∏≠‡∏á‡∏Å‡∏¥‡πÄ‡∏•‡∏™ 24 ‡∏ä‡∏°.) (<span id="wishlistCount">0</span>)
            </div>
        </div>

        <div class="quest-box">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4 style="margin:0; color:var(--espresso);">üìú ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏î‡∏±‡∏î‡∏ô‡∏¥‡∏™‡∏±‡∏¢</h4>
                <button class="btn-outline" style="border-color:#f59e0b; color:#d97706; padding:2px 8px; font-size:10px;" onclick="openModal('customQuestModal')">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå</button>
            </div>
            <p style="margin:2px 0 0 0; font-size:11px; color:#854d0e;">‡∏ó‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏° ‡πÅ‡∏•‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏à‡∏£‡∏¥‡∏á!</p>
            <div id="questList"></div>
        </div>

        <div class="card">
            <div class="card-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô <button class="btn-outline" onclick="toggleEditCat()" id="editCatBtn">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></div>
            <div class="categories-grid" id="homeCategories"></div>
            <button class="btn-main" style="background:#eab308; color:#854d0e; margin-top:15px; font-size:14px; box-shadow: 0 4px 10px rgba(234, 179, 8, 0.2);" onclick="openBulkEntry()">üìù Daily Dump (‡∏à‡∏î‡∏£‡∏ß‡∏ö‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏à‡∏ö!)</button>
        </div>
    </div>

    <div id="view-fixed" class="view-section">
        <div class="header"><h1>üìÖ ‡∏ö‡∏¥‡∏• & ‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</h1></div>
        
        <div class="card" style="background: #fdf2f8; border: 1px solid #fbcfe8;">
            <p style="margin:0; font-size:13px; color:var(--espresso);">‡∏†‡∏≤‡∏£‡∏∞‡∏ú‡∏π‡∏Å‡∏û‡∏±‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ <span id="fixedPctTxt" style="font-weight:bold; color:var(--danger);">0%</span></p>
            <div class="fixed-cost-bar"><div class="fixed-cost-fill" id="fixedPctBar"></div></div>
            <p style="margin:0; font-size:11px; color:var(--danger);">*‡∏ñ‡πâ‡∏≤‡∏†‡∏≤‡∏£‡∏∞‡∏ö‡∏¥‡∏•‡πÄ‡∏Å‡∏¥‡∏ô 15% ‡∏Ñ‡∏ß‡∏£‡∏´‡∏≤‡∏ó‡∏≤‡∏á‡∏•‡∏î‡∏•‡∏á‡∏ô‡∏∞‡∏ö‡∏≠‡∏™!</p>
        </div>

        <div class="card" id="creditBillCard" style="background: #eff6ff; border: 1px solid #bae6fd;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 class="card-title" style="color:#0369a1; font-size:16px; margin:0;">üí≥ ‡∏ö‡∏¥‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢</h2>
                <button class="btn-outline" style="padding:4px 8px; border-color:#0ea5e9; color:#0ea5e9; font-size:10px;" onclick="openLegacyDebtModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤</button>
            </div>
            <p style="font-size:11px; color:#0ea5e9; margin:5px 0 10px 0; line-height:1.4;">*‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÑ‡∏õ‡∏û‡∏±‡∏Å‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà Security ‡∏´‡∏≤‡∏Å‡πÑ‡∏õ‡∏à‡πà‡∏≤‡∏¢‡∏ö‡∏¥‡∏•‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏Å‡∏î "‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Security ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</p>
            <div id="creditBillList"></div>
        </div>

        <div class="card">
            <h2 class="card-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏•‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥</h2>
            <div id="fixedCostList"></div>
            <button class="btn-main" style="background:var(--gray-light); color:var(--espresso);" onclick="openAddFixedModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏¥‡∏•‡πÉ‡∏´‡∏°‡πà</button>
        </div>

        <div class="card" style="background: rgba(139, 171, 202, 0.1);">
            <h2 class="card-title" style="color:var(--bleu-porcelaine);">üéØ ‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏£‡∏≤‡∏¢‡∏õ‡∏µ (Sinking Funds)</h2>
            <p style="font-size:11px; color:var(--gray-text); margin-top:5px;">‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏ä‡πá‡∏≠‡∏ï!</p>
            <div id="yearlyFundList"></div>
            <button class="btn-main" style="background:var(--bleu-porcelaine); margin-top:10px;" onclick="openModal('addYearlyModal')">+ ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</button>
        </div>
    </div>

    <div id="view-debt" class="view-section">
        <div class="header"><h1>ü§ù ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô (‡πÄ‡∏á‡∏¥‡∏ô‡∏¢‡∏∑‡∏°)</h1></div>
        
        <div class="card" style="background: #fef2f2; border: 1px solid #fecaca; padding: 20px; text-align: center; margin-bottom: 15px;">
            <p style="margin:0; font-size:14px; color:#b91c1c; font-weight:bold;">‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ (‡∏¢‡∏∑‡∏°‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô)</p>
            <h2 style="margin:10px 0 0 0; font-size:36px; color:#991b1b;" id="totalLiabilityDisplay">‡∏ø0</h2>
        </div>

        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <button class="btn-main" style="flex:1; background: var(--danger); font-size:14px; padding:12px; margin-top:0;" onclick="openModal('addDebtModal')">üì• ‡∏¢‡∏∑‡∏°‡πÉ‡∏´‡∏°‡πà</button>
            <button class="btn-main" style="flex:1; background: var(--success); font-size:14px; padding:12px; margin-top:0;" onclick="openModal('payDebtModal')">üì§ ‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏µ‡πâ</button>
            <button class="btn-main" style="width:100%; background: #ea580c; font-size:14px; padding:12px; margin-top:0;" onclick="openLegacyBorrowedModal()">üìú + ‡∏´‡∏ô‡∏µ‡πâ‡∏¢‡∏∑‡∏°‡πÄ‡∏Å‡πà‡∏≤ (‡∏¢‡∏∑‡∏°‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡πÅ‡∏≠‡∏õ)</button>
        </div>
        
        <div class="card" style="margin-top:20px;">
            <h3 style="margin: 0 0 10px 0; font-size: 16px;">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ (‡∏¢‡∏∑‡∏°‡πÉ‡∏Ñ‡∏£‡πÄ‡∏¢‡∏≠‡∏∞‡∏™‡∏∏‡∏î?)</h3>
            <div class="chart-container" style="height: 180px;"><canvas id="debtChart"></canvas></div>
        </div>

        <h3 style="font-size: 16px;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡∏µ‡πâ</h3>
        <ul id="debtLogList" style="list-style: none; padding: 0; margin: 0;"></ul>
        
        <div class="card" style="margin-top:20px; background:#fff7ed; border:1px solid #fcd34d;">
            <h3 style="margin: 0 0 5px 0; font-size: 16px; color:#d97706;">üí∏ ‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏°‡∏∏‡∏ô / ‡∏£‡∏≠‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå (‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô)</h3>
            <p style="font-size:11px; color:#b45309; margin-top:0;">*‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏´‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ô‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ö‡∏≠‡∏™ (‡∏£‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô)</p>
            <ul id="receivableList" style="list-style: none; padding: 0; margin: 0;"></ul>
        </div>
    </div>

    <div id="view-analytics" class="view-section">
        <div class="header"><h1>üìä ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û & ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h1></div>

        <div class="card" style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); border: 1px solid #86efac; text-align: center; margin-bottom: 20px;">
            <h3 style="margin:0 0 5px 0; font-size:14px; color:#166534;">üíº ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤)</h3>
            <h2 style="margin:0; font-size:28px; color:#15803d;" id="totalWealthText">‡∏ø0</h2>
            <p style="margin:5px 0 0 0; font-size:12px; color:#166534;" id="wealthCompareText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...</p>
        </div>

        <div class="summary-dashboard">
            <div class="sum-box">
                <p class="sum-title">üì• ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏° (In)</p>
                <p class="sum-val val-in" id="sumIncomeText">‡∏ø0</p>
            </div>
            <div class="sum-box">
                <p class="sum-title">üì§ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏° (Out)</p>
                <p class="sum-val val-out" id="sumExpenseText">‡∏ø0</p>
            </div>
            <div class="sum-box full-width">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <p class="sum-title" style="margin:0;">üí∞ ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Net)</p>
                    <p style="margin:0; font-size:11px;" id="sumPctText">‡πÉ‡∏ä‡πâ‡πÑ‡∏õ 0% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</p>
                </div>
                <p class="sum-val" id="sumNetText" style="text-align:left;">‡∏ø0</p>
            </div>
        </div>
        
        <div class="card" style="text-align:center;">
            <p style="margin:0 0 10px 0; font-size:13px; color:var(--gray-text);">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            <div id="healthBadge" class="health-badge">üöÄ ‡πÄ‡∏•‡πÄ‡∏ß‡∏• 5: ‡∏°‡∏±‡πà‡∏á‡∏Ñ‡∏±‡πà‡∏á‡∏≠‡∏¥‡∏™‡∏£‡∏∞</div>
            <p id="healthDesc" style="margin:5px 0 0 0; font-size:13px; font-weight:500;"></p>
        </div>

        <div style="display:flex; gap:5px; margin-bottom: 10px;">
            <button class="btn-outline" style="flex:1; border-color:#cbd5e1; background:white; font-size:12px; padding:8px 0;" id="btnAnalyticWeek" onclick="renderAnalyticsChart('week')">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</button>
            <button class="btn-outline" style="flex:1; border-color:#cbd5e1; background:white; font-size:12px; padding:8px 0;" id="btnAnalyticMonth" onclick="renderAnalyticsChart('month')">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
            <button class="btn-outline" style="flex:1; border-color:#cbd5e1; background:white; font-size:12px; padding:8px 0;" id="btnAnalyticQuarter" onclick="renderAnalyticsChart('quarter')">‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™</button>
            <button class="btn-outline" style="flex:1; border-color:#cbd5e1; background:white; font-size:12px; padding:8px 0;" id="btnAnalyticYear" onclick="renderAnalyticsChart('year')">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</button>
        </div>

        <div class="card">
            <div class="chart-container" style="height:250px;"><canvas id="analyticsChart"></canvas></div>
            <p id="noDataText" style="text-align:center; display:none; color:var(--gray-text);">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
        </div>

        <div id="idealSalaryBox" class="ideal-salary-box">
            <h3 style="margin:0 0 5px 0; color:#166534; font-size:16px;">üí° ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</h3>
            <p style="margin:0; font-size:12px; color:#15803d;">‡∏à‡∏≤‡∏Å‡πÑ‡∏•‡∏ü‡πå‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÑ‡∏î‡πâ‡∏ä‡∏¥‡∏•‡πÜ ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô (E+J = <span id="idealPctShow">0</span>%) ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö:</p>
            <h2 style="margin:10px 0; font-size:28px; color:#166534; text-align:center;" id="idealSalaryTxt">‡∏ø0 <span style="font-size:14px;">/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span></h2>
            <p style="margin:0; font-size:11px; color:#166534;">*‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ √∑ ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏ö‡∏Å‡∏¥‡∏ô‡πÉ‡∏ä‡πâ</p>
        </div>

        <div class="card" style="background: rgba(139, 171, 202, 0.1);">
            <h3 style="margin:0 0 10px 0; font-size: 16px; color:var(--bleu-porcelaine);">üîç ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å (Insights)</h3>
            
            <div class="data-insight-box">
                <p style="margin:0; font-size:12px; color:var(--gray-text);">üõí ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô Joy (‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï)</p>
                <div style="display:flex; justify-content:space-between; margin-top:5px;">
                    <span style="font-weight:bold; color:var(--terre-cuite);">‚ú® <span id="insightSmallWin">‡∏Å‡∏¥‡∏ô‡∏á‡∏ö‡πÑ‡∏õ 0%</span></span>
                    <span style="font-weight:bold; color:var(--bleu-porcelaine);">üéØ <span id="insightBigWin">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ 100%</span></span>
                </div>
            </div>

            <div class="data-insight-box" style="border-left-color: var(--eau-trouble);">
                <p style="margin:0; font-size:12px; color:var(--gray-text);">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>
                <h4 style="margin:5px 0 0 0; color:var(--espresso);">‡∏ß‡∏±‡∏ô<span id="insightDay">-</span></h4>
            </div>

            <div class="data-insight-box" style="border-left-color: var(--danger);">
                <p style="margin:0; font-size:12px; color:var(--gray-text);">‚ö†Ô∏è ‡πÅ‡∏´‡∏Å‡∏Å‡∏é‡∏î‡∏∂‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏°‡∏ñ‡∏±‡∏á</p>
                <h4 style="margin:5px 0 0 0; color:var(--danger);"><span id="insightCrossCount">0</span> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á <span style="font-size:12px; font-weight:normal; color:var(--espresso);">(‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏´‡∏•‡∏±‡∏Å: <span id="insightCrossReason">-</span>)</span></h4>
            </div>

            <div class="data-insight-box" style="border-left-color: var(--success);">
                <p style="margin:0; font-size:12px; color:var(--gray-text);">üõ°Ô∏è ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏î‡∏∂‡∏á‡∏™‡∏ï‡∏¥ (24H Rule)</p>
                <h4 style="margin:5px 0 0 0; color:var(--success);">‡∏£‡∏≠‡∏î‡πÑ‡∏õ ‡∏ø<span id="insightSavedTemptation">0</span></h4>
                <p style="margin:2px 0 0 0; font-size:11px; color:var(--espresso);">
                    ‡∏ä‡∏ô‡∏∞‡πÉ‡∏à‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á: <span id="insightWinTemptCount" style="color:var(--success); font-weight:bold;">0</span> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á | 
                    ‡πÅ‡∏û‡πâ‡∏Å‡∏¥‡πÄ‡∏•‡∏™: <span id="insightLoseTemptCount" style="color:var(--danger); font-weight:bold;">0</span> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                </p>
            </div>

            <div class="data-insight-box" style="border-left-color: #8b5cf6;">
                <p style="margin:0; font-size:12px; color:var(--gray-text);">üîÆ ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏â‡∏±‡∏ô‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï (‡∏´‡∏ô‡∏µ‡πâ‡∏ö‡∏±‡∏ï‡∏£/‡∏ú‡πà‡∏≠‡∏ô)</p>
                <h4 style="margin:5px 0 0 0; color:#8b5cf6;">‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏ö‡∏¥‡∏•‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢ ‡∏ø<span id="insightFutureMoney">0</span></h4>
                <p style="margin:2px 0 0 0; font-size:11px; color:var(--espresso);" id="insightFutureAdvice"></p>
            </div>
        </div>

        <div class="ai-advisor">
            <h4 style="margin:0 0 5px 0; color:var(--bleu-porcelaine); display:flex; align-items:center; gap:5px;">üëî ‡πÄ‡∏•‡∏Ç‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h4>
            <p id="aiAdviceText" style="margin:0; line-height:1.5;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>
    </div>

    <div id="view-cashflow" class="view-section">
        <div class="header"><h1>üåä ‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î (Cash Flow)</h1></div>
        <div class="card" style="background: white; border: 1px solid var(--bleu-porcelaine);">
            <p style="font-size:12px; color:var(--gray-text); margin-top:0;">‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏Ç‡∏≠‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö -> ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÜ -> ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á)</p>
            <div id="sankey_basic" style="width: 100%; height: 450px; display: flex; justify-content: center; align-items: center; overflow-x: auto;">
                <p style="color:#888;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏≤‡∏ü...</p>
            </div>
            <p style="font-size:10px; color:var(--danger); margin-bottom:0; text-align:right;">*‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ô‡∏¥‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏ß‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÑ‡∏î‡πâ</p>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('view-home', this)"><div class="nav-icon">üè†</div>‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</div>
        <div class="nav-item" onclick="switchTab('view-fixed', this)"><div class="nav-icon">üìÖ</div>‡∏ö‡∏¥‡∏•/‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</div>
        <div class="nav-item" onclick="switchTab('view-debt', this); renderDebtChart();"><div class="nav-icon">ü§ù</div>‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô</div>
        <div class="nav-item" onclick="switchTab('view-analytics', this); evaluateHealth(); renderAnalyticsChart('week');"><div class="nav-icon">üìä</div>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
        <div class="nav-item" onclick="switchTab('view-cashflow', this); drawSankey();"><div class="nav-icon">üåä</div>‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô</div>
    </nav>
</div> 

<div class="modal-overlay" id="addIncomeCatModal">
    <div class="modal-content">
        <div class="modal-header"><h2>‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</h2><button class="close-btn" onclick="closeModal('addIncomeCatModal'); renderIncomeCats();">‚úï</button></div>
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (‡∏™‡∏±‡πâ‡∏ô‡πÜ)</label><input type="text" id="newIncCatName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏±‡∏ô‡∏ú‡∏•"></div>
        <div class="form-group"><label>‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥ 1 ‡∏ï‡∏±‡∏ß</label><input type="text" id="newIncCatIcon" placeholder="üìà" maxlength="2"></div>
        <button class="btn-main" onclick="saveIncomeCategory()">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</button>
    </div>
</div>

<div class="modal-overlay" id="bulkEntryModal">
    <div class="modal-content">
        <div class="modal-header"><h2>üìù Daily Dump</h2><button class="close-btn" onclick="closeModal('bulkEntryModal')">‚úï</button></div>
        <p style="font-size:12px; color:var(--gray-text); margin-top:-10px;">‡∏Ç‡∏µ‡πâ‡πÄ‡∏Å‡∏µ‡∏¢‡∏à‡∏à‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ß‡∏±‡∏ô? ‡∏°‡∏≤‡∏à‡∏î‡∏£‡∏ß‡∏ö‡∏¢‡∏≠‡∏î‡∏ï‡∏≠‡∏ô‡πÄ‡∏¢‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏•‡∏¢! (‡∏£‡∏±‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™ +15 ‡πÅ‡∏ï‡πâ‡∏°)</p>
        
        <div style="margin-bottom: 10px; display:flex; align-items:center; gap:10px; background:#e0f2fe; padding:10px; border-radius:10px;">
            <label style="font-size:13px; color:#0369a1; font-weight:bold;">‡∏à‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
            <input type="date" id="bulkEntryDate" style="flex:1; border:1px solid #bae6fd; padding:5px 10px; border-radius:8px; outline:none; font-family:'Kanit';">
        </div>

        <div id="bulkRows" style="max-height: 50vh; overflow-y: auto; margin-bottom:15px; padding-right:5px;"></div>
        <button class="btn-outline" style="width:100%; border-style:dashed; margin-bottom:10px;" onclick="addBulkRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡∏Å 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        <button class="btn-main" style="background:var(--success);" onclick="submitBulkEntry()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
    </div>
</div>

<div class="modal-overlay" id="rewardShopModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üõí ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</h2>
            <button class="close-btn" onclick="closeModal('rewardShopModal')">‚úï</button>
        </div>
        <p style="text-align:center; font-size:14px; margin-top:-10px;">‡πÅ‡∏ï‡πâ‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: <strong style="color:#854d0e; font-size:18px;" id="shopPointsDisplay">0</strong></p>
        
        <div style="max-height: 250px; overflow-y:auto; padding-right:5px;">
            <div class="reward-item"><div class="reward-info"><h4 style="color:var(--bleu-porcelaine);">üéüÔ∏è ‡πÇ‡∏≠‡∏ô Essential ‡πÄ‡∏Ç‡πâ‡∏≤ Joy 500‡∏ø</h4><p>‡∏î‡∏∂‡∏á‡πÄ‡∏á‡∏¥‡∏ô 500‡∏ø ‡∏à‡∏≤‡∏Å E ‡∏°‡∏≤‡∏™‡∏°‡∏ó‡∏ö‡∏ó‡∏∏‡∏ô Big Win ‡πÅ‡∏ö‡∏ö‡∏ñ‡∏π‡∏Å‡∏Å‡∏é</p></div><button class="btn-outline" style="border-color:#eab308; color:#854d0e;" onclick="buyReward('üéüÔ∏è ‡πÇ‡∏≠‡∏ô Essential ‡πÄ‡∏Ç‡πâ‡∏≤ Joy 500‡∏ø', 1500)">1500 ‡πÅ‡∏ï‡πâ‡∏°</button></div>
            
            <div class="reward-item"><div class="reward-info"><h4 style="color:var(--danger);">üßº ‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏≤‡∏õ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h4><p>‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ "‡πÅ‡∏´‡∏Å‡∏Å‡∏é‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏ñ‡∏±‡∏á" 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß</p></div><button class="btn-outline" style="border-color:#eab308; color:#854d0e;" onclick="buyReward('üßº ‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏≤‡∏õ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥', 1000)">1000 ‡πÅ‡∏ï‡πâ‡∏°</button></div>
            
            <div class="reward-item"><div class="reward-info"><h4 style="color:var(--terre-cuite);">üç∞ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡πÑ‡∏£‡πâ‡∏™‡∏≤‡∏£‡∏∞ 1 ‡∏ä‡∏¥‡πâ‡∏ô</h4><p>‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô Essential ‡∏£‡∏π‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏ü‡∏∏‡πà‡∏°‡πÄ‡∏ü‡∏∑‡∏≠‡∏¢‡πÑ‡∏î‡πâ 1 ‡∏ä‡∏¥‡πâ‡∏ô‡πÇ‡∏î‡∏¢ AI ‡πÑ‡∏°‡πà‡∏î‡πà‡∏≤!</p></div><button class="btn-outline" style="border-color:#eab308; color:#854d0e;" onclick="buyReward('üç∞ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡πÑ‡∏£‡πâ‡∏™‡∏≤‡∏£‡∏∞ 1 ‡∏ä‡∏¥‡πâ‡∏ô', 800)">800 ‡πÅ‡∏ï‡πâ‡∏°</button></div>
            
            <div class="reward-item"><div class="reward-info"><h4 style="color:#8b5cf6;">ü§ù ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏ô‡∏£‡∏≠‡∏ö‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏õ‡∏¢‡πå</h4><p>‡πÄ‡∏≠‡∏≤‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÇ‡∏ä‡∏ß‡πå‡πÅ‡∏ü‡∏ô/‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏Ç‡πâ‡∏≤‡∏ß 1 ‡∏°‡∏∑‡πâ‡∏≠!</p></div><button class="btn-outline" style="border-color:#eab308; color:#854d0e;" onclick="buyReward('ü§ù ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏ô‡∏£‡∏≠‡∏ö‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏õ‡∏¢‡πå', 2000)">2000 ‡πÅ‡∏ï‡πâ‡∏°</button></div>

            <div class="reward-item"><div class="reward-info"><h4 style="color:#0284c7;">üöó ‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô‡∏ü‡∏£‡∏µ 1 ‡∏ß‡∏±‡∏ô</h4><p>‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏ü‡∏ü‡∏¥‡∏®‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏ñ/‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ‡πÑ‡∏õ‡∏™‡πà‡∏á‡πÅ‡∏ó‡∏ô!</p></div><button class="btn-outline" style="border-color:#eab308; color:#854d0e;" onclick="buyReward('üöó ‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô‡∏ü‡∏£‡∏µ 1 ‡∏ß‡∏±‡∏ô (‡∏°‡∏µ‡∏Ñ‡∏ô‡πÄ‡∏õ‡∏¢‡πå)', 1200)">1200 ‡πÅ‡∏ï‡πâ‡∏°</button></div>
            
            <div class="reward-item"><div class="reward-info"><h4 style="color:#e11d48;">üé¨ ‡∏ö‡∏±‡∏ï‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≤‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡∏±‡∏á</h4><p>‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏â‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏á! ‡∏Ñ‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡πÜ ‡∏´‡πâ‡∏≤‡∏°‡∏ö‡πà‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á!</p></div><button class="btn-outline" style="border-color:#eab308; color:#854d0e;" onclick="buyReward('üé¨ ‡∏ö‡∏±‡∏ï‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≤‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡∏±‡∏á/‡∏ã‡∏µ‡∏£‡∏µ‡∏™‡πå', 500)">500 ‡πÅ‡∏ï‡πâ‡∏°</button></div>
            
            <div class="reward-item"><div class="reward-info"><h4 style="color:#ea580c;">üí¨ ‡∏ö‡∏±‡∏ï‡∏£‡∏ö‡πà‡∏ô (‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡∏±‡∏î) 10 ‡∏ô‡∏≤‡∏ó‡∏µ</h4><p>‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô/‡∏ô‡πâ‡∏≠‡∏á/‡πÅ‡∏ü‡∏ô ‡∏ô‡∏±‡πà‡∏á‡∏ü‡∏±‡∏á‡πÄ‡∏£‡∏≤‡∏ö‡πà‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏ñ‡∏µ‡∏¢‡∏á</p></div><button class="btn-outline" style="border-color:#eab308; color:#854d0e;" onclick="buyReward('üí¨ ‡∏ö‡∏±‡∏ï‡∏£‡∏ö‡πà‡∏ô (‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡∏±‡∏î) 10 ‡∏ô‡∏≤‡∏ó‡∏µ', 300)">300 ‡πÅ‡∏ï‡πâ‡∏°</button></div>

            <div class="reward-item"><div class="reward-info"><h4 style="color:#10b981;">üßã ‡∏ö‡∏±‡∏ï‡∏£‡∏ú‡πà‡∏≤‡∏ô‡∏ä‡∏≤‡∏ô‡∏° (‡∏ô‡∏≠‡∏Å‡∏£‡∏≠‡∏ö)</h4><p>‡∏Å‡∏¥‡∏ô‡∏ä‡∏≤‡∏ô‡∏°/‡∏ô‡πâ‡∏≥‡∏ä‡∏á‡πÑ‡∏î‡πâ 1 ‡πÅ‡∏Å‡πâ‡∏ß ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏î‡∏•‡∏á‡πÅ‡∏≠‡∏õ!</p></div><button class="btn-outline" style="border-color:#eab308; color:#854d0e;" onclick="buyReward('üßã ‡∏ö‡∏±‡∏ï‡∏£‡∏ú‡πà‡∏≤‡∏ô‡∏ä‡∏≤‡∏ô‡∏° (‡∏ô‡∏≠‡∏Å‡∏£‡∏≠‡∏ö)', 600)">600 ‡πÅ‡∏ï‡πâ‡∏°</button></div>
            
            <div class="reward-item"><div class="reward-info"><h4 style="color:var(--gray-text);">üò¥ ‡∏ö‡∏±‡∏ï‡∏£‡∏ß‡∏±‡∏ô‡∏Ç‡∏µ‡πâ‡πÄ‡∏Å‡∏µ‡∏¢‡∏à</h4><p>‡πÉ‡∏ä‡πâ‡∏≠‡∏π‡πâ‡∏á‡∏≤‡∏ô ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏•‡∏¢ 1 ‡∏ß‡∏±‡∏ô‡πÄ‡∏ï‡πá‡∏°‡πÜ</p></div><button class="btn-outline" style="border-color:#eab308; color:#854d0e;" onclick="buyReward('üò¥ ‡∏ö‡∏±‡∏ï‡∏£‡∏ß‡∏±‡∏ô‡∏Ç‡∏µ‡πâ‡πÄ‡∏Å‡∏µ‡∏¢‡∏à', 1500)">1500 ‡πÅ‡∏ï‡πâ‡∏°</button></div>
        </div>
        
        <h4 style="margin:15px 0 10px 0;">üéí ‡∏Ñ‡∏•‡∏±‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h4>
        <div id="inventoryList" style="font-size:13px; color:var(--gray-text);"></div>
    </div>
</div>

<div class="modal-overlay" id="configModal">
    <div class="modal-content">
        <div class="modal-header"><h2>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå & %</h2><button class="close-btn" onclick="closeModal('configModal')">‚úï</button></div>
        <div style="display:flex; gap:10px;">
            <div class="form-group" style="flex:1;"><label>‡∏ä‡∏∑‡πà‡∏≠</label><input type="text" id="userNameInput"></div>
            <div class="form-group" style="flex:1;"><label>‡∏≠‡∏≤‡∏¢‡∏∏</label><input type="number" id="userAgeInput" placeholder="‡∏ã‡πà‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å"></div>
        </div>
        <p style="font-size:12px; color:var(--gray-text); margin-top:5px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Preset ‡πÉ‡∏´‡πâ AI ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏¥‡∏î‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤</p>
        <div class="preset-grid">
            <div class="preset-btn" onclick="applyPreset(25,50,15,10)">‚öñÔ∏è ‡∏™‡∏°‡∏î‡∏∏‡∏•<br>(25-50-15-10)</div>
            <div class="preset-btn" onclick="applyPreset(40,35,15,10)">üöÄ ‡∏•‡∏á‡∏ó‡∏∏‡∏ô<br>(40-35-15-10)</div>
            <div class="preset-btn" onclick="applyPreset(10,60,20,10)">üõ°Ô∏è ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏´‡∏ô‡∏µ‡πâ<br>(10-60-20-10)</div>
        </div>
        <div style="display:flex; gap:10px;">
            <div class="form-group"><label>Growth</label><input type="number" id="cfgG"></div><div class="form-group"><label>Security</label><input type="number" id="cfgS"></div>
        </div>
        <div style="display:flex; gap:10px;">
            <div class="form-group"><label>Essential</label><input type="number" id="cfgE"></div><div class="form-group"><label>Joy</label><input type="number" id="cfgJ"></div>
        </div>
        <button class="btn-main" onclick="saveConfig()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô</button>

        <p style="font-size:13px; color:var(--espresso); margin-top:20px; font-weight:bold; border-top:1px dashed #ccc; padding-top:15px;">üí∞ ‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô (‡∏¢‡∏∂‡∏î‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏à‡∏£‡∏¥‡∏á)</p>
        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <div class="form-group" style="flex:1; margin-bottom:0;"><label style="color:var(--bleu-porcelaine);">Growth</label><input type="number" id="initG"></div>
            <div class="form-group" style="flex:1; margin-bottom:0;"><label style="color:var(--miel-dore);">Security</label><input type="number" id="initS"></div>
        </div>
        <div style="display:flex; gap:10px;">
            <div class="form-group" style="flex:1; margin-bottom:0;"><label style="color:var(--terre-cuite);">Essential</label><input type="number" id="initE"></div>
            <div class="form-group" style="flex:1; margin-bottom:0;"><label style="color:var(--eau-trouble);">Joy</label><input type="number" id="initJ"></div>
        </div>
        <button class="btn-outline" style="width:100%; margin-top:10px; border-color:#0284c7; color:#0284c7; background:#f0f9ff;" onclick="applyInitialBalances()">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô</button>

        <button class="btn-outline" style="width:100%; border-color:var(--danger); color:var(--danger); margin-top:20px;" onclick="clearData()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>
</div>

<div class="modal-overlay" id="customQuestModal">
    <div class="modal-content">
        <div class="modal-header"><h2>‚ú® ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á</h2><button class="close-btn" onclick="closeModal('customQuestModal')">‚úï</button></div>
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏ó‡∏≥</label><input type="text" id="cqName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ 1 ‡∏ö‡∏ó"></div>
        <div class="form-group"><label>‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÅ‡∏ï‡πâ‡∏° (‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)</label><input type="number" id="cqPts" placeholder="‡πÄ‡∏ä‡πà‡∏ô 50"></div>
        <button class="btn-main" onclick="addCustomQuest()">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏•‡∏∏‡∏¢!</button>
    </div>
</div>

<div class="modal-overlay" id="wishlistModal">
    <div class="modal-content">
        <div class="modal-header"><h2>‚è≥ ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏î‡∏∂‡∏á‡∏™‡∏ï‡∏¥</h2><button class="close-btn" onclick="closeModal('wishlistModal')">‚úï</button></div>
        <p style="font-size:12px; color:var(--gray-text); margin-top:-10px;">‡∏£‡∏≠‡∏Ñ‡∏£‡∏ö 24 ‡∏ä‡∏°. ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ (‡∏Å‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏±‡∏ö +10 ‡πÅ‡∏ï‡πâ‡∏°!)</p>
        <div id="wishlistContainer"></div>
    </div>
</div>

<div class="modal-overlay" id="addCatModal">
    <div class="modal-content">
        <div class="modal-header"><h2>‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà</h2><button class="close-btn" onclick="closeModal('addCatModal')">‚úï</button></div>
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î (‡∏™‡∏±‡πâ‡∏ô‡πÜ)</label><input type="text" id="newCatName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡πÅ‡∏ü"></div>
        <div class="form-group"><label>‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥ 1 ‡∏ï‡∏±‡∏ß</label><input type="text" id="newCatIcon" placeholder="‚òï" maxlength="2"></div>
        <div class="form-group">
            <label>‡∏´‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
            <select id="newCatTank"><option value="essential">Essential (‡∏Ñ‡πà‡∏≤‡∏Å‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà)</option><option value="joy">Joy (‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï/Small Win)</option><option value="security">Security (‡∏™‡∏≥‡∏£‡∏≠‡∏á/‡∏ö‡∏¥‡∏•)</option></select>
        </div>
        <p style="font-size:11px; color:var(--eau-trouble);">*‡∏ó‡∏£‡∏¥‡∏Ñ: ‡∏Å‡∏≤‡πÅ‡∏ü‡πÅ‡∏Å‡πâ‡∏á‡πà‡∏ß‡∏á = Essential, ‡∏Å‡∏≤‡πÅ‡∏ü‡∏™‡∏≤‡∏¢‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà‡∏ä‡∏¥‡∏•‡πÜ = Joy ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö!</p>
        <button class="btn-main" onclick="saveNewCategory()">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°</button>
    </div>
</div>

<div class="modal-overlay" id="addFixedModal">
    <div class="modal-content">
        <div class="modal-header"><h2>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏¥‡∏•/‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</h2><button class="close-btn" onclick="closeModal('addFixedModal')">‚úï</button></div>
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏õ/‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label><input type="text" id="fcName" placeholder="‡πÄ‡∏ä‡πà‡∏ô Netflix, ‡∏ú‡πà‡∏≠‡∏ô‡∏£‡∏ñ, ‡∏ö‡πâ‡∏≤‡∏ô"></div>
        <div class="form-group"><label>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (‡∏ø)</label><input type="number" id="fcAmount"></div>
        <div class="form-group"><label>‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥</label><input type="text" id="fcIcon" placeholder="üßæ" maxlength="2"></div>
        <div class="form-group"><label>‡πÉ‡∏´‡πâ‡∏´‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÑ‡∏´‡∏ô?</label><select id="fcTank"><option value="essential">Essential (‡∏ô‡πâ‡∏≥, ‡πÑ‡∏ü)</option><option value="joy">Joy (‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á)</option><option value="security">Security (‡∏´‡∏ô‡∏µ‡πâ/‡∏ú‡πà‡∏≠‡∏ô)</option></select></div>
        
        <div class="form-group" style="margin-top:10px;">
            <label style="color:#0369a1; display:flex; align-items:center; gap:5px; cursor:pointer;">
                <input type="checkbox" id="fcIsInst" onchange="document.getElementById('fcInstDiv').style.display = this.checked ? 'flex' : 'none';" style="width:auto; accent-color:#0369a1;"> ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞ (‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏à‡∏ö)
            </label>
        </div>
        <div class="form-group" id="fcInstDiv" style="display:none; gap:10px; background:#e0f2fe; padding:15px; border-radius:10px; border:1px dashed #7dd3fc;">
            <div style="flex:1;"><label style="color:#0284c7;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label><input type="number" id="fcTotalM" placeholder="‡πÄ‡∏ä‡πà‡∏ô 60"></div>
            <div style="flex:1;"><label style="color:#0284c7;">‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß (‡∏á‡∏ß‡∏î)</label><input type="number" id="fcPaidM" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2"></div>
        </div>

        <button class="btn-main" onclick="saveFixedCost()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
</div>

<div class="modal-overlay" id="addYearlyModal">
    <div class="modal-content">
        <div class="modal-header"><h2>üéØ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</h2><button class="close-btn" onclick="closeModal('addYearlyModal')">‚úï</button></div>
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏ñ, ‡∏†‡∏≤‡∏©‡∏µ)</label><input type="text" id="yName"></div>
        <div class="form-group"><label>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏õ‡∏µ (‡∏ø)</label><input type="number" id="yAmount"></div>
        <button class="btn-main" onclick="saveYearlyFund()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
</div>

<div class="modal-overlay" id="expenseModal">
    <div class="modal-content">
        <div class="modal-header"><h2 id="expenseTitle">‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô</h2><button class="close-btn" onclick="closeModal('expenseModal')">‚úï</button></div>
        <div class="form-group"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ø)</label><input type="number" id="exAmount" placeholder="0" oninput="checkExpenseLogic()"></div>
        <div class="form-group">
            <label>‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏´‡∏•‡∏±‡∏Å (‡∏î‡∏∂‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å)</label>
            <select id="exTank" onchange="checkExpenseLogic()">
                <option value="essential">Essential (‡∏Ñ‡πà‡∏≤‡∏Å‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà/‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)</option>
                <option value="joy">Joy (‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•/‡∏™‡∏±‡∏á‡∏Ñ‡∏°)</option>
                <option value="security">Security (‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á)</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>üí≥ ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô</label>
            <select id="exPayMethod" onchange="toggleInstallmentInput()">
                <option value="‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢/‡πÇ‡∏≠‡∏ô">üì± ‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢ / ‡πÇ‡∏≠‡∏ô</option>
                <option value="‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
                <option value="‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï">üí≥ ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï (‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</option>
                <option value="‡∏ú‡πà‡∏≠‡∏ô (BNPL)">üõçÔ∏è ‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞ (SPayLater/Atome)</option>
            </select>
        </div>

        <div class="form-group" id="installmentDiv" style="display:none; background:#eff6ff; padding:10px; border-radius:10px; border: 1px dashed #bae6fd;">
            <label style="color:#0284c7;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≠‡∏ô</label>
            <input type="number" id="exInstallmentMonths" placeholder="‡πÄ‡∏ä‡πà‡∏ô 3" style="margin-top:5px;">
        </div>

        <div class="form-group" id="joyTypeDiv" style="display:none; background:#f8fafc; padding:10px; border-radius:10px; margin-bottom:15px;">
            <div class="form-group" style="margin-bottom:10px;">
                <label style="color:var(--bleu-porcelaine);">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</label>
                <select id="exJoyType"><option value="small">‚ú® Small Win (‡∏à‡∏∏‡∏Å‡∏à‡∏¥‡∏Å ‡∏Å‡∏¥‡∏ô‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)</option><option value="big">üéØ Big Win (‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ‡∏Ç‡∏≠‡∏á‡∏ä‡∏¥‡πâ‡∏ô‡πÉ‡∏´‡∏ç‡πà)</option></select>
            </div>
            <div class="form-group" style="margin-bottom:0;">
                <label style="color:#854d0e;">üé≠ ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏ï‡∏≠‡∏ô‡∏ã‡∏∑‡πâ‡∏≠ (‡∏à‡∏î‡πÑ‡∏ß‡πâ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ï‡∏¥)</label>
                <select id="exEmotion">
                    <option value="ü§© ‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á">ü§© ‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á</option>
                    <option value="üò© ‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡πÄ‡∏•‡∏¢‡∏ä‡πâ‡∏≠‡∏õ">üò© ‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡πÄ‡∏•‡∏¢‡∏ä‡πâ‡∏≠‡∏õ (‡∏ä‡πâ‡∏≠‡∏õ‡∏ö‡∏≥‡∏ö‡∏±‡∏î)</option>
                    <option value="üßü‚Äç‚ôÇÔ∏è ‡πÇ‡∏î‡∏ô‡∏õ‡πâ‡∏≤‡∏¢‡∏¢‡∏≤">üßü‚Äç‚ôÇÔ∏è ‡πÇ‡∏î‡∏ô‡∏õ‡πâ‡∏≤‡∏¢‡∏¢‡∏≤ (‡∏ï‡∏≤‡∏°‡πÄ‡∏ó‡∏£‡∏ô‡∏î‡πå)</option>
                    <option value="üçª ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏°">üçª ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏° (‡πÄ‡∏õ‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô)</option>
                </select>
            </div>
        </div>

        <div class="form-group" id="needDiv" style="display:none; background:#e0f2fe; padding:10px; border-radius:10px; border: 1px dashed #7dd3fc; margin-bottom:15px;">
            <label style="color:#0369a1;">‚öñÔ∏è ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (‡∏´‡πâ‡∏≤‡∏°‡∏´‡∏•‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á!)</label>
            <select id="exNeedRating">
                <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (‡∏Ç‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏Ñ‡∏≠‡∏Ç‡∏≤‡∏î‡∏ö‡∏≤‡∏î‡∏ï‡∏≤‡∏¢)</option>
                <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏Å ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)</option>
                <option value="3">‚≠ê‚≠ê‚≠ê (‡∏Å‡∏∂‡πà‡∏á‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô ‡∏Å‡∏∂‡πà‡∏á‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ)</option>
                <option value="2">‚≠ê‚≠ê (‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô ‡πÅ‡∏Ñ‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å)</option>
                <option value="1">‚≠ê (‡∏£‡∏π‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏Å‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÅ‡∏Ñ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ ü§£)</option>
            </select>
        </div>

        <div class="form-group" style="background:#fef3c7; padding:10px; border-radius:10px; border:1px dashed #f59e0b; margin-bottom:15px;">
            <label style="color:#d97706; display:flex; align-items:center; gap:5px; margin-bottom:0; cursor:pointer;">
                <input type="checkbox" id="isReimbursable" onchange="document.getElementById('reimbursableDiv').style.display = this.checked ? 'block' : 'none';" style="width:auto; accent-color:#d97706;"> ‡∏°‡∏µ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô (‡∏´‡∏≤‡∏£‡∏ö‡∏¥‡∏•/‡∏£‡∏≠‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå)
            </label>
            <div id="reimbursableDiv" style="display:none; margin-top:10px;">
                <input type="number" id="exReimbursableAmt" placeholder="‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô (‡∏ø)" style="margin-bottom:5px;">
                <input type="text" id="exLendTo" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏¢‡∏∑‡∏°/‡πÅ‡∏Å‡πä‡∏á‡∏Ñ‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏ï‡πä‡∏∞‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏∞)">
            </div>
        </div>

        <div class="form-group"><label>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label><input type="text" id="exNote" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..."></div>
        
        <div class="cross-tank-box" id="crossTankBox" style="background:#fee2e2; border-color:#f87171;">
            <p style="color:var(--danger); font-weight:bold; margin-top:0;">‚ö†Ô∏è ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠! ‡∏Ç‡∏≤‡∏î‡∏≠‡∏µ‡∏Å <span id="shortfallText">‡∏ø0</span></p>
            <div class="form-group">
                <label>‡∏î‡∏∂‡∏á‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏°‡∏≤‡πÇ‡∏õ‡∏∞‡∏à‡πà‡∏≤‡∏¢:</label>
                <select id="backupTank"></select>
            </div>
            <div class="form-group" style="margin-bottom:0;">
                <label style="color:var(--espresso);">‡∏™‡∏≤‡∏£‡∏†‡∏≤‡∏û‡∏°‡∏≤‡∏ö‡∏≠‡∏™! ‡∏ó‡∏≥‡πÑ‡∏°‡∏ñ‡∏∂‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏á‡∏ö?</label>
                <select id="crossReason">
                    <option value="‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÜ">üö® ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∂‡∏á‡∏ô‡∏∞‡∏ö‡∏≠‡∏™)</option>
                    <option value="‡πÅ‡∏û‡πâ‡∏Å‡∏¥‡πÄ‡∏•‡∏™">üòà ‡πÅ‡∏û‡πâ‡∏Å‡∏¥‡πÄ‡∏•‡∏™‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á (‡∏ï‡∏µ‡∏°‡∏∑‡∏≠!)</option>
                    <option value="‡∏•‡∏∑‡∏°‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô">üòÖ ‡∏•‡∏∑‡∏°‡∏Ñ‡∏¥‡∏î (‡∏Ñ‡∏£‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏≠‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞‡∏ö‡∏≠‡∏™)</option>
                </select>
            </div>
        </div>

        <button class="btn-main" onclick="submitExpense()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡πà‡∏≤‡∏¢</button>
    </div>
</div>

<div class="modal-overlay" id="editTxModal">
    <div class="modal-content">
        <div class="modal-header"><h2>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2><button class="close-btn" onclick="closeModal('editTxModal')">‚úï</button></div>
        <input type="hidden" id="editTxId">
        <div class="form-group"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="editTxDate"></div>
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ / ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label><input type="text" id="editTxCat"></div>
        <div class="form-group"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ø)</label><input type="number" id="editTxAmt"></div>
        <div class="form-group"><label>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥</label><input type="text" id="editTxNote"></div>
        <p style="font-size:11px; color:var(--danger);">*‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô/‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏î‡πÉ‡∏´‡∏°‡πà‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏á‡∏ß‡∏î‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö</p>
        <button class="btn-main" onclick="saveEditTransaction()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
    </div>
</div>

<div class="modal-overlay" id="historyModal">
    <div class="modal-content">
        <div class="modal-header"><h2 id="historyTitle">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h2><button class="close-btn" onclick="closeModal('historyModal')">‚úï</button></div>
        <p id="historyDesc" class="tank-desc-text">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</p>

        <div id="growthPortfolioSection" class="goal-box" style="display:none; background:#f0fdf4; border-color:#86efac;">
            <h4 style="margin:0 0 10px 0; color:#166534;">üìà ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏±‡∏î‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏à‡∏≤‡∏Å‡∏≠‡∏≤‡∏¢‡∏∏ (<span id="portAgeDisplay"></span> ‡∏õ‡∏µ)</h4>
            <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px;">
                <span style="font-weight:bold; color:var(--terre-cuite);">‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á (‡∏´‡∏∏‡πâ‡∏ô/‡∏Ñ‡∏£‡∏¥‡∏õ‡πÇ‡∏ï): <span id="portHighPct">0%</span></span>
                <span style="font-weight:bold; color:var(--bleu-porcelaine);">‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥ (‡∏ï‡∏£‡∏≤‡∏™‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ): <span id="portLowPct">0%</span></span>
            </div>
            <div class="goal-progress-bg" style="background:var(--bleu-porcelaine);"><div class="goal-progress-fill" id="portBar" style="background:var(--terre-cuite);"></div></div>
            <p style="font-size:10px; color:var(--danger); margin:5px 0 0 0;">*‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ‡πÇ‡∏õ‡∏£‡∏î‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö</p>
        </div>

        <div id="goalSection" class="goal-box" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h4 style="margin:0; color:var(--espresso);" id="goalHeaderTxt">üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</h4>
                <button class="btn-outline" style="padding:2px 8px;" onclick="editGoal()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            </div>
            <div id="goalDisplay">
                <p style="margin:0 0 5px 0; font-size:16px; font-weight:bold; color:var(--terre-cuite);" id="goalNameTxt">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</p>
                <div class="goal-progress-bg"><div class="goal-progress-fill" id="goalBar">0%</div></div>
                <p style="margin:5px 0 0 0; font-size:12px;">‡∏™‡∏∞‡∏™‡∏°‡πÑ‡∏î‡πâ <strong id="goalCurrTxt">‡∏ø0</strong> / <span id="goalTargetTxt">‡∏ø0</span></p>
                <p style="margin:8px 0 0 0; font-size:11px; color:var(--danger);" id="goalWarnTxt"></p>
                
                <div id="goalActionBtn" style="display:none; margin-top:10px;">
                    <button class="btn-main" style="padding:8px; font-size:13px; background:var(--success);" onclick="claimGoal()">üéâ ‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏õ‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡∏ù‡∏±‡∏ô! (+500 ‡πÅ‡∏ï‡πâ‡∏°)</button>
                </div>
            </div>
            <div id="goalEdit" style="display:none;">
                <input type="text" id="goalNameInput" class="goal-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢">
                <input type="number" id="goalTargetInput" class="goal-input" placeholder="‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏ø)">
                <button class="btn-main" style="padding:8px; font-size:14px; margin-top:5px;" onclick="saveGoal()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</button>
            </div>
        </div>

        <p style="text-align: center; margin-top: 5px;">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <strong id="historyBalance" style="font-size:20px; color:var(--espresso);">‡∏ø0</strong></p>
        <div class="chart-container" style="height: 180px;"><canvas id="tankChart"></canvas></div>
        <h4 style="margin:10px 0 5px 0; font-size:14px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h4>
        <ul id="historyList" style="list-style:none; padding:0; margin:0;"></ul>
    </div>
</div>

<div class="modal-overlay" id="addDebtModal">
    <div class="modal-content"><div class="modal-header"><h2>üì• ‡∏¢‡∏∑‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏≤</h2><button class="close-btn" onclick="closeModal('addDebtModal')">‚úï</button></div>
    <div class="form-group"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ø)</label><input type="number" id="borrowAmt"></div>
    <div class="form-group"><label>‡∏¢‡∏∑‡∏°‡πÉ‡∏Ñ‡∏£‡∏°‡∏≤ (‡πÇ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ Essential)</label><input type="text" id="borrowNote" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏°‡πà, ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô"></div><button class="btn-main" onclick="processBorrow()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button></div>
</div>

<div class="modal-overlay" id="payDebtModal">
    <div class="modal-content"><div class="modal-header"><h2>üì§ ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏µ‡πâ</h2><button class="close-btn" onclick="closeModal('payDebtModal')">‚úï</button></div>
    <div class="form-group"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ø)</label><input type="number" id="paybackAmt"></div>
    <div class="form-group"><label>‡∏Ñ‡∏∑‡∏ô‡πÉ‡∏´‡πâ‡πÉ‡∏Ñ‡∏£?</label><select id="paybackLender"><option value="‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option></select></div>
    <p style="font-size:11px; color:var(--danger); margin-top:-5px;">*‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≠‡∏î Security ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
    <button class="btn-main" onclick="processPayback()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button></div>
</div>

<div class="modal-overlay" id="futureWarningModal">
    <div class="modal-content" style="text-align: center; border-top: 6px solid #8b5cf6;">
        <div style="font-size: 50px; margin-top: -10px; margin-bottom: 10px; animation: bounce 2s infinite;">üîÆ</div>
        <h2 style="color: #8b5cf6; margin: 0 0 10px 0; font-size: 22px;">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ... ‡∏â‡∏±‡∏ô‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï!</h2>
        <p style="color: var(--espresso); font-size: 14px; margin-bottom: 15px;">
            ‡∏ö‡∏≠‡∏™‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏°‡∏≤‡πÉ‡∏ä‡πà‡∏°‡∏±‡πâ‡∏¢?<br>‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤‡∏£‡∏π‡∏î‡∏ö‡∏±‡∏ï‡∏£/‡∏¢‡∏∑‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡πÑ‡∏õ:
        </p>
        <div style="background: #f3f4f6; border-radius: 15px; padding: 15px; margin-bottom: 20px; border: 1px dashed #cbd5e1;">
            <h1 style="color: var(--danger); font-size: 36px; margin: 0;">‡∏ø<span id="futureWarningAmt">0</span></h1>
        </div>
        <p style="color: var(--bleu-porcelaine); font-size: 13px; font-weight: bold; margin-bottom: 20px;">
            *‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏Å‡πÉ‡∏à! ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏ö‡∏Å‡∏±‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ñ‡∏±‡∏á Security ‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏µ‡∏ö‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡∏à‡πà‡∏≤‡∏¢‡∏ã‡∏∞!
        </p>
        <button class="btn-main" style="background: #8b5cf6; font-size: 15px;" onclick="closeModal('futureWarningModal'); switchTab('view-fixed', document.querySelectorAll('.nav-item')[1]);">‡∏û‡∏≤‡πÑ‡∏õ‡∏à‡πà‡∏≤‡∏¢‡∏ö‡∏¥‡∏•‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ üöÄ</button>
        <button class="btn-outline" style="width: 100%; border: none; margin-top: 5px; color: var(--gray-text);" onclick="closeModal('futureWarningModal')">‡∏õ‡∏¥‡∏î‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏°‡∏≤‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå</button>
    </div>
</div>

<div class="modal-overlay" id="addLegacyDebtModal">
    <div class="modal-content">
        <div class="modal-header"><h2>üí≥ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤</h2><button class="close-btn" onclick="closeModal('addLegacyDebtModal')">‚úï</button></div>
        <p style="font-size:11px; color:var(--danger); margin-top:-10px;">*‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏¥‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏≠‡∏î‡∏ú‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÜ (‡∏¢‡∏≠‡∏î‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏õ‡πÇ‡∏ú‡∏•‡πà‡∏Å‡∏ß‡∏ô‡πÉ‡∏à‡πÉ‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö)</p>
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ / ‡∏ö‡∏±‡∏ï‡∏£</label><input type="text" id="ldName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏±‡∏ï‡∏£ KBank, ‡∏ú‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡∏ß‡∏µ"></div>
        <div class="form-group"><label>‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢ "‡∏ï‡πà‡∏≠‡∏á‡∏ß‡∏î" (‡∏ø)</label><input type="number" id="ldAmt"></div>
        <div class="form-group"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà</label><input type="number" id="ldMonths" value="1" placeholder="‡∏ñ‡πâ‡∏≤‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏õ‡∏Å‡∏ï‡∏¥‡πÉ‡∏™‡πà 1"></div>
        <button class="btn-main" style="background:#0284c7;" onclick="saveLegacyDebt()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤</button>
    </div>
</div>

<div class="modal-overlay" id="editFixedModal">
    <div class="modal-content">
        <div class="modal-header"><h2>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏¥‡∏•/‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</h2><button class="close-btn" onclick="closeModal('editFixedModal')">‚úï</button></div>
        <input type="hidden" id="efcId">
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏õ/‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label><input type="text" id="efcName"></div>
        <div class="form-group"><label>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (‡∏ø)</label><input type="number" id="efcAmount"></div>
        <div class="form-group"><label>‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥</label><input type="text" id="efcIcon" maxlength="2"></div>
        <div class="form-group"><label>‡πÉ‡∏´‡πâ‡∏´‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÑ‡∏´‡∏ô?</label><select id="efcTank"><option value="essential">Essential</option><option value="joy">Joy</option><option value="security">Security</option></select></div>
        
        <div class="form-group" style="margin-top:10px;">
            <label style="color:#0369a1; display:flex; align-items:center; gap:5px; cursor:pointer;">
                <input type="checkbox" id="efcIsInst" onchange="document.getElementById('efcInstDiv').style.display = this.checked ? 'flex' : 'none';" style="width:auto; accent-color:#0369a1;"> ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞ (‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏à‡∏ö)
            </label>
        </div>
        <div class="form-group" id="efcInstDiv" style="display:none; gap:10px; background:#e0f2fe; padding:15px; border-radius:10px; border:1px dashed #7dd3fc;">
            <div style="flex:1;"><label style="color:#0284c7;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label><input type="number" id="efcTotalM"></div>
            <div style="flex:1;"><label style="color:#0284c7;">‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß (‡∏á‡∏ß‡∏î)</label><input type="number" id="efcPaidM"></div>
        </div>
        <button class="btn-main" onclick="saveEditFixedCost()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
    </div>
</div>

<div class="modal-overlay" id="editLegacyDebtModal">
    <div class="modal-content">
        <div class="modal-header"><h2>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤</h2><button class="close-btn" onclick="closeModal('editLegacyDebtModal')">‚úï</button></div>
        <input type="hidden" id="eldId">
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ / ‡∏ö‡∏±‡∏ï‡∏£</label><input type="text" id="eldName"></div>
        <div class="form-group"><label>‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢ "‡∏ï‡πà‡∏≠‡∏á‡∏ß‡∏î" (‡∏ø)</label><input type="number" id="eldAmt"></div>
        <div class="form-group"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà</label><input type="number" id="eldMonths"></div>
        <button class="btn-main" style="background:#0284c7;" onclick="saveEditLegacyDebt()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
    </div>
</div>

<script>
    Chart.register(ChartDataLabels);
    Chart.defaults.set('plugins.datalabels', {
        color: '#ffffff', font: { family: 'Kanit', weight: 'bold', size: 12 },
        formatter: (value, ctx) => {
            let sum = 0; let dataArr = ctx.chart.data.datasets[0].data; dataArr.map(data => sum += data);
            let pct = (value * 100 / sum).toFixed(0); return pct > 5 ? pct + '%' : ''; 
        }
    });

    let cfg = { g: 25, s: 50, e: 15, j: 10 }; let userName = 'Dream'; let userAge = 33; let totalIncomeThisMonth = 0; 
    let profileImgBase64 = null; 
    let baseAmounts = { growth: 0, security: 0, essential: 0, joy: 0 }; 
    let currentBalances = { growth: 0, security: 0, essential: 0, joy: 0 }; 
    let joyGoal = { name: '‡∏ó‡∏£‡∏¥‡∏õ‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô', target: 50000 }; 
    let secGoal = { name: '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', target: 100000 }; 
    let totalLiability = 0; let transactions = []; let isEditCatMode = false; let currentActiveGoalTank = '';
    
    let stats = { savedFromTemptation: 0, crossTankCount: 0, achievedJoy: false, achievedSec: false, temptationAbandonedCount: 0, temptationYieldedCount: 0, monthlyGrowthTouched: false };
    
    let userPoints = 0;
    let inventory = [];
    let incomeCats = [
        {id: 1, name: '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', icon: 'üí∞'}, 
        {id: 2, name: '‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°/‡∏ü‡∏£‡∏µ‡πÅ‡∏•‡∏ô‡∏ã‡πå', icon: 'üíª'}, 
        {id: 3, name: '‡∏õ‡∏±‡∏ô‡∏ú‡∏•/‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢', icon: 'üìà'}
    ];

    const questPool = [
        {id: 1, title: 'üç± ‡∏´‡πà‡∏≠‡∏Ç‡πâ‡∏≤‡∏ß‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô 3 ‡∏ß‡∏±‡∏ô', pts: 50}, {id: 2, title: '‚òï ‡∏á‡∏î‡∏™‡∏±‡πà‡∏á‡∏Å‡∏≤‡πÅ‡∏ü‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå 5 ‡∏ß‡∏±‡∏ô', pts: 80},
        {id: 3, title: 'üôÖ‚Äç‚ôÇÔ∏è ‡πÑ‡∏°‡πà‡∏î‡∏∂‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏•‡∏¢ 7 ‡∏ß‡∏±‡∏ô', pts: 150}, {id: 4, title: 'üèÉ‚Äç‚ôÇÔ∏è ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏ô‡πÅ‡∏ó‡∏ô‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡πâ‡∏≤‡∏á', pts: 50},
        {id: 5, title: 'üßπ ‡∏Å‡∏î‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏•‡∏á‡∏ó‡∏∏‡∏ô', pts: 20}, {id: 6, title: 'üíß ‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÅ‡∏ó‡∏ô‡∏ä‡∏≤‡∏ô‡∏° 3 ‡∏ß‡∏±‡∏ô', pts: 60},
        {id: 7, title: 'üßæ ‡∏à‡πà‡∏≤‡∏¢‡∏ö‡∏¥‡∏•‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö', pts: 100}, {id: 8, title: 'üìä ‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡∏´‡∏ô‡πâ‡∏≤ Analytics ‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', pts: 30},
        {id: 9, title: '‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Sub ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏î‡∏π 1 ‡πÅ‡∏≠‡∏õ', pts: 150}, {id: 10, title: 'üõµ ‡∏ô‡∏±‡πà‡∏á‡∏£‡∏ñ‡πÄ‡∏°‡∏•‡πå/BTS ‡πÅ‡∏ó‡∏ô‡πÅ‡∏ó‡πá‡∏Å‡∏ã‡∏µ‡πà 3 ‡∏ß‡∏±‡∏ô', pts: 50},
        {id: 11, title: 'üö´ ‡∏á‡∏î‡∏™‡∏±‡πà‡∏á Delivery ‡∏°‡∏∑‡πâ‡∏≠‡∏î‡∏∂‡∏Å 3 ‡∏ß‡∏±‡∏ô', pts: 100}, {id: 12, title: 'üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô 1 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå', pts: 200},
        {id: 13, title: 'üõçÔ∏è ‡∏ä‡∏ô‡∏∞‡πÉ‡∏à‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á ‡∏ó‡∏¥‡πâ‡∏á‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ 24h', pts: 100}, {id: 14, title: 'üìö ‡∏ü‡∏±‡∏á Podcast ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô 1 ‡∏ï‡∏≠‡∏ô', pts: 40},
        {id: 15, title: 'üç≥ ‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏¢‡πá‡∏ô‡∏Å‡∏¥‡∏ô‡πÄ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô', pts: 40},
        {id: 16, title: 'üí≥ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ö‡∏¥‡∏•‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤', pts: 150},
        {id: 17, title: 'üí∏ ‡πÇ‡∏õ‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô/‡∏Ñ‡∏ô‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å', pts: 100},
        {id: 18, title: 'üåü ‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á Essential ‡∏£‡∏∞‡∏î‡∏±‡∏ö 4-5 ‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', pts: 80},
        {id: 19, title: 'üçõ ‡∏ä‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß‡∏£‡πâ‡∏≤‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ (‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡πâ‡∏≤‡∏á) 1 ‡∏°‡∏∑‡πâ‡∏≠', pts: 100},
        {id: 20, title: 'üó£Ô∏è ‡∏ä‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏£‡∏≠‡∏ö‡∏Ç‡πâ‡∏≤‡∏á‡∏Ñ‡∏∏‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô/‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô', pts: 80},
        {id: 21, title: 'üôÖ‚Äç‚ôÇÔ∏è ‡∏£‡∏≠‡∏î‡∏û‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡πÇ‡∏õ‡∏£ 1 ‡πÅ‡∏ñ‡∏° 1 (‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô) ‡∏°‡∏≤‡πÑ‡∏î‡πâ', pts: 120},
        {id: 22, title: 'üì± ‡∏õ‡πâ‡∏≤‡∏¢‡∏¢‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÅ‡∏≠‡∏õ‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à 1 ‡∏Ñ‡∏ô!', pts: 250},
        {id: 23, title: 'üö´ ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ Shopee/Lazada ‡πÑ‡∏°‡πà‡∏Å‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡∏¢ 1 ‡∏ß‡∏±‡∏ô', pts: 100}
    ];
    let activeQuests = [];
    
    let customCats = [
        {id: 1, name: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£', icon: 'üçõ', tank: 'essential'}, {id: 2, name: '‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á', icon: 'üöÜ', tank: 'essential'},
        {id: 3, name: '‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß', icon: 'üë®‚Äçüë©‚Äçüëß', tank: 'essential'}, {id: 4, name: '‡∏†‡∏≤‡∏©‡∏µ‡∏™‡∏±‡∏á‡∏Ñ‡∏°', icon: 'üíå', tank: 'joy'},
        {id: 5, name: '‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á', icon: 'üõçÔ∏è', tank: 'joy'}, {id: 6, name: '‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà', icon: '‚òï', tank: 'joy'}
    ];
    let fixedCosts = [{id: 1, name: 'Netflix', icon: 'üé¨', amount: 419, tank: 'joy', paidThisMonth: false}];
    let yearlyFunds = [{id: 1, name: '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå', amount: 12000, current: 0, paidMonths: 0, monthlyVal: 1000}];
    let wishlist = [];

    let activeExpenseCat = ''; let activeFixedId = null;
    let analyticsChartInstance, tankChartInstance, debtChartInstance;

    const tankDesc = {
        growth: "üå± <strong>Growth (‡∏•‡∏á‡∏ó‡∏∏‡∏ô):</strong> ‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πà‡∏≠‡∏¢‡∏≠‡∏î‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï ‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏∏‡πâ‡∏ô, ‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á",
        security: "üõ°Ô∏è <strong>Security (‡∏™‡∏≥‡∏£‡∏≠‡∏á/‡∏´‡∏ô‡∏µ‡πâ):</strong> ‡πÄ‡∏Å‡∏£‡∏≤‡∏∞‡∏Ñ‡∏∏‡πâ‡∏°‡∏†‡∏±‡∏¢! ‡πÄ‡∏á‡∏¥‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô, ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô, ‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ",
        essential: "üõí <strong>Essential (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô):</strong> ‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢ 4 ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£, ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á, ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ, ‡πÉ‡∏´‡πâ‡∏û‡πà‡∏≠‡πÅ‡∏°‡πà",
        joy: "üéâ <strong>Joy (‡∏Å‡∏¥‡πÄ‡∏•‡∏™‡∏•‡πâ‡∏ß‡∏ô‡πÜ):</strong> ‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç... ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏™‡∏ï‡∏¥‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ö‡∏≠‡∏™! ‡∏ñ‡πâ‡∏≤‡∏£‡∏π‡∏î‡πÄ‡∏û‡∏•‡∏¥‡∏ô ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏ç‡πà‡∏û‡∏±‡∏á‡πÅ‡∏ô‡πà"
    };

    function showGifOverlay(type) {
        let gifOverlay = document.getElementById('gifOverlay');
        let gifImage = document.getElementById('gifImage');
        let gifText = document.getElementById('gifText');
        
        if (type === 'goal') {
            // [EDIT_GIF_GOAL_HERE]
            gifImage.src = "https://media1.tenor.com/m/oRUoS4uBbQIAAAAd/khun-thee-lacorn.gif"; 
            gifText.innerText = "üéâ ‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì! ‡∏û‡∏¥‡∏ä‡∏¥‡∏ï‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!";
        } else if (type === 'crosstank') {
            // [EDIT_GIF_CROSSTANK_HERE]
            gifImage.src = "https://media1.tenor.com/m/kSwhTm-9DYIAAAAd/angry-khun-thee.gif"; 
            gifText.innerText = "‡∏ñ‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏ñ‡∏≠‡∏∞‡∏´‡πå ‡∏ô‡∏µ‡πà‡∏î‡∏∂‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏á‡∏±‡πâ‡∏ô‡πÄ‡∏´‡∏£‡∏≠";
        } else if (type === 'joy_warn') {
            // [EDIT_GIF_JOY_WARN_HERE]
            gifImage.src = "https://media1.tenor.com/m/orvLKT5PVg0AAAAd/khunthee-catcrce.gif"; 
            gifText.innerText = `‡∏î‡∏∂‡∏á‡∏™‡∏ï‡∏¥‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡∏∏‡∏ì ${userName} ‡∏ú‡∏°‡πÉ‡∏´‡πâ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ô‡∏∞`;
        } else if (type === 'expense_saved') {
            // [EDIT_GIF_EXPENSE_SAVED_HERE]
            gifImage.src = "https://media1.tenor.com/m/XjmdrDMoO_kAAAAC/khun-thee-lacorn.gif"; 
            gifText.innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏ö‡∏≠‡∏™!";
        } else if (type === 'income') {
            // [EDIT_GIF_INCOME_HERE]
            gifImage.src = "https://media1.tenor.com/m/jYur0uCjtjsAAAAd/khun-thee-lacorn.gif"; 
            gifText.innerText = "‡πÅ‡∏ö‡∏á‡∏Ñ‡πå‡∏û‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô üí∏ ‡∏°‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á";
        } else if (type === 'wishlist_skip') {
            // [EDIT_GIF_WISHLIST_SKIP_HERE]
            gifImage.src = "https://media1.tenor.com/m/2bGj2dzR-d4AAAAC/huh-disgusted.gif"; 
            gifText.innerText = "‡πÑ‡∏î‡πâ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ñ‡∏≠‡∏∞‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå ‡πÄ‡∏≠‡∏≤‡πÉ‡∏´‡πâ‡∏°‡∏±‡∏ô‡∏™‡∏≤‡πÅ‡∏Å‡πà‡πÉ‡∏à‡∏ã‡∏∞‡∏™‡∏¥";
        } else if (type === 'wishlist_delete') {
            // [EDIT_GIF_WISHLIST_DELETE_HERE]
            gifImage.src = "https://media1.tenor.com/m/j7A3Sc2dZ0QAAAAC/khun-thee-pond-naravit.gif"; 
            gifText.innerText = "‡∏â‡∏±‡∏ô‡∏°‡∏≠‡∏á‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡∏ú‡∏¥‡∏î‡∏à‡∏£‡∏¥‡∏á‡πÜ";
        }

        gifOverlay.classList.add('show');
        setTimeout(() => { closeGifOverlay(); }, 4500);
    }
    function closeGifOverlay() { document.getElementById('gifOverlay').classList.remove('show'); }

    function loadStorage() {
        try {
            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô key ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏ä‡πâ wq18_ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏≠‡∏™‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏°‡∏≤!
            if(localStorage.getItem('wq18_age')) userAge = parseInt(localStorage.getItem('wq18_age'));
            if(localStorage.getItem('wq18_name')) userName = localStorage.getItem('wq18_name');
            if(localStorage.getItem('wq18_pts')) userPoints = parseInt(localStorage.getItem('wq18_pts'));
            if(localStorage.getItem('wq18_inv')) inventory = JSON.parse(localStorage.getItem('wq18_inv'));
            if(localStorage.getItem('wq18_cfg')) cfg = JSON.parse(localStorage.getItem('wq18_cfg'));
            if(localStorage.getItem('wq18_base')) baseAmounts = JSON.parse(localStorage.getItem('wq18_base'));
            if(localStorage.getItem('wq18_curr')) currentBalances = JSON.parse(localStorage.getItem('wq18_curr'));
            if(localStorage.getItem('wq18_tx')) transactions = JSON.parse(localStorage.getItem('wq18_tx'));
            if(localStorage.getItem('wq18_cat')) customCats = JSON.parse(localStorage.getItem('wq18_cat'));
            if(localStorage.getItem('wq18_fc')) fixedCosts = JSON.parse(localStorage.getItem('wq18_fc'));
            if(localStorage.getItem('wq18_yf')) yearlyFunds = JSON.parse(localStorage.getItem('wq18_yf'));
            if(localStorage.getItem('wq18_wl')) wishlist = JSON.parse(localStorage.getItem('wq18_wl'));
            if(localStorage.getItem('wq18_q')) activeQuests = JSON.parse(localStorage.getItem('wq18_q'));
            if(localStorage.getItem('wq18_debt')) totalLiability = parseFloat(localStorage.getItem('wq18_debt'));
            if(localStorage.getItem('wq18_inc')) totalIncomeThisMonth = parseFloat(localStorage.getItem('wq18_inc'));
            if(localStorage.getItem('wq18_joyG')) joyGoal = JSON.parse(localStorage.getItem('wq18_joyG'));
            if(localStorage.getItem('wq18_secG')) secGoal = JSON.parse(localStorage.getItem('wq18_secG'));
            if(localStorage.getItem('wq18_stats')) stats = JSON.parse(localStorage.getItem('wq18_stats'));
            if(localStorage.getItem('wq18_incCat')) incomeCats = JSON.parse(localStorage.getItem('wq18_incCat'));
            if(localStorage.getItem('wq18_profileImg')) profileImgBase64 = localStorage.getItem('wq18_profileImg');
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÉ‡∏´‡∏°‡πà
            transactions.forEach(t => { 
                if(t.type === 'expense' && !t.installments && (t.payMethod === '‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï' || t.payMethod === '‡∏ú‡πà‡∏≠‡∏ô (BNPL)')) {
                    t.installments = [{monthNo: 1, amount: t.amount, paid: t.creditPaid || false}];
                }
            });
        } catch (e) { console.error("Error loading storage", e); }
        
        document.getElementById('userGreeting').innerText = `‡∏°‡∏µ‡∏™‡∏ï‡∏¥‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡∏∏‡∏ì ${userName}!!!`;
        document.getElementById('userNameInput').value = userName; document.getElementById('userAgeInput').value = userAge > 0 ? userAge : '';
        document.getElementById('incomeDateInput').valueAsDate = new Date();
        
        updateProfilePicUI(); renderIncomeCats(); initQuests(); renderMonthlyQuest();
    }
    
    function saveStorage() {
        // ‡πÄ‡∏ã‡∏ü‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á key wq18_ ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏£‡∏ö
        localStorage.setItem('wq18_name', userName); localStorage.setItem('wq18_age', userAge); localStorage.setItem('wq18_pts', userPoints); 
        localStorage.setItem('wq18_profileImg', profileImgBase64 || '');
        localStorage.setItem('wq18_inv', JSON.stringify(inventory)); localStorage.setItem('wq18_cfg', JSON.stringify(cfg)); 
        localStorage.setItem('wq18_base', JSON.stringify(baseAmounts)); localStorage.setItem('wq18_curr', JSON.stringify(currentBalances));
        localStorage.setItem('wq18_tx', JSON.stringify(transactions)); localStorage.setItem('wq18_cat', JSON.stringify(customCats));
        localStorage.setItem('wq18_fc', JSON.stringify(fixedCosts)); localStorage.setItem('wq18_yf', JSON.stringify(yearlyFunds));
        localStorage.setItem('wq18_wl', JSON.stringify(wishlist)); localStorage.setItem('wq18_q', JSON.stringify(activeQuests)); 
        localStorage.setItem('wq18_debt', totalLiability); localStorage.setItem('wq18_inc', totalIncomeThisMonth); 
        localStorage.setItem('wq18_joyG', JSON.stringify(joyGoal)); localStorage.setItem('wq18_secG', JSON.stringify(secGoal)); 
        localStorage.setItem('wq18_stats', JSON.stringify(stats)); localStorage.setItem('wq18_incCat', JSON.stringify(incomeCats));
    }

    function switchTab(tabId, navElement) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active'); navElement.classList.add('active');
        navElement.style.background = 'transparent';
        if(tabId === 'view-home') { renderCategories(); renderQuests(); renderWishlist(); }
        if(tabId === 'view-fixed') { renderFixedCosts(); renderYearlyFunds(); renderCreditBills(); }
    }

    function updateUI() {
        document.getElementById('sub-growth').innerText = `‡∏•‡∏á‡∏ó‡∏∏‡∏ô (${cfg.g}%)`; document.getElementById('sub-security').innerText = `‡∏™‡∏≥‡∏£‡∏≠‡∏á (${cfg.s}%)`;
        document.getElementById('sub-essential').innerText = `‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (${cfg.e}%)`; document.getElementById('sub-joy').innerText = `‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• (${cfg.j}%)`;
        
        document.getElementById('userPointsDisplay').innerText = `ü™ô ${userPoints.toLocaleString()} ‡πÅ‡∏ï‡πâ‡∏°`;
        document.getElementById('shopPointsDisplay').innerText = `ü™ô ${userPoints.toLocaleString()}`;

        ['growth', 'security', 'essential', 'joy'].forEach(tank => {
            document.getElementById(`val-${tank}`).innerText = '‡∏ø' + currentBalances[tank].toLocaleString();
            let pct = baseAmounts[tank] > 0 ? (currentBalances[tank] / baseAmounts[tank]) * 100 : 0;
            let bar = document.getElementById(`bar-${tank}`); bar.style.height = `${Math.min(100, Math.max(0, pct))}%`; bar.innerText = Math.round(pct) + '%'; 
        });

        renderCategories(); renderFixedCosts(); renderYearlyFunds(); renderQuests(); renderWishlist(); renderInventory(); renderDebtLog(); renderCreditBills(); 
        
        if(typeof renderReceivables === 'function') renderReceivables(); 
        if(typeof renderDebtSummary === 'function') renderDebtSummary();

        saveStorage();
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ (‡∏Ñ‡∏¥‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏°‡∏≤)
    function renderDebtSummary() {
        let liabilityDisplay = document.getElementById('totalLiabilityDisplay');
        if(liabilityDisplay) liabilityDisplay.innerText = '‡∏ø' + totalLiability.toLocaleString();
    }
    function renderCreditBills() {
        let list = document.getElementById('creditBillList');
        let pendingInstallments = [];
        transactions.forEach(t => {
            if((t.type === 'expense' || t.type === 'legacy_debt') && t.installments) {
                let nextUnpaid = t.installments.find(i => !i.paid);
                if(nextUnpaid) pendingInstallments.push({ tx: t, inst: nextUnpaid, totalInst: t.installments.length });
            }
        });

        let totalUnpaidThisMonth = pendingInstallments.reduce((s, item) => s + item.inst.amount, 0);
        let warnEl = document.getElementById('incomeCreditWarning');
        
        if (totalUnpaidThisMonth > 0) {
            warnEl.style.display = 'block'; document.getElementById('warnCreditAmt').innerText = totalUnpaidThisMonth.toLocaleString();
        } else {
            warnEl.style.display = 'none';
        }

        list.innerHTML = '';
        if (pendingInstallments.length === 0) {
            list.innerHTML = '<p style="text-align:center; font-size:12px; color:#0ea5e9; margin-top:15px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏¥‡∏•‡∏ö‡∏±‡∏ï‡∏£/‡∏ú‡πà‡∏≠‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö! üéâ</p>'; return;
        }
        
        pendingInstallments.forEach(item => {
            let t = item.tx; let inst = item.inst;
            let d = new Date(t.dateObj).toLocaleDateString('th-TH');
            let noteHtml = t.note ? ` <span style="color:#8b5cf6; font-weight:normal;">(${t.note})</span>` : '';
            let titleText = item.totalInst > 1 ? `${t.cat}${noteHtml} (‡∏á‡∏ß‡∏î ${inst.monthNo}/${item.totalInst})` : `${t.cat}${noteHtml}`;

            // ‡∏õ‡∏∏‡πà‡∏° [‡πÅ‡∏Å‡πâ] ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤
            let editBtn = t.type === 'legacy_debt' ? `<button style="background:transparent; border:none; color:var(--bleu-porcelaine); font-size:12px; cursor:pointer; padding:0; font-weight:bold; margin-right:5px;" onclick="openEditLegacyDebt(${t.id})">[‡πÅ‡∏Å‡πâ]</button>` : '';

            list.innerHTML += `
            <div class="list-item" style="display:flex; justify-content:space-between; align-items:center; padding:12px 0;">
                <div class="list-info" style="display:flex; align-items:center; gap:10px; flex:1; min-width:0;">
                    <span style="font-size:20px;">üí≥</span>
                    <div style="min-width:0;">
                        <h4 style="margin:0; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${titleText} <span style="font-size:10px; color:var(--danger);">[‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢]</span></h4>
                        <p style="margin:0; font-size:11px; color:var(--gray-text);">${d} | ‡∏ø${inst.amount.toLocaleString()}</p>
                    </div>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <button class="btn-main" style="width:auto; padding:5px 10px; margin:0; background:#0284c7; font-size:11px;" onclick="payCreditBill(${t.id}, ${inst.monthNo})">‡∏à‡πà‡∏≤‡∏¢</button>
                    <div style="display:flex; align-items:center; border-left:1px solid #bae6fd; padding-left:10px;">
                        ${editBtn}
                        <button style="background:transparent; border:none; color:var(--danger); font-size:16px; cursor:pointer; padding:0; font-weight:bold;" onclick="undoTransaction(${t.id})">‚úï</button>
                    </div>
                </div>
            </div>`;
        });
    }

    function payCreditBill(txId, monthNo) {
        if(confirm('‡∏à‡πà‡∏≤‡∏¢‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°‡∏ö‡∏≠‡∏™?\n(‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ Security ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå)')) {
            let t = transactions.find(x => x.id === txId);
            if(t && t.installments) {
                let inst = t.installments.find(i => i.monthNo === monthNo);
                if(inst) {
                    inst.paid = true;
                    currentBalances.security -= inst.amount;
                    saveStorage(); updateUI(); showToast('‚úÖ ‡∏à‡πà‡∏≤‡∏¢‡∏ö‡∏¥‡∏•‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å Security ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
                }
            }
        }
    }

    function renderIncomeCats() {
        let sel = document.getElementById('incomeCatSelect');
        if(!sel) return;
        sel.innerHTML = '';
        incomeCats.forEach(c => { sel.innerHTML += `<option value="${c.name}">${c.icon} ${c.name}</option>`; });
        sel.innerHTML += `<option value="add_new">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏ß‡∏î‡πÉ‡∏´‡∏°‡πà</option>`;
    }
    function saveIncomeCategory() {
        let n = document.getElementById('newIncCatName').value;
        let i = document.getElementById('newIncCatIcon').value || 'üí∞';
        if(n) { incomeCats.push({id: Date.now(), name: n, icon: i}); saveStorage(); renderIncomeCats(); document.getElementById('incomeCatSelect').value = n; closeModal('addIncomeCatModal'); }
    }

    function applyPreset(g,s,e,j) { document.getElementById('cfgG').value=g; document.getElementById('cfgS').value=s; document.getElementById('cfgE').value=e; document.getElementById('cfgJ').value=j; }
    
    function saveConfig() {
        try {
            userName = document.getElementById('userNameInput').value || userName; 
            let newAge = parseInt(document.getElementById('userAgeInput').value); if(!isNaN(newAge)) userAge = newAge;
            
            let g = parseInt(document.getElementById('cfgG').value)||0; let s = parseInt(document.getElementById('cfgS').value)||0; let e = parseInt(document.getElementById('cfgE').value)||0; let j = parseInt(document.getElementById('cfgJ').value)||0;
            if(g+s+e+j !== 100) return alert('‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏ß‡∏°‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ 100% ‡∏Ñ‡∏£‡∏±‡∏ö');
            cfg = {g, s, e, j}; 
            
            let totalBase = baseAmounts.growth + baseAmounts.security + baseAmounts.essential + baseAmounts.joy;
            if (totalBase > 0) {
                let spentG = baseAmounts.growth - currentBalances.growth;
                let spentS = baseAmounts.security - currentBalances.security;
                let spentE = baseAmounts.essential - currentBalances.essential; let spentJ = baseAmounts.joy - currentBalances.joy;
                baseAmounts.growth = totalBase * (cfg.g/100); baseAmounts.security = totalBase * (cfg.s/100); baseAmounts.essential = totalBase * (cfg.e/100); baseAmounts.joy = totalBase * (cfg.j/100);
                currentBalances.growth = baseAmounts.growth - spentG; currentBalances.security = baseAmounts.security - spentS; currentBalances.essential = baseAmounts.essential - spentE; currentBalances.joy = baseAmounts.joy - spentJ;
            }
            document.getElementById('userGreeting').innerText = `‡∏°‡∏µ‡∏™‡∏ï‡∏¥‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡∏∏‡∏ì ${userName}!!!`;
            updateProfilePicUI(); updateUI(); closeModal('configModal'); showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß!');
        } catch (error) { console.error(error); closeModal('configModal'); }
    }

    function updateProfilePicUI() {
        let picDiv = document.getElementById('profilePicDisplay');
        if (profileImgBase64) { picDiv.style.backgroundImage = `url(${profileImgBase64})`; picDiv.innerText = ''; } 
        else { picDiv.style.backgroundImage = 'none'; picDiv.innerText = userName ? userName.charAt(0).toUpperCase() : 'D'; }
    }

    function uploadProfilePic(event) {
        let file = event.target.files[0];
        if (!file) return;
        let reader = new FileReader(); reader.onload = function(e) { profileImgBase64 = e.target.result; saveStorage(); updateProfilePicUI(); showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ö‡∏≠‡∏™!'); }; reader.readAsDataURL(file);
    }

    function confirmIncome() {
        let inc = parseFloat(document.getElementById('mainIncomeInput').value);
        if(!inc || inc <= 0) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö!');
        let cat = document.getElementById('incomeCatSelect').value;
        if(cat === 'add_new') return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö');
        let dateVal = document.getElementById('incomeDateInput').value;
        let dateObj = dateVal ? new Date(dateVal).toISOString() : new Date().toISOString();
        transactions.push({ id: Date.now(), type: 'main_income', amount: inc, cat: cat, dateObj: dateObj });

        totalIncomeThisMonth += inc;
        baseAmounts.growth += inc*(cfg.g/100);
        currentBalances.growth += inc*(cfg.g/100); baseAmounts.security += inc*(cfg.s/100); currentBalances.security += inc*(cfg.s/100);
        baseAmounts.essential += inc*(cfg.e/100); currentBalances.essential += inc*(cfg.e/100); baseAmounts.joy += inc*(cfg.j/100);
        currentBalances.joy += inc*(cfg.j/100);
        
        document.getElementById('mainIncomeInput').value = ''; 
        updateUI(); 
        showToast('üéâ ‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        showGifOverlay('income');
        
        stats.monthlyGrowthTouched = false; saveStorage();
        
        let pendingSum = 0;
        transactions.forEach(t => {
            if(t.installments) {
                t.installments.forEach(i => {
                    if(!i.paid) pendingSum += i.amount;
                });
            }
        });
        
        if(pendingSum > 0) {
            setTimeout(() => {
                document.getElementById('futureWarningAmt').innerText = pendingSum.toLocaleString();
                openModal('futureWarningModal');
            }, 4600);
        }
    }
    
    function sweepChange() {
        let eChange = currentBalances.essential % 100;
        let jChange = currentBalances.joy % 100; let total = eChange + jChange;
        if(total <= 0) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏®‡∏©‡πÉ‡∏´‡πâ‡∏õ‡∏±‡∏î‡∏Ñ‡∏£‡∏±‡∏ö‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏õ‡πä‡∏∞!');
        currentBalances.essential -= eChange;
        currentBalances.joy -= jChange; currentBalances.growth += total;
        transactions.push({ id: Date.now(), type: 'income', tank: 'growth', amount: total, cat: '‡∏Å‡∏ß‡∏≤‡∏î‡πÄ‡∏®‡∏©‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç', dateObj: new Date().toISOString() });
        userPoints += 20; updateUI(); showToast(`üßπ ‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏© ‡∏ø${total} ‡πÑ‡∏õ‡∏•‡∏á‡∏ó‡∏∏‡∏ô! ‡∏£‡∏±‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™ 20 ‡πÅ‡∏ï‡πâ‡∏°`);
    }

    let bulkRowId = 0;
    function openBulkEntry() {
        document.getElementById('bulkEntryDate').valueAsDate = new Date(); // ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
        document.getElementById('bulkRows').innerHTML = ''; addBulkRow(); addBulkRow(); openModal('bulkEntryModal');
    }
    function addBulkRow() {
        bulkRowId++; let row = document.createElement('div');
        row.className = 'bulk-row'; row.id = `bulk_${bulkRowId}`;
        row.style = "display:flex; gap:5px; margin-bottom:10px; align-items:center; background:#f8fafc; padding:10px; border-radius:12px;";
        row.innerHTML = `
            <div style="flex:1;">
                <input type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£" style="width:100%; padding:8px; border-radius:8px; border:1px solid #ccc; font-size:13px; margin-bottom:5px;" class="b-cat">
                <div style="display:flex; gap:5px;">
                    <input type="number" placeholder="‡∏ø ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô" style="flex:1; padding:8px; border-radius:8px; border:1px solid #ccc; font-size:13px;" class="b-amt">
                    <select style="flex:1; padding:8px; border-radius:8px; border:1px solid #ccc; font-size:13px;" class="b-tank"><option value="essential">Essential</option><option value="joy">Joy</option><option value="security">Security</option></select>
                </div>
            </div>
            <button onclick="document.getElementById('bulk_${bulkRowId}').remove()" style="background:var(--danger); color:white; border:none; border-radius:50%; width:28px; height:28px; font-weight:bold; cursor:pointer;">‚úï</button>
        `;
        document.getElementById('bulkRows').appendChild(row);
    }
    function submitBulkEntry() {
        let rows = document.querySelectorAll('.bulk-row');
        let successCount = 0; let errCount = 0;
        
        // ‡∏î‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ö‡∏≠‡∏™‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î
        let selectedDate = document.getElementById('bulkEntryDate').value;
        let finalDateObj = selectedDate ? new Date(selectedDate).toISOString() : new Date().toISOString();

        rows.forEach(r => {
            let cat = r.querySelector('.b-cat').value || '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏ö‡∏¢‡∏≠‡∏î'; let amt = parseFloat(r.querySelector('.b-amt').value); let tank = r.querySelector('.b-tank').value;
            if(amt > 0) {
                if(currentBalances[tank] >= amt) {
                    currentBalances[tank] -= amt;
                    let em = tank==='joy' ? 'ü§© ‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á' : null; let nr = tank==='essential' ? 3 : null;
                    if(tank === 'growth') stats.monthlyGrowthTouched = true;
                    // ‡πÉ‡∏™‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ö‡∏≠‡∏™‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (finalDateObj) ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÅ‡∏ó‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    transactions.push({ id: Date.now()+Math.random(), type:'expense', dateObj: finalDateObj, tank: tank, amount: amt, cat: cat, note: 'Daily Dump', payMethod: '‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢/‡πÇ‡∏≠‡∏ô', emotion: em, needRating: nr, creditPaid: false });
                    successCount++;
                } else { errCount++; }
            }
        });
        updateUI();
        if(successCount > 0) { userPoints += 15; } closeModal('bulkEntryModal');
        if(successCount > 0 && errCount === 0) { showToast(`‚úÖ ‡∏£‡∏ß‡∏ö‡∏¢‡∏≠‡∏î ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£! ‡∏£‡∏±‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™ +15 ‡πÅ‡∏ï‡πâ‡∏°`); showGifOverlay('expense_saved');
        }
        else if(successCount > 0 && errCount > 0) { showToast(`‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏Ç‡πâ‡∏≤‡∏° ${errCount} ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠)`);
        showGifOverlay('expense_saved'); }
        else if(errCount > 0) { showToast(`‚ùå ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏¢‡∏™‡∏±‡∏Å‡∏≠‡∏±‡∏ô!`);
        }
    }

    function buyReward(itemName, cost) {
        if(userPoints < cost) return alert(`‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Ç‡∏≤‡∏î‡∏≠‡∏µ‡∏Å ${cost - userPoints} ‡πÅ‡∏ï‡πâ‡∏°`);
        if(confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ä‡πâ ${cost} ‡πÅ‡∏ï‡πâ‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏Å "${itemName}" ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?`)) { userPoints -= cost; inventory.push({id: Date.now(), name: itemName}); updateUI(); showToast(`üéâ ‡πÅ‡∏•‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß`);
        }
    }
    function renderInventory() {
        let inv = document.getElementById('inventoryList');
        inv.innerHTML = '';
        if(!inventory || inventory.length === 0) { inv.innerHTML = '<p style="text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</p>'; return;
        }
        inventory.forEach(i => {
            inv.innerHTML += `<div style="background:#f0fdf4; border:1px solid #86efac; padding:10px; border-radius:8px; margin-bottom:5px; display:flex; justify-content:space-between; align-items:center;">
                <span style="color:#166534; font-weight:bold;">üéüÔ∏è ${i.name}</span><button class="btn-main" style="width:auto; padding:4px 12px; margin:0; background:#166534; font-size:11px;" onclick="useReward(${i.id}, '${i.name}')">‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</button>
            </div>`;
        });
    }
    
    function useReward(id, name) { 
        if(confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á "${name}" ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°? (‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ô‡∏∞)`)) { 
            
            if(name === 'üéüÔ∏è ‡πÇ‡∏≠‡∏ô Essential ‡πÄ‡∏Ç‡πâ‡∏≤ Joy 500‡∏ø') {
                if(currentBalances.essential < 500) {
                    return alert('‡∏ö‡∏≠‡∏™! ‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô Essential ‡πÑ‡∏°‡πà‡∏û‡∏≠ 500‡∏ø ‡πÉ‡∏´‡πâ‡πÇ‡∏¢‡∏Å‡∏ô‡∏∞ (‡∏°‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠!)');
                }
                currentBalances.essential -= 500;
                currentBalances.joy += 500;
                transactions.push({ id: Date.now(), type: 'income', tank: 'joy', amount: 500, cat: 'üéüÔ∏è ‡πÇ‡∏¢‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÅ‡∏ï‡πâ‡∏°', note: '‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å Essential', dateObj: new Date().toISOString() });
                transactions.push({ id: Date.now()+1, type: 'expense', tank: 'essential', amount: 500, cat: 'üéüÔ∏è ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏ï‡πâ‡∏°‡πÇ‡∏¢‡∏Å‡πÄ‡∏á‡∏¥‡∏ô', note: '‡πÇ‡∏≠‡∏ô‡πÑ‡∏õ Joy', payMethod: '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î', dateObj: new Date().toISOString(), creditPaid: false });
            }
            else if(name === 'üßº ‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏≤‡∏õ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥') {
                if(stats.crossTankCount <= 0) {
                    return alert('‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ö‡∏≠‡∏™‡∏Ç‡∏≤‡∏ß‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö! ‡πÄ‡∏Å‡πá‡∏ö‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏ñ‡∏≠‡∏∞‡∏ô‡∏∞');
                }
                stats.crossTankCount -= 1;
                alert('‚ú® ‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏≤‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! AI ‡∏•‡∏∑‡∏°‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡πà‡∏≤‡∏ö‡∏≠‡∏™‡πÄ‡∏Ñ‡∏¢‡∏î‡∏∂‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏°‡∏ñ‡∏±‡∏á 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏™‡∏ö‡∏≤‡∏¢‡πÉ‡∏à‡πÑ‡∏î‡πâ!');
            }
            else if(name === 'ü§ù ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏ô‡∏£‡∏≠‡∏ö‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏õ‡∏¢‡πå' || name === 'üöó ‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô‡∏ü‡∏£‡∏µ 1 ‡∏ß‡∏±‡∏ô (‡∏°‡∏µ‡∏Ñ‡∏ô‡πÄ‡∏õ‡∏¢‡πå)' || name === 'üé¨ ‡∏ö‡∏±‡∏ï‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≤‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡∏±‡∏á/‡∏ã‡∏µ‡∏£‡∏µ‡∏™‡πå' || name === 'üí¨ ‡∏ö‡∏±‡∏ï‡∏£‡∏ö‡πà‡∏ô (‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡∏±‡∏î) 10 ‡∏ô‡∏≤‡∏ó‡∏µ') {
                alert(`üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢‡∏ö‡∏≠‡∏™!! ‡∏£‡∏µ‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡∏¢‡∏∑‡πà‡∏ô‡πÉ‡∏™‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏ß‡∏á‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á:\n\nüëâ "${name}"\n\n(‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏î‡∏•‡∏á‡πÅ‡∏≠‡∏õ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏µ‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö‡∏à‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß ü§£)`);
            }
            else if(name === 'üç∞ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡πÑ‡∏£‡πâ‡∏™‡∏≤‡∏£‡∏∞ 1 ‡∏ä‡∏¥‡πâ‡∏ô' || name === 'üßã ‡∏ö‡∏±‡∏ï‡∏£‡∏ú‡πà‡∏≤‡∏ô‡∏ä‡∏≤‡∏ô‡∏° (‡∏ô‡∏≠‡∏Å‡∏£‡∏≠‡∏ö)') {
                let cost = prompt(`‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå VIP! ‡∏ö‡∏≠‡∏™‡∏ã‡∏∑‡πâ‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏Å‡∏µ‡πà‡∏ö‡∏≤‡∏ó? (‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏°‡∏≤‡πÄ‡∏•‡∏¢ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏ö‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏¢‡∏≠‡∏î‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ AI ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö)`);
                let amt = parseFloat(cost);
                if(isNaN(amt) || amt <= 0) return alert('‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏ô‡∏∞‡∏ö‡∏≠‡∏™!');
                if(currentBalances.essential < amt) return alert('‡∏ö‡∏≠‡∏™! ‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô Essential ‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏´‡∏±‡∏Å‡∏ô‡∏∞!');
                
                currentBalances.essential -= amt;
                transactions.push({ id: Date.now(), type:'expense', dateObj: new Date().toISOString(), tank: 'essential', amount: amt, cat: `üéÅ VIP: ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÅ‡∏ï‡πâ‡∏°‡πÅ‡∏•‡∏Å‡∏°‡∏≤`, note: name, payMethod: '‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢/‡πÇ‡∏≠‡∏ô', emotion: 'ü§© ‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á', needRating: 5, creditPaid: false, isCross: false });
                alert(`‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô ‡∏ø${amt} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏¢‡∏≠‡∏î‡∏ï‡∏£‡∏á‡πÄ‡∏õ‡πä‡∏∞ ‡∏ö‡∏≠‡∏™‡∏Å‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏£‡πà‡∏≠‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ú‡∏¥‡∏î!`);
            }
            else if(name === 'üò¥ ‡∏ö‡∏±‡∏ï‡∏£‡∏ß‡∏±‡∏ô‡∏Ç‡∏µ‡πâ‡πÄ‡∏Å‡∏µ‡∏¢‡∏à') {
                let cost = prompt('‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà‡∏ö‡∏≠‡∏™! ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏õ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏°‡∏≤‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏•‡∏¢ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏à‡∏ö:');
                let amt = parseFloat(cost);
                if(isNaN(amt) || amt <= 0) return alert('‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏ô‡∏∞!');
                if(currentBalances.essential < amt) return alert('‡πÄ‡∏á‡∏¥‡∏ô Essential ‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏´‡∏±‡∏Å‡∏ô‡∏∞‡∏ö‡∏≠‡∏™!');
                
                currentBalances.essential -= amt;
                transactions.push({ id: Date.now(), type:'expense', dateObj: new Date().toISOString(), tank: 'essential', amount: amt, cat: 'üò¥ ‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏°‡∏≤‡∏ß‡∏±‡∏ô‡∏Ç‡∏µ‡πâ‡πÄ‡∏Å‡∏µ‡∏¢‡∏à', note: '‡∏Ç‡∏µ‡πâ‡πÄ‡∏Å‡∏µ‡∏¢‡∏à‡∏à‡∏î', payMethod: '‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢/‡πÇ‡∏≠‡∏ô', emotion: null, needRating: 3, creditPaid: false, isCross: false });
                alert(`‡∏´‡∏±‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏°‡∏≤ ‡∏ø${amt} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡πÑ‡∏õ‡∏ô‡∏≠‡∏ô‡∏ï‡∏µ‡∏û‡∏∏‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ö‡∏≠‡∏™!`);
            }
            
            inventory = inventory.filter(x => x.id !== id); 
            saveStorage();
            updateUI(); 
            showToast(`‚úÖ ‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå "${name}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!`); 
        } 
    }

    function toggleEditCat() { isEditCatMode = !isEditCatMode;
        document.getElementById('editCatBtn').innerText = isEditCatMode ? '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' : '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'; document.getElementById('editCatBtn').style.background = isEditCatMode ? 'var(--danger)' : 'transparent'; document.getElementById('editCatBtn').style.color = isEditCatMode ?
        'white' : 'var(--espresso)'; renderCategories(); }
    function renderCategories() {
        let grid = document.getElementById('homeCategories');
        grid.innerHTML = '';
        customCats.forEach(c => {
            let delBtn = isEditCatMode ? `<div class="delete-btn" onclick="event.stopPropagation(); deleteCategory(${c.id})">‚úï</div>` : '';
            grid.innerHTML += `<div class="cat-btn" onclick="openExpenseModal('${c.name}', '${c.tank}')">${delBtn}<div class="cat-icon">${c.icon}</div><div class="cat-name">${c.name}</div></div>`;
        });
        grid.innerHTML += `<div class="cat-btn add-new" onclick="openModal('addCatModal')"><div class="cat-icon" style="color:#888;">+</div><div class="cat-name">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</div></div>`;
    }
    function saveNewCategory() { let n=document.getElementById('newCatName').value; let i=document.getElementById('newCatIcon').value||'üìå';
        let t=document.getElementById('newCatTank').value; if(n){customCats.push({id:Date.now(),name:n,icon:i,tank:t}); updateUI(); closeModal('addCatModal');} }
    function deleteCategory(id) { customCats = customCats.filter(c => c.id !== id); updateUI();
    }

    function renderMonthlyQuest() {
        let ql = document.getElementById('questList');
        let monthlyHTML = `
            <div class="quest-item" style="background: #dcfce7; border: 1px solid #86efac; margin-bottom: 10px;">
                <div style="display:flex; gap:10px; align-items:center;">
                    <button class="btn-main" style="width:auto; padding:4px 8px; font-size:11px; margin:0; background:#166534;"
                    onclick="claimMonthlyGrowth()">‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏°</button>
                    <div><strong>üåü ‡πÄ‡∏Ñ‡∏ß‡∏™‡∏û‡∏¥‡πÄ‡∏®‡∏©: ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏ï‡∏∞‡πÄ‡∏á‡∏¥‡∏ô Growth</strong><br><span style="color:#166534; font-size:10px;">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô Growth ‡∏£‡∏±‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™ 500 ‡πÅ‡∏ï‡πâ‡∏°</span></div>
                </div>
            </div>`;
        ql.insertAdjacentHTML('afterbegin', monthlyHTML);
    }

    function claimMonthlyGrowth() {
        if(stats.monthlyGrowthTouched) {
            alert('‡πÄ‡∏™‡∏µ‡∏¢‡πÉ‡∏à‡∏î‡πâ‡∏ß‡∏¢‡∏ö‡∏≠‡∏™! ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ö‡∏≠‡∏™‡∏î‡∏∂‡∏á‡πÄ‡∏á‡∏¥‡∏ô Growth ‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏≠‡∏î‡πÑ‡∏î‡πâ‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏ô‡∏∞ ‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö');
        } else {
            userPoints += 500;
            stats.monthlyGrowthTouched = true;
            saveStorage(); updateUI();
            showToast('üéâ ‡∏£‡∏±‡∏ö 500 ‡πÅ‡∏ï‡πâ‡∏°! ‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å‡∏ö‡∏≠‡∏™‡∏ó‡∏µ‡πà‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï!');
        }
    }

    function initQuests() {
        if(!activeQuests || activeQuests.length === 0) {
            activeQuests = [];
            activeQuests.push(getRandomQuest([])); activeQuests.push(getRandomQuest([activeQuests[0].id]));
        }
    }
    function getRandomQuest(excludeIds) {
        let available = questPool.filter(q => !excludeIds.includes(q.id));
        if(available.length === 0) return {...questPool[0], done: false, id: Date.now() + Math.random()}; 
        let r = Math.floor(Math.random() * available.length);
        return {...available[r], done: false, id: Date.now() + Math.random()};
    }
    function renderQuests() {
        let ql = document.getElementById('questList');
        ql.innerHTML = '';
        renderMonthlyQuest(); // ‡πÅ‡∏ó‡∏£‡∏Å‡πÄ‡∏Ñ‡∏ß‡∏™‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
        activeQuests.forEach((q, idx) => {
            let chk = q.done ? 'checked' : ''; let classes = q.done ? 'quest-item completed' : 'quest-item';
            ql.innerHTML += `<div class="${classes}"><div style="display:flex; gap:10px; align-items:center;"><input type="checkbox" ${chk} onchange="toggleQuest(${idx}, this.checked)"> <div><strong>${q.title}</strong><br><span style="color:var(--gray-text); font-size:10px;">üéÅ +${q.pts} ‡πÅ‡∏ï‡πâ‡∏°</span></div></div> <button class="skip-btn" onclick="skipQuest(${idx})">üîÑ</button></div>`;
        });
    }
    function toggleQuest(index, isDone) {
        if(!isDone) return;
        let q = activeQuests[index]; q.done = true; userPoints += q.pts; showToast(`üéâ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå! ‡∏£‡∏±‡∏ö +${q.pts} ‡πÅ‡∏ï‡πâ‡∏°`); renderQuests();
        setTimeout(() => { skipQuest(index); }, 800);
    }
    function skipQuest(index) { let excludeIds = activeQuests.map(x=>x.id); activeQuests[index] = getRandomQuest(excludeIds);
        updateUI(); }
    function addCustomQuest() {
        let n = document.getElementById('cqName').value;
        let p = parseInt(document.getElementById('cqPts').value) || 50;
        if(n) { let newQ = {id: Date.now(), title: n, pts: p, done: false}; questPool.push(newQ);
        activeQuests[0] = newQ; updateUI(); closeModal('customQuestModal'); showToast('‡∏•‡∏∏‡∏¢‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!'); }
    }

    function openExpenseModal(cat, tank, presetAmount = null) {
        if(isEditCatMode) return;
        activeExpenseCat = cat; document.getElementById('expenseTitle').innerText = `‡∏à‡πà‡∏≤‡∏¢: ${cat}`;
        document.getElementById('exTank').value = tank; document.getElementById('exAmount').value = presetAmount || '';
        document.getElementById('exNote').value = '';
        document.getElementById('exPayMethod').value = '‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢/‡πÇ‡∏≠‡∏ô';
        
        // Reset checkbox ‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏°‡∏∏‡∏ô
        if(document.getElementById('isReimbursable')) { 
            document.getElementById('isReimbursable').checked = false; 
            document.getElementById('reimbursableDiv').style.display = 'none'; 
            document.getElementById('exReimbursableAmt').value = '';
            document.getElementById('exLendTo').value = '';
        }

        toggleInstallmentInput(); checkExpenseLogic(); openModal('expenseModal');
    }
    
    function toggleInstallmentInput() {
        let payMethod = document.getElementById('exPayMethod').value;
        if(payMethod === '‡∏ú‡πà‡∏≠‡∏ô (BNPL)' || payMethod === '‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï') {
            document.getElementById('installmentDiv').style.display = 'block';
        } else {
            document.getElementById('installmentDiv').style.display = 'none';
        }
    }

    function checkExpenseLogic() {
        let amt = parseFloat(document.getElementById('exAmount').value) || 0;
        let pt = document.getElementById('exTank').value;
        document.getElementById('joyTypeDiv').style.display = (pt === 'joy') ? 'block' : 'none';
        document.getElementById('needDiv').style.display = (pt === 'essential') ? 'block' : 'none';

        if(amt > currentBalances[pt]) { 
            document.getElementById('crossTankBox').style.display = 'block';
            document.getElementById('shortfallText').innerText = `‡∏ø${(amt-currentBalances[pt]).toLocaleString()}`;
            let sel = document.getElementById('backupTank'); sel.innerHTML = '';
            ['growth', 'security', 'essential', 'joy'].forEach(k => { if(k!==pt && currentBalances[k] >= (amt-currentBalances[pt])) sel.innerHTML += `<option value="${k}">‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å ${k} (‡∏°‡∏µ ‡∏ø${currentBalances[k]})</option>`; });
        } else document.getElementById('crossTankBox').style.display = 'none';
    }
    
    function submitExpense() {
        let amt = parseFloat(document.getElementById('exAmount').value);
        let pt = document.getElementById('exTank').value; let note = document.getElementById('exNote').value;
        if(!amt) return;

        let payMethod = document.getElementById('exPayMethod').value;
        let emotion = pt === 'joy' ? document.getElementById('exEmotion').value : null;
        let needRating = pt === 'essential' ? parseInt(document.getElementById('exNeedRating').value) : null;
        let joyType = pt === 'joy' ? document.getElementById('exJoyType').value : null;

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏¢‡∏≠‡∏î‡∏£‡∏≠‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô ---
        let isReimbursable = document.getElementById('isReimbursable') && document.getElementById('isReimbursable').checked;
        let reimbursableAmt = isReimbursable ? parseFloat(document.getElementById('exReimbursableAmt').value) || 0 : 0;
        let lendTo = isReimbursable ? document.getElementById('exLendTo').value || '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô' : '';

        if (isReimbursable && reimbursableAmt >= amt) return alert('‡∏ö‡∏≠‡∏™! ‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏Ñ‡∏£‡∏±‡∏ö!');
        // ------------------------------------
        
        if(pt === 'joy' && amt >= 2000) {
            if(joyType === 'small') {
                showGifOverlay('joy_warn');
                setTimeout(() => {
                    let addWl = confirm(`‚ö†Ô∏è ‡∏¢‡∏≠‡∏î ‡∏ø${amt} ‡∏™‡∏π‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏∞!\n‡∏î‡∏∂‡∏á‡∏™‡∏ï‡∏¥‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡∏∏‡∏ì ${userName} ‡∏ú‡∏°‡πÉ‡∏´‡πâ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ô‡∏∞\n‡∏û‡∏±‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ô "‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏î‡∏∂‡∏á‡∏™‡∏ï‡∏¥" 24 ‡∏ä‡∏°. ‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏°?\n\n(‡∏Å‡∏î OK ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≠‡∏á / ‡∏Å‡∏î Cancel ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏≠‡∏°‡πÅ‡∏û‡πâ‡πÑ‡∏°‡πà‡∏ã‡∏∑‡πâ‡∏≠)`);
                    if(addWl) {
                        wishlist.push({id: Date.now(), cat: activeExpenseCat, tank: pt, amount: amt, note, unlockAt: new Date().getTime() + (24*60*60*1000), payMethod, emotion, needRating});
                        updateUI(); closeModal('expenseModal'); showToast('‚è≥ ‡∏î‡∏≠‡∏á‡∏Å‡∏¥‡πÄ‡∏•‡∏™ 24 ‡∏ä‡∏°. ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    }
                }, 500);
            } else {
                let addWl = confirm(`‚ö†Ô∏è ‡∏¢‡∏≠‡∏î ‡∏ø${amt} ‡∏™‡∏π‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏∞!\n‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏é The 24-Hour Rule: ‡∏û‡∏±‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ô "‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏î‡∏∂‡∏á‡∏™‡∏ï‡∏¥" 24 ‡∏ä‡∏°. ‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏°?\n\n(‡∏Å‡∏î OK ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≠‡∏á / ‡∏Å‡∏î Cancel ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏≠‡∏°‡πÅ‡∏û‡πâ‡πÑ‡∏°‡πà‡∏ã‡∏∑‡πâ‡∏≠)`);
                if(addWl) {
                    wishlist.push({id: Date.now(), cat: activeExpenseCat, tank: pt, amount: amt, note, unlockAt: new Date().getTime() + (24*60*60*1000), payMethod, emotion, needRating});
                    updateUI(); closeModal('expenseModal'); showToast('‚è≥ ‡∏î‡∏≠‡∏á‡∏Å‡∏¥‡πÄ‡∏•‡∏™ 24 ‡∏ä‡∏°. ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); 
                }
            }
            return;
        }
        
        executePayment(amt, pt, note, activeExpenseCat, payMethod, emotion, needRating, reimbursableAmt, lendTo);
        if(activeFixedId) { 
            let f = fixedCosts.find(x => x.id === activeFixedId);
            if (f) {
                f.paidThisMonth = true; 
                if (f.isInst) {
                    f.paidM = Math.min(f.totalM, f.paidM + 1); // ‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏•‡∏∞‡∏á‡∏ß‡∏î‡∏à‡∏ô‡πÄ‡∏ï‡πá‡∏°
                }
            }
            activeFixedId = null; 
        }
        
        // Reset checkbox
        if(document.getElementById('isReimbursable')) { 
            document.getElementById('isReimbursable').checked = false; 
            document.getElementById('reimbursableDiv').style.display = 'none'; 
        }
        closeModal('expenseModal');
    }
    
    function executePayment(amt, pt, note, cat, payMethod, emotion, needRating, reimbursableAmt = 0, lendTo = '') {
        let isCross = false;
        let crossReason = null; let bt = null; let pDeduct = amt; let bDeduct = 0;
        
        if(amt > currentBalances[pt]) {
            bt = document.getElementById('backupTank') ? document.getElementById('backupTank').value : null;
            if(!bt) return alert('‡∏•‡∏î‡∏™‡πÄ‡∏õ‡∏Ñ‡∏î‡πà‡∏ß‡∏ô‡∏ö‡∏≠‡∏™! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡∏û‡∏≠‡πÇ‡∏õ‡∏∞‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö');
            crossReason = document.getElementById('crossReason').value;
            
            pDeduct = currentBalances[pt]; bDeduct = amt - currentBalances[pt];
            currentBalances[bt] -= bDeduct; currentBalances[pt] = 0;
            
            stats.crossTankCount++; showToast(`‚ö†Ô∏è ‡πÇ‡∏õ‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å ${bt} (‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${crossReason})`); isCross = true;
            showGifOverlay('crosstank');
        } else { 
            currentBalances[pt] -= amt; 
            showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏á‡∏ö!');
            showGifOverlay('expense_saved');
        }
        
        if (pt === 'growth') stats.monthlyGrowthTouched = true;
        let joyType = pt === 'joy' ? document.getElementById('exJoyType').value : null;
        
        let installments = null;
        if(payMethod === '‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï' || payMethod === '‡∏ú‡πà‡∏≠‡∏ô (BNPL)') {
            let months = payMethod === '‡∏ú‡πà‡∏≠‡∏ô (BNPL)' ? (parseInt(document.getElementById('exInstallmentMonths').value) || 1) : 1;
            let instAmt = amt / months;
            installments = [];
            for(let i=1; i<=months; i++) { installments.push({monthNo: i, amount: instAmt, paid: false}); }
            currentBalances.security += amt;
        }

        // --- ‡∏à‡∏∏‡∏î‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÅ‡∏¢‡∏Å‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏ö‡∏≠‡∏™ ---
        let actualExpense = amt - reimbursableAmt; 
        
        // 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ö‡∏≠‡∏™‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
        transactions.push({ id: Date.now(), type:'expense', dateObj: new Date().toISOString(), tank: pt, amount: actualExpense, cat: cat, note, joyType, isCross, crossReason, backupTank: bt, pDeduct, bDeduct, payMethod, emotion, needRating, installments: installments, creditPaid: false });
        
        // 2. ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏ô‡∏¢‡∏∑‡∏° ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏¢‡∏≠‡∏î‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏£‡∏≠‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå
        if (reimbursableAmt > 0) {
            transactions.push({ id: Date.now()+1, type: 'receivable', dateObj: new Date().toISOString(), tank: pt, amount: reimbursableAmt, note: lendTo, cat: '‡∏£‡∏≠‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô: ' + cat, paid: false });
        }
        // -----------------------------------------------------

        updateUI();
        if(pt === 'joy' || (isCross && bt === 'joy')) updateGoalUI('joy');
        if(pt === 'security' || (isCross && bt === 'security')) updateGoalUI('security');
    }

    function openEditTx(id) {
        let t = transactions.find(x => x.id === id);
        if(!t) return;
        
        document.getElementById('editTxId').value = t.id;
        document.getElementById('editTxAmt').value = t.amount;
        document.getElementById('editTxCat').value = t.cat;
        document.getElementById('editTxNote').value = t.note || '';
        
        if(t.dateObj) {
            let d = new Date(t.dateObj);
            let dateStr = d.toISOString().split('T')[0];
            document.getElementById('editTxDate').value = dateStr;
        }

        openModal('editTxModal'); 
    }
    function saveEditTransaction() {
        let id = parseFloat(document.getElementById('editTxId').value);
        let t = transactions.find(x => x.id === id); 
        if(!t) return;
        
        let newAmt = parseFloat(document.getElementById('editTxAmt').value) || 0;
        if (newAmt <= 0) return alert('‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0');

        if (t.type === 'expense') {
            let oldAmt = t.amount;
            currentBalances[t.tank] += oldAmt; 
            
            if (currentBalances[t.tank] < newAmt) {
                currentBalances[t.tank] -= oldAmt;
                return alert('‡∏ö‡∏≠‡∏™! ‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏£‡∏±‡∏ö');
            }
            currentBalances[t.tank] -= newAmt;
        } 
        else if (t.type === 'income') {
            currentBalances[t.tank] = (currentBalances[t.tank] - t.amount) + newAmt;
        }

        t.dateObj = document.getElementById('editTxDate').value ? new Date(document.getElementById('editTxDate').value).toISOString() : t.dateObj;
        t.cat = document.getElementById('editTxCat').value;
        t.amount = newAmt;
        t.note = document.getElementById('editTxNote').value;

        saveStorage(); updateUI(); closeModal('editTxModal'); 
        openTankHistory(currentActiveGoalTank, document.getElementById('historyTitle').innerText);
        showToast('‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
    }

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡πà‡∏≤ ---
    function openLegacyDebtModal() {
        document.getElementById('ldName').value = '';
        document.getElementById('ldAmt').value = '';
        document.getElementById('ldMonths').value = '1';
        openModal('addLegacyDebtModal');
    }

    function saveLegacyDebt() {
        let name = document.getElementById('ldName').value;
        let amt = parseFloat(document.getElementById('ldAmt').value);
        let months = parseInt(document.getElementById('ldMonths').value) || 1;

        if(!name || !amt || amt <= 0) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö‡∏ö‡∏≠‡∏™!');

        let installments = [];
        for(let i=1; i<=months; i++) { installments.push({monthNo: i, amount: amt, paid: false}); }

        // ‡πÅ‡∏≠‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó legacy_debt (‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏à‡∏∞‡∏°‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô!)
        transactions.push({
            id: Date.now(),
            type: 'legacy_debt',
            dateObj: new Date().toISOString(),
            cat: '‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤: ' + name,
            note: '‡∏¢‡∏Å‡∏¢‡∏≠‡∏î‡∏°‡∏≤',
            amount: amt * months,
            installments: installments
        });

        saveStorage(); updateUI(); closeModal('addLegacyDebtModal');
        showToast('‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏¥‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏û‡∏±‡∏á‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô');
    }
// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏¥‡∏•‡∏õ‡∏£‡∏∞‡∏à‡∏≥ ---
    function openEditFixedModal(id) {
        let f = fixedCosts.find(x => x.id === id);
        if(!f) return;
        document.getElementById('efcId').value = f.id;
        document.getElementById('efcName').value = f.name;
        document.getElementById('efcAmount').value = f.amount;
        document.getElementById('efcIcon').value = f.icon;
        document.getElementById('efcTank').value = f.tank;
        document.getElementById('efcIsInst').checked = f.isInst || false;
        document.getElementById('efcInstDiv').style.display = f.isInst ? 'flex' : 'none';
        document.getElementById('efcTotalM').value = f.totalM || '';
        document.getElementById('efcPaidM').value = f.paidM || '';
        openModal('editFixedModal');
    }

    function saveEditFixedCost() {
        let id = parseInt(document.getElementById('efcId').value);
        let f = fixedCosts.find(x => x.id === id);
        if(!f) return;

        f.name = document.getElementById('efcName').value;
        f.amount = parseFloat(document.getElementById('efcAmount').value) || 0;
        f.icon = document.getElementById('efcIcon').value || 'üßæ';
        f.tank = document.getElementById('efcTank').value;
        f.isInst = document.getElementById('efcIsInst').checked;
        f.totalM = parseInt(document.getElementById('efcTotalM').value) || 0;
        f.paidM = parseInt(document.getElementById('efcPaidM').value) || 0;

        saveStorage(); updateUI(); closeModal('editFixedModal'); showToast('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏¥‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
    }

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤ ---
    function openEditLegacyDebt(id) {
        let t = transactions.find(x => x.id === id);
        if(!t || t.type !== 'legacy_debt') return;
        
        document.getElementById('eldId').value = t.id;
        document.getElementById('eldName').value = t.cat.replace('‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤: ', '');
        
        let unpaid = t.installments.filter(i => !i.paid);
        let amt = unpaid.length > 0 ? unpaid[0].amount : 0;
        
        document.getElementById('eldAmt').value = amt;
        document.getElementById('eldMonths').value = unpaid.length;
        openModal('editLegacyDebtModal');
    }

    function saveEditLegacyDebt() {
        let id = parseFloat(document.getElementById('eldId').value);
        let t = transactions.find(x => x.id === id);
        if(!t) return;

        let name = document.getElementById('eldName').value;
        let amt = parseFloat(document.getElementById('eldAmt').value);
        let remainMonths = parseInt(document.getElementById('eldMonths').value) || 1;

        if(!name || !amt || amt <= 0) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö!');

        t.cat = '‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤: ' + name;
        
        let paidInsts = t.installments.filter(i => i.paid);
        let newInsts = [...paidInsts];
        let startMonthNo = paidInsts.length > 0 ? paidInsts[paidInsts.length - 1].monthNo + 1 : 1;
        
        for(let i=0; i<remainMonths; i++) {
            newInsts.push({ monthNo: startMonthNo + i, amount: amt, paid: false });
        }
        
        t.installments = newInsts;
        t.amount = newInsts.reduce((sum, i) => sum + i.amount, 0); 

        saveStorage(); updateUI(); closeModal('editLegacyDebtModal'); showToast('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
    }

    // --- ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï undoTransaction ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ---
    function undoTransaction(id) {
        let t = transactions.find(x => x.id === id);
        if(!t) return;
        if(!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ "${t.cat}" ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°? ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ`)) return;

        try {
            if(t.type === 'expense') {
                let refundMain = (t.pDeduct !== undefined ? t.pDeduct : t.amount);
                
                if(t.installments) {
                    let unpaidSum = t.installments.filter(i => !i.paid).reduce((s,i) => s + i.amount, 0);
                    if (currentBalances.security < unpaidSum) {
                        let shortfall = unpaidSum - currentBalances.security;
                        currentBalances.security = 0; 
                        refundMain -= shortfall; 
                    } else {
                        currentBalances.security -= unpaidSum;
                    }
                }
                currentBalances[t.tank] += Math.max(0, refundMain);
                if(t.isCross && t.backupTank && t.bDeduct) {
                    currentBalances[t.backupTank] += t.bDeduct;
                    stats.crossTankCount = Math.max(0, stats.crossTankCount - 1);
                }
            } 
            else if (t.type === 'income') {
                currentBalances[t.tank] -= t.amount;
            }
            else if (t.type === 'debt_in' || t.type === 'debt_out') {
                if(t.type === 'debt_in') { currentBalances.essential -= t.amount; totalLiability -= t.amount; }
                else { currentBalances.security += t.amount; totalLiability += t.amount; }
            }
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô legacy_debt ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÅ‡∏Ñ‡πà‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡πá‡∏û‡∏≠ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏´‡∏±‡∏Å‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÅ‡∏£‡∏Å

            transactions = transactions.filter(x => x.id !== id);
            updateUI(); closeModal('historyModal');
            showToast('üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        } catch (err) {
            console.error("Undo Error:", err);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö");
        }
    }

    function renderWishlist() {
        document.getElementById('wishlistCount').innerText = wishlist.length;
        let c = document.getElementById('wishlistContainer'); c.innerHTML = '';
        if(wishlist.length===0) c.innerHTML = '<p style="text-align:center; color:#888;">‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤ ‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å‡∏ö‡∏≠‡∏™!</p>';
        let now = new Date().getTime();
        wishlist.forEach(w => {
            let isUn = now >= w.unlockAt;
            let btn = isUn ? `<button class="btn-main" style="padding:5px; background:var(--success);" onclick="buyWishlist(${w.id})">‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏•‡∏¢!</button>` 
                           : `<button class="btn-main" style="padding:5px; background:#ddd; color:#888;" disabled>‡∏£‡∏≠ 24h</button> <button class="btn-outline" style="padding:5px; font-size:10px;" onclick="devSkipTime(${w.id})">[Dev:‡∏Ç‡πâ‡∏≤‡∏°]</button>`;
            c.innerHTML += `<div class="wishlist-item"><h4>${w.cat} (‡∏ø${w.amount})</h4><div style="display:flex; gap:10px; margin-top:5px;"><button class="btn-outline" style="padding:5px; color:var(--danger); border-color:var(--danger);" onclick="deleteWishlist(${w.id}, ${w.amount})">‡∏ó‡∏¥‡πâ‡∏á (‡∏ä‡∏ô‡∏∞‡∏Å‡∏¥‡πÄ‡∏•‡∏™)</button>${btn}</div></div>`;
        });
    }
    function buyWishlist(id) { 
        let w = wishlist.find(x=>x.id===id);
        if(!w) return; 
        wishlist = wishlist.filter(x=>x.id!==id); 
        stats.temptationYieldedCount++;
        executePayment(w.amount, w.tank, w.note, w.cat, w.payMethod, w.emotion, w.needRating);
        renderWishlist(); closeModal('wishlistModal');
    }
    function deleteWishlist(id, amt) { 
        wishlist = wishlist.filter(x=>x.id!==id);
        stats.savedFromTemptation += amt; 
        stats.temptationAbandonedCount++;
        userPoints += 10; 
        renderWishlist(); showToast('üéâ ‡∏ä‡∏ô‡∏∞‡∏Å‡∏¥‡πÄ‡∏•‡∏™‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß! ‡∏£‡∏±‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™ 10 ‡πÅ‡∏ï‡πâ‡∏°'); saveStorage();
        showGifOverlay('wishlist_delete');
    }
    function devSkipTime(id) { 
        let w = wishlist.find(x=>x.id===id);
        w.unlockAt = 0; renderWishlist(); 
        showGifOverlay('wishlist_skip');
    }

    function renderFixedCosts() {
        let list = document.getElementById('fixedCostList');
        list.innerHTML = ''; let totalFixed = 0;
        
        fixedCosts.forEach(f => {
            totalFixed += f.amount;
            
            let titleText = f.name;
            let subText = `<span class="tank-badge bg-${f.tank}" style="margin-left:0;">${f.tank}</span>`;
            let progressHTML = '';
            let btn = f.paidThisMonth ? `<span style="color:var(--success); font-size:12px; font-weight:bold;">‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚úîÔ∏è</span>` : `<button class="btn-outline" onclick="payFixedBtn(${f.id})">‡∏à‡πà‡∏≤‡∏¢‡∏ö‡∏¥‡∏•</button>`;
            
            if (f.isInst && f.totalM > 0) {
                let pct = (f.paidM / f.totalM) * 100;
                progressHTML = `
                <div style="margin-top: 12px; display: flex; align-items: center; gap: 8px;">
                    <div style="flex: 1; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);">
                        <div style="height: 100%; width: ${pct}%; background: linear-gradient(90deg, #38bdf8, #0284c7); border-radius: 3px;"></div>
                    </div>
                    <span style="font-size: 11px; color: #0284c7; font-weight: 600; white-space: nowrap;">‡∏á‡∏ß‡∏î ${f.paidM}/${f.totalM}</span>
                </div>`;
                if (f.paidM >= f.totalM) btn = `<span style="color:var(--success); font-size:12px; font-weight:bold;">üéâ ‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß!</span>`;
            }

            // ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà
            let editBtn = `<span style="color:var(--bleu-porcelaine); cursor:pointer; font-weight:bold; font-size:12px; margin-right:8px;" onclick="openEditFixedModal(${f.id})">[‡πÅ‡∏Å‡πâ]</span>`;
            let delBtn = `<span style="color:var(--danger); cursor:pointer; font-weight:bold; font-size:16px;" onclick="deleteFixedCost(${f.id})">‚úï</span>`;
           
            list.innerHTML += `
            <div class="list-item" style="display:flex; flex-direction:column; align-items:stretch; padding: 15px 0;">
                <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                    <div class="list-info" style="display:flex; align-items:center; gap:10px; flex:1; min-width:0; padding-right:10px;">
                        <span style="font-size:24px; flex-shrink:0;">${f.icon}</span>
                        <div style="min-width:0;">
                            <h4 style="margin:0; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${titleText}</h4>
                            <div style="margin-top:4px;">${subText}</div>
                        </div>
                    </div>
                    <div style="display:flex; align-items:center; flex-shrink:0;">
                        <span style="font-weight:bold; color:var(--terre-cuite); font-size:14px; margin-right:10px;">‡∏ø${f.amount.toLocaleString()}</span>
                        ${btn}
                        <div style="display:flex; align-items:center; margin-left:10px; border-left:1px solid #ddd; padding-left:10px;">
                            ${editBtn} ${delBtn}
                        </div>
                    </div>
                </div>
                ${progressHTML}
            </div>`;
        });
        
        let pct = totalIncomeThisMonth > 0 ? (totalFixed / totalIncomeThisMonth) * 100 : 0;
        document.getElementById('fixedPctTxt').innerText = pct.toFixed(1) + '%';
        document.getElementById('fixedPctBar').style.width = Math.min(100, pct) + '%'; 
        document.getElementById('fixedPctBar').style.background = pct > 15 ? 'var(--danger)' : 'var(--terre-cuite)';
    }
    function updateFixedCostAmt(id, val) { let item = fixedCosts.find(f => f.id === id);
        if(item && val >= 0) { item.amount = parseFloat(val); updateUI();
    } }
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏¥‡∏• ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
   function openAddFixedModal() {
        document.getElementById('fcName').value = '';
        document.getElementById('fcAmount').value = '';
        document.getElementById('fcIcon').value = ''; 
        document.getElementById('fcTank').value = 'essential';
        
        // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞
        document.getElementById('fcIsInst').checked = false;
        document.getElementById('fcInstDiv').style.display = 'none';
        document.getElementById('fcTotalM').value = '';
        document.getElementById('fcPaidM').value = '';
        
        openModal('addFixedModal');
    }
    function saveFixedCost() { 
        let n=document.getElementById('fcName').value; 
        let a=parseFloat(document.getElementById('fcAmount').value); 
        let i=document.getElementById('fcIcon').value||'üßæ'; 
        let t=document.getElementById('fcTank').value; 
        
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞
        let isInst = document.getElementById('fcIsInst').checked;
        let totalM = parseInt(document.getElementById('fcTotalM').value) || 0;
        let paidM = parseInt(document.getElementById('fcPaidM').value) || 0;

        if(n && a){
            fixedCosts.push({
                id: Date.now(), name: n, icon: i, amount: a, tank: t, paidThisMonth: false,
                isInst: isInst, totalM: totalM, paidM: paidM // <-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
            }); 
            updateUI();
            closeModal('addFixedModal');
        } 
    }
    function deleteFixedCost(id) { if(confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ?')) { fixedCosts = fixedCosts.filter(f => f.id !== id); updateUI();
    } }
    function payFixedBtn(id) { let item = fixedCosts.find(f => f.id === id); activeFixedId = id;
        openExpenseModal(item.name, item.tank, item.amount); }

    function renderYearlyFunds() {
        let list = document.getElementById('yearlyFundList');
        list.innerHTML = '';
        yearlyFunds.forEach(y => {
            if(y.paidMonths === undefined) y.paidMonths = 0;
            if(y.monthlyVal === undefined) y.monthlyVal = Math.round(y.amount / 12);
            
            let dots = ''; for(let i=0; i<12; i++) { dots += `<div class="sinking-dot ${i < y.paidMonths ? 'filled' : ''}"></div>`; }
            // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏°‡∏µ Dropdown ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÇ‡∏ú‡∏•‡πà‡∏°‡∏≤‡∏Ç‡πâ‡∏≤‡∏á‡πÜ
        let doneBtn = 
            y.paidMonths >= 12 ? `<span style="color:var(--success); font-size:12px; font-weight:bold;">‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß!</span>` : 
            `<div style="display:flex; align-items:center; gap:5px;">
                <select id="ySource-${y.id}" style="font-size:11px; padding:2px; border-radius:5px; border:1px solid #cbd5e1; outline:none; background:white;">
                    <option value="essential">‡∏à‡∏≤‡∏Å Essential</option>
                    <option value="joy">‡∏à‡∏≤‡∏Å Joy</option>
                </select>
                <button class="btn-outline" style="padding:4px 8px; border-color:var(--bleu-porcelaine); color:var(--bleu-porcelaine);" onclick="addToYearly(${y.id})">+ ‡∏´‡∏¢‡∏≠‡∏î 1 ‡∏á‡∏ß‡∏î</button>
            </div>`;

            list.innerHTML += `<div style="background:white; padding:15px; border-radius:12px; margin-top:10px; border:1px solid #cbd5e1;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><b>${y.name}</b> <span style="font-size:13px; color:var(--bleu-porcelaine); font-weight:bold;">‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà ${y.paidMonths}/12</span></div>
                <div class="sinking-dots">${dots}</div>
                <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-size:11px; color:var(--gray-text);">‡∏´‡∏±‡∏Å‡∏á‡∏ß‡∏î‡∏•‡∏∞: <input type="number" class="inline-edit-input" style="width:60px; padding:2px 4px; font-size:12px;" value="${y.monthlyVal}" onchange="updateYMonthVal(${y.id}, this.value)"></div>
                    ${doneBtn}
                </div>
            </div>`;
        });
    }
    function updateYMonthVal(id, val) { let y = yearlyFunds.find(x=>x.id===id); if(y && val>=0) { y.monthlyVal = parseFloat(val); saveStorage(); } }
    function addToYearly(id) {
        let y = yearlyFunds.find(x=>x.id===id);
        
        // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏ö‡∏≠‡∏™‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÑ‡∏´‡∏ô
        let sourceTank = document.getElementById(`ySource-${y.id}`).value;
        
        if(currentBalances[sourceTank] < y.monthlyVal) return alert(`‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ ${sourceTank} ‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏´‡∏¢‡∏≠‡∏î‡∏Ñ‡∏£‡∏±‡∏ö ‡∏î‡∏∂‡∏á‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞!`);
        
        // ‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡∏û‡∏±‡∏Å‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà Security ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏õ‡∏µ
        currentBalances[sourceTank] -= y.monthlyVal; 
        currentBalances.security += y.monthlyVal;
        
        y.current += y.monthlyVal; 
        y.paidMonths += 1; 
        updateUI(); 
        showToast(`‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà ${y.paidMonths} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å ${sourceTank})!`);
    }
    function saveYearlyFund() { let n=document.getElementById('yName').value; let a=parseFloat(document.getElementById('yAmount').value); if(n&&a){yearlyFunds.push({id:Date.now(), name:n, amount:a, current:0, paidMonths:0, monthlyVal: Math.round(a/12)});
        updateUI(); closeModal('addYearlyModal');} }

    function editGoal() {
        document.getElementById('goalDisplay').style.display = 'none';
        document.getElementById('goalEdit').style.display = 'block'; document.getElementById('goalActionBtn').style.display = 'none';
        if(currentActiveGoalTank === 'joy') { document.getElementById('goalNameInput').value = joyGoal.name; document.getElementById('goalTargetInput').value = joyGoal.target;
        } 
        else { document.getElementById('goalNameInput').value = secGoal.name; document.getElementById('goalTargetInput').value = secGoal.target;
        }
    }
    function saveGoal() {
        let name = document.getElementById('goalNameInput').value;
        let target = parseFloat(document.getElementById('goalTargetInput').value);
        if(name && target) { if(currentActiveGoalTank === 'joy') joyGoal = {name, target}; else secGoal = {name, target};
        saveStorage(); }
        document.getElementById('goalEdit').style.display = 'none'; document.getElementById('goalDisplay').style.display = 'block'; updateGoalUI(currentActiveGoalTank);
    }
    function claimGoal() {
        let t = currentActiveGoalTank;
        let g = t === 'joy' ? joyGoal : secGoal;
        if(confirm(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢‡∏ö‡∏≠‡∏™! ‡∏à‡∏∞‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô ‡∏ø${g.target.toLocaleString()} ‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "${g.name}" ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?`)) {
            currentBalances[t] -= g.target;
            userPoints += 500;
            transactions.push({ id: Date.now(), type:'expense', dateObj: new Date().toISOString(), tank: t, amount: g.target, cat: '‡∏û‡∏¥‡∏ä‡∏¥‡∏ï‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢!', note: g.name, creditPaid: false });
            showToast('‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏£‡∏±‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™ 500 ‡πÅ‡∏ï‡πâ‡∏° üéâ');
            updateUI(); openTankHistory(t, t === 'joy' ? 'Joy (‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï)' : 'Security (‡∏™‡∏≥‡∏£‡∏≠‡∏á)');
        }
    }
    function updateGoalUI(tank) {
        if(tank !== 'joy' && tank !== 'security') return;
        let goalObj = tank === 'joy' ? joyGoal : secGoal; 
        let bal = currentBalances[tank];
        let color = tank === 'joy' ? 'var(--eau-trouble)' : 'var(--miel-dore)';
        let warnText = tank === 'joy' ? '‚ö†Ô∏è ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏ö‡∏≠‡∏™! ‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠ Small Win ‡∏à‡∏∏‡∏Å‡∏à‡∏¥‡∏Å ‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏´‡∏•‡∏≠‡∏î‡∏ô‡∏µ‡πâ‡∏•‡∏î‡∏•‡∏á‡∏ô‡∏∞' : '‚ö†Ô∏è ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏ö‡∏≠‡∏™! ‡∏´‡∏≤‡∏Å‡∏î‡∏∂‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏õ‡πÉ‡∏ä‡πâ ‡∏´‡∏•‡∏≠‡∏î‡∏à‡∏∞‡∏•‡∏î‡∏•‡∏á';

        document.getElementById('goalHeaderTxt').innerText = tank === 'joy' ? 'üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ Big Win' : 'üõ°Ô∏è ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô';
        document.getElementById('goalNameTxt').innerText = goalObj.name; 
        document.getElementById('goalTargetTxt').innerText = '‡∏ø' + goalObj.target.toLocaleString();
        document.getElementById('goalCurrTxt').innerText = '‡∏ø' + bal.toLocaleString();
        document.getElementById('goalWarnTxt').innerText = warnText;

        let pct = goalObj.target > 0 ? (bal / goalObj.target) * 100 : 0;
        let bar = document.getElementById('goalBar'); 
        bar.style.width = `${Math.min(100, Math.max(0, pct))}%`; 
        bar.innerText = pct > 5 ? Math.round(pct) + '%' : '';
        bar.style.background = pct >= 100 ? 'var(--success)' : `linear-gradient(90deg, var(--miel-dore), ${color})`;
        
        if(pct >= 100) {
            document.getElementById('goalActionBtn').style.display = 'block';
            if(tank === 'joy' && !stats.achievedJoy) { stats.achievedJoy = true; saveStorage(); showGifOverlay('goal'); }
            if(tank === 'security' && !stats.achievedSec) { stats.achievedSec = true; saveStorage(); showGifOverlay('goal'); }
        } else {
            document.getElementById('goalActionBtn').style.display = 'none';
            if(tank === 'joy') stats.achievedJoy = false; if(tank === 'security') stats.achievedSec = false;
        }
    }
    
    function openTankHistory(tankId, tankName) {
        currentActiveGoalTank = tankId;
        document.getElementById('historyTitle').innerText = tankName;
        document.getElementById('historyDesc').innerHTML = tankDesc[tankId] || "";
        document.getElementById('historyBalance').innerText = '‡∏ø' + currentBalances[tankId].toLocaleString();

        let gs = document.getElementById('goalSection');
        let gps = document.getElementById('growthPortfolioSection');
        gs.style.display = (tankId === 'joy' || tankId === 'security') ? 'block' : 'none';
        gps.style.display = (tankId === 'growth') ? 'block' : 'none';
        
        if(tankId === 'joy' || tankId === 'security') updateGoalUI(tankId);
        if(tankId === 'growth') {
            let age = userAge > 0 ? userAge : 30;
            let highRisk = 110 - age;
            let lowRisk = 100 - highRisk;
            if(highRisk < 0) highRisk = 0; if(lowRisk < 0) lowRisk = 0;
            document.getElementById('portAgeDisplay').innerText = age;
            document.getElementById('portHighPct').innerText = highRisk + '%'; 
            document.getElementById('portLowPct').innerText = lowRisk + '%';
            document.getElementById('portBar').style.width = highRisk + '%';
        }

        let filteredTx = transactions.filter(t => t.tank === tankId && (t.type === 'expense' || t.type === 'income'));
        let list = document.getElementById('historyList'); 
        list.innerHTML = '';
        if(filteredTx.length === 0) list.innerHTML = '<li style="text-align:center; padding:20px; color:#888;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</li>';
        
        let totals = {};
        [...filteredTx].reverse().forEach(t => {
            let d = new Date(t.dateObj).toLocaleDateString('th-TH');
            let n = t.note ? ` | ${t.note}` : '';
            let isExp = t.type === 'expense';
            let amtColor = isExp ? 'var(--danger)' : 'var(--success)';
            let sign = isExp ? '-' : '+';

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            list.innerHTML += `
            <li class="list-item" id="tx-row-${t.id}">
                <div class="list-info" id="tx-display-${t.id}">
                    <h4>${t.cat}</h4>
                    <p>${d}${n}</p>
                </div>
                <div style="display:flex; align-items:center; gap:5px;" id="tx-action-${t.id}">
                    <span class="list-amount" style="color:${amtColor}">${sign}‡∏ø${t.amount.toLocaleString()}</span>
                    <button onclick="enableInlineEdit(${t.id})" style="border:none; background:transparent; color:var(--bleu-porcelaine); font-size:12px; cursor:pointer;">[‡πÅ‡∏Å‡πâ]</button>
                    <button onclick="undoTransaction(${t.id})" style="border:none; background:transparent; color:var(--gray-text); font-size:12px; cursor:pointer;">[‡∏•‡∏ö]</button>
                </div>
            </li>`;
            if(isExp) totals[t.cat] = (totals[t.cat] || 0) + t.amount;
        });

        let ctx = document.getElementById('tankChart').getContext('2d'); 
        if(tankChartInstance) tankChartInstance.destroy();
        if(Object.keys(totals).length > 0) {
            tankChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(totals), datasets: [{ data: Object.values(totals), backgroundColor: ['#a13a1e','#a79058','#8babca','#f1c166', '#542916'] }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins:{ legend:{position:'right'} } } });
        }
        openModal('historyModal');
    }

    function enableInlineEdit(id) {
        let t = transactions.find(x => x.id === id);
        if(!t) return;

        let row = document.getElementById(`tx-row-${id}`);
        
        // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á input type="date" ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ (YYYY-MM-DD)
        let dStr = "";
        if(t.dateObj) dStr = new Date(t.dateObj).toISOString().split('T')[0];

        row.innerHTML = `
            <div style="flex:1; display:flex; flex-direction:column; gap:5px;">
                <input type="date" id="edit-date-${id}" value="${dStr}" style="width:90%; padding:4px; border-radius:5px; border:1px solid #ccc; font-size:13px; color:var(--bleu-porcelaine); font-family:'Kanit';">
                <input type="text" id="edit-cat-${id}" value="${t.cat}" style="width:90%; padding:4px; border-radius:5px; border:1px solid #ccc; font-size:13px;">
                <input type="number" id="edit-amt-${id}" value="${t.amount}" style="width:90%; padding:4px; border-radius:5px; border:1px solid #ccc; font-size:13px;">
            </div>
            <div style="display:flex; flex-direction:column; gap:5px;">
                <button onclick="saveInlineEdit(${id})" style="background:var(--success); color:white; border:none; border-radius:5px; padding:2px 8px; font-size:11px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <button onclick="openTankHistory('${currentActiveGoalTank}', '${document.getElementById('historyTitle').innerText}')" style="background:var(--gray-text); color:white; border:none; border-radius:5px; padding:2px 8px; font-size:11px;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        `;
    }

    function saveInlineEdit(id) {
        let t = transactions.find(x => x.id === id);
        if(!t) return;

        let newDateStr = document.getElementById(`edit-date-${id}`).value;
        let newCat = document.getElementById(`edit-cat-${id}`).value;
        let newAmt = parseFloat(document.getElementById(`edit-amt-${id}`).value);

        if(!newCat || isNaN(newAmt) || newAmt <= 0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');

        if (t.type === 'expense') {
            currentBalances[t.tank] += t.amount;
            if (currentBalances[t.tank] < newAmt) {
                currentBalances[t.tank] -= t.amount;
                return alert('‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö');
            }
            currentBalances[t.tank] -= newAmt;
            
            if (t.installments && t.installments.length > 0) {
                let totalMonths = t.installments.length;
                let newPerMonth = Math.floor(newAmt / totalMonths);
                let remainingDiff = newAmt - (newPerMonth * totalMonths);
                
                t.installments = t.installments.map((ins, idx) => {
                    if (!ins.paid) {
                        let updatedAmt = (idx === totalMonths - 1) ? newPerMonth + remainingDiff : newPerMonth;
                        return { ...ins, amount: updatedAmt };
                    }
                    return ins; 
                });
            }
        } else if (t.type === 'income') {
            currentBalances[t.tank] = (currentBalances[t.tank] - t.amount) + newAmt;
        }

        // ‡πÄ‡∏ã‡∏ü‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ)
        t.dateObj = newDateStr ? new Date(newDateStr).toISOString() : t.dateObj;
        t.cat = newCat;
        t.amount = newAmt;

        saveStorage(); 
        updateUI(); 
        
        openTankHistory(currentActiveGoalTank, document.getElementById('historyTitle').innerText);
        showToast('‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
    }

    function processBorrow() { 
        let a = parseFloat(document.getElementById('borrowAmt').value);
        let n = document.getElementById('borrowNote').value || '‡∏¢‡∏∑‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'; 
        if(!a) return; 
        
        totalLiability += a; 
        currentBalances.essential += a;
        transactions.push({ id: Date.now(), type: 'debt_in', tank: 'essential', amount: a, cat: '‡∏¢‡∏∑‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏≤‡πÇ‡∏õ‡∏∞', note: n, dateObj: new Date().toISOString() });
        updateUI(); renderDebtChart(); closeModal('addDebtModal'); showToast(`üì• ‡∏¢‡∏∑‡∏°‡πÄ‡∏á‡∏¥‡∏ô ${n} ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ Essential ‡πÅ‡∏•‡πâ‡∏ß!`); 
    }
    
    function processPayback() { 
        let a = parseFloat(document.getElementById('paybackAmt').value);
        let l = document.getElementById('paybackLender').value; 
        if(!a) return; 
        
        if(a > currentBalances.security) { 
            alert(`‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô Security ‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏µ‡πâ‡∏ô‡∏∞‡∏ö‡∏≠‡∏™! (‡∏°‡∏µ‡πÅ‡∏Ñ‡πà ‡∏ø${currentBalances.security.toLocaleString()})`);
            return; 
        } 
        
        currentBalances.security -= a;
        totalLiability = Math.max(0, totalLiability - a);
        transactions.push({ id: Date.now(), type: 'debt_out', tank: 'security', amount: a, cat: '‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏µ‡πâ', note: l, dateObj: new Date().toISOString() }); 
        updateUI(); renderDebtChart(); closeModal('payDebtModal');
        showToast(`üì§ ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏´‡∏±‡∏Å‡∏à‡∏≤‡∏Å Security ‡πÅ‡∏•‡πâ‡∏ß!`); 
    }

    function renderDebtLog() {
        let list = document.getElementById('debtLogList');
        list.innerHTML = ''; let debtTx = transactions.filter(t => t.type === 'debt_in' || t.type === 'debt_out'); let lenders = new Set();
        [...debtTx].reverse().forEach(t => { let color = t.type === 'debt_in' ? 'color:#b91c1c' : 'color:#22c55e'; let sign = t.type === 'debt_in' ? '+' : '-'; let d = new Date(t.dateObj).toLocaleDateString('th-TH'); list.innerHTML += `<li class="list-item"><div class="list-info"><h4>${t.cat}</h4><p>${d} | ${t.note}</p></div><div style="display:flex; align-items:center; gap:5px;"><span class="list-amount" style="${color}">${sign}‡∏ø${t.amount.toLocaleString()}</span> <button onclick="undoTransaction(${t.id})" style="border:none; background:transparent; color:var(--gray-text); font-size:12px; cursor:pointer;">[‡∏•‡∏ö]</button></div></li>`; if(t.type === 'debt_in') lenders.add(t.note); });
        let pbSelect = document.getElementById('paybackLender'); pbSelect.innerHTML = ''; if(lenders.size === 0) pbSelect.innerHTML = '<option value="‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>';
        else lenders.forEach(l => pbSelect.innerHTML += `<option value="${l}">${l}</option>`);
    }
    function renderDebtChart() {
        let debtInTx = transactions.filter(t => t.type === 'debt_in');
        let debtOutTx = transactions.filter(t => t.type === 'debt_out'); let lenderBalances = {};
        debtInTx.forEach(t => lenderBalances[t.note] = (lenderBalances[t.note] || 0) + t.amount); debtOutTx.forEach(t => lenderBalances[t.note] = (lenderBalances[t.note] || 0) - t.amount);
        for(let key in lenderBalances) { if(lenderBalances[key] <= 0) delete lenderBalances[key];
        }
        let ctx = document.getElementById('debtChart').getContext('2d'); if(debtChartInstance) debtChartInstance.destroy();
        if(Object.keys(lenderBalances).length === 0) { document.getElementById('debtChart').parentElement.style.display = 'none'; } 
        else { document.getElementById('debtChart').parentElement.style.display = 'flex';
        debtChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(lenderBalances), datasets: [{ data: Object.values(lenderBalances), backgroundColor: ['#ef4444','#f97316','#f59e0b','#10b981'] }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '50%', plugins:{ legend:{position:'right'} } } });
        }
    }

    function applyAiSuggestion(g, s, e, j) {
        document.getElementById('cfgG').value = g;
        document.getElementById('cfgS').value = s;
        document.getElementById('cfgE').value = e;
        document.getElementById('cfgJ').value = j;
        saveConfig();
        showToast('‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ï‡∏≤‡∏° AI ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏ö‡∏≠‡∏™!');
        renderAnalyticsChart('quarter');
    }

    function evaluateHealth() {
        let hDesc = document.getElementById('healthDesc');
        let hBadge = document.getElementById('healthBadge');
        let emergencyPct = secGoal.target > 0 ? currentBalances.security / secGoal.target : 0;
        let dRatio = totalIncomeThisMonth > 0 ? (totalLiability / totalIncomeThisMonth) : (totalLiability > 0 ? 1 : 0);
        let lvl = 3; let bTxt = "‚öñÔ∏è ‡πÄ‡∏•‡πÄ‡∏ß‡∏• 3: ‡∏ó‡∏£‡∏á‡∏ï‡∏±‡∏ß"; let bCol = "#f59e0b";
        let text = "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡∏∂‡∏á‡∏ô‡∏∞‡∏ö‡∏≠‡∏™ ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢!";
        if(dRatio > 0.5 || (emergencyPct < 0.1 && totalLiability > 0)) { lvl=1; bTxt="üö® ‡πÄ‡∏•‡πÄ‡∏ß‡∏• 1: ‡∏ß‡∏¥‡∏Å‡∏§‡∏ï‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô"; bCol="var(--danger)";
        text="‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏°‡∏≤‡∏Å‡∏ö‡∏≠‡∏™! ‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏¢‡∏≠‡∏∞‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á ‡πÄ‡∏•‡∏Ç‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏á‡∏î‡∏ñ‡∏±‡∏á Joy ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ!"; }
        else if(emergencyPct < 0.3) { lvl=2;
        bTxt="‚ö†Ô∏è ‡πÄ‡∏•‡πÄ‡∏ß‡∏• 2: ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á"; bCol="#f97316"; text="‡∏´‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏¢‡∏≠‡∏∞‡πÅ‡∏ï‡πà‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏ô‡∏∞‡∏ö‡∏≠‡∏™ ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡πÄ‡∏ï‡∏¥‡∏°‡∏ñ‡∏±‡∏á Security ‡∏î‡πà‡∏ß‡∏ô‡πÜ"; }
        else if(emergencyPct >= 0.5 && currentBalances.growth > 0) { lvl=4;
        bTxt="üõ°Ô∏è ‡πÄ‡∏•‡πÄ‡∏ß‡∏• 4: ‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á"; bCol="var(--bleu-porcelaine)"; text="‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏∏‡πà‡∏ô‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏≠‡∏±‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÉ‡∏ô Growth ‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏¢‡∏ö‡∏≠‡∏™";
        }
        else if(emergencyPct >= 1 && currentBalances.growth > secGoal.target) { lvl=5;
        bTxt="üöÄ ‡πÄ‡∏•‡πÄ‡∏ß‡∏• 5: ‡∏°‡∏±‡πà‡∏á‡∏Ñ‡∏±‡πà‡∏á‡∏≠‡∏¥‡∏™‡∏£‡∏∞"; bCol="var(--success)"; text="‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏ö‡∏ö! ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å‡∏ö‡∏≠‡∏™ ‡πÄ‡∏Å‡πà‡∏á‡∏™‡∏∏‡∏î‡πÜ"; }

        hBadge.innerText = bTxt;
        hBadge.style.background = bCol; hDesc.innerText = text;
    }

    function renderAnalyticsChart(period) {
        // --- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ï‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ---
        let totalWealth = currentBalances.growth + currentBalances.security + currentBalances.essential + currentBalances.joy;
        if(document.getElementById('totalWealthText')) {
            document.getElementById('totalWealthText').innerText = `‡∏ø${totalWealth.toLocaleString()}`;
            
            let nowTime = new Date();
            let cMonth = nowTime.getMonth(); 
            let cYear = nowTime.getFullYear();

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            let monthInc = transactions.filter(t => {
                let d = new Date(t.dateObj); return (t.type === 'main_income' || t.type === 'income') && d.getMonth() === cMonth && d.getFullYear() === cYear;
            }).reduce((s,t) => s + t.amount, 0);

            let monthExp = transactions.filter(t => {
                let d = new Date(t.dateObj); return t.type === 'expense' && d.getMonth() === cMonth && d.getFullYear() === cYear;
            }).reduce((s,t) => s + t.amount, 0);

            let monthNet = monthInc - monthExp;
            let startOfMonthWealth = totalWealth - monthNet;

            let compareText = "";
            if (monthNet > 0) { compareText = `‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏ï‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ø${startOfMonthWealth.toLocaleString()}): <span style="color:var(--success); font-weight:bold;">+‡∏ø${monthNet.toLocaleString()} üìà</span>`; } 
            else if (monthNet < 0) { compareText = `‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏ï‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ø${startOfMonthWealth.toLocaleString()}): <span style="color:var(--danger); font-weight:bold;">-‡∏ø${Math.abs(monthNet).toLocaleString()} üìâ</span>`; } 
            else { compareText = `‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏ï‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ø${startOfMonthWealth.toLocaleString()}): ‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏° ‚öñÔ∏è`; }
            
            document.getElementById('wealthCompareText').innerHTML = compareText;
        }
        // -----------------------------------------------------
        document.getElementById('btnAnalyticWeek').classList.remove('active');
        document.getElementById('btnAnalyticMonth').classList.remove('active');
        document.getElementById('btnAnalyticQuarter').classList.remove('active'); document.getElementById('btnAnalyticYear').classList.remove('active');
        document.getElementById(`btnAnalytic${period.charAt(0).toUpperCase() + period.slice(1)}`).classList.add('active');
        
        ['btnAnalyticWeek', 'btnAnalyticMonth', 'btnAnalyticQuarter', 'btnAnalyticYear'].forEach(id => {
            document.getElementById(id).style.background = 'transparent'; document.getElementById(id).style.color = 'var(--espresso)';
        });
        document.getElementById(`btnAnalytic${period.charAt(0).toUpperCase() + period.slice(1)}`).style.background = 'var(--espresso)';
        document.getElementById(`btnAnalytic${period.charAt(0).toUpperCase() + period.slice(1)}`).style.color = 'white';

        let now = new Date();
        let periodDays = period === 'week' ? 7 : (period === 'month' ? 30 : (period === 'quarter' ? 90 : 365));
        
        // ‡∏Å‡∏£‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô ‡πÇ‡∏î‡∏¢‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏ö‡∏≠‡∏™ ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏£‡∏≠‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå (receivable)
        let filteredTx = transactions.filter(t => { 
            if(t.type !== 'expense') return false; 
            let diffDays = (now - new Date(t.dateObj)) / (1000 * 3600 * 24); 
            return diffDays <= periodDays; 
        });
        
        let incTxs = transactions.filter(t => { if(t.type !== 'main_income') return false; let diffDays = (now - new Date(t.dateObj)) / (1000 * 3600 * 24); return diffDays <= periodDays; });
        let totalInc = incTxs.reduce((s,t) => s + t.amount, 0);
        let totalExp = filteredTx.reduce((s,t) => s + t.amount, 0);
        let net = totalInc - totalExp;
        
        document.getElementById('sumIncomeText').innerText = `‡∏ø${totalInc.toLocaleString()}`;
        document.getElementById('sumExpenseText').innerText = `‡∏ø${totalExp.toLocaleString()}`;
        let netEl = document.getElementById('sumNetText'); netEl.innerText = `‡∏ø${net.toLocaleString()}`;
        netEl.style.color = net < 0 ? 'var(--danger)' : 'var(--success)';
        
        let pct = totalInc > 0 ? (totalExp / totalInc) * 100 : 0;
        let pctText = document.getElementById('sumPctText');
        pctText.innerText = `‡πÉ‡∏ä‡πâ‡πÑ‡∏õ ${Math.round(pct)}% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö`;
        pctText.style.color = pct > 100 ? 'var(--danger)' : 'var(--gray-text)';

        let idealBox = document.getElementById('idealSalaryBox');
        if(period === 'year' || period === 'quarter') {
            idealBox.style.display = 'block';
            let targetSpendPct = (cfg.e + cfg.j) / 100;
            document.getElementById('idealPctShow').innerText = (cfg.e + cfg.j);
            
            let avgMonthlyExp = 0;
            let expenseTxs = transactions.filter(t=>t.type==='expense');
            if(expenseTxs.length > 0) {
                let minDate = expenseTxs.reduce((min, t) => { let d = new Date(t.dateObj); return d < min ? d : min; }, now);
                let daysActive = (now - minDate)/(1000*3600*24);
                let monthsActive = Math.max(1, daysActive / 30);
                let allTimeExp = expenseTxs.reduce((s,t)=>s+t.amount, 0);
                avgMonthlyExp = allTimeExp / monthsActive;
            }
            let idealSal = targetSpendPct > 0 ? avgMonthlyExp / targetSpendPct : 0;
            document.getElementById('idealSalaryTxt').innerHTML = idealSal > 0 ? `‡∏ø${Math.round(idealSal).toLocaleString()} <span style="font-size:14px;">/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>` : `‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°...`;
        } else {
            idealBox.style.display = 'none';
        }

        let joyTxs = filteredTx.filter(t => t.tank === 'joy');
        let smallWinAmt = joyTxs.filter(t => t.joyType === 'small').reduce((s,t) => s+t.amount, 0);
        let bigWinAmt = joyTxs.filter(t => t.joyType === 'big').reduce((s,t) => s+t.amount, 0);
        let totalJoyFund = currentBalances.joy + smallWinAmt + bigWinAmt;
        let smallWinEatPct = totalJoyFund > 0 ? Math.round((smallWinAmt / totalJoyFund) * 100) : 0;
        let bigWinRemainPct = 100 - smallWinEatPct;
        document.getElementById('insightSmallWin').innerText = `‡∏Å‡∏¥‡∏ô‡∏á‡∏ö‡πÑ‡∏õ ${smallWinEatPct}%`;
        document.getElementById('insightBigWin').innerText = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ${bigWinRemainPct}%`;
        
        let crossTxs = filteredTx.filter(t => t.isCross); document.getElementById('insightCrossCount').innerText = stats.crossTankCount;
        let reasons = {}; crossTxs.forEach(t => { if(t.crossReason) reasons[t.crossReason] = (reasons[t.crossReason] || 0) + 1; });
        let topReason = Object.keys(reasons).length > 0 ? Object.keys(reasons).reduce((a, b) => reasons[a] > reasons[b] ? a : b) : '-';
        document.getElementById('insightCrossReason').innerText = topReason;

        let dayNames = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏Ø', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'];
        let dayCounts = [0,0,0,0,0,0,0];
        filteredTx.forEach(t => { let d = new Date(t.dateObj).getDay(); dayCounts[d] += t.amount; });
        let maxDayIdx = dayCounts.indexOf(Math.max(...dayCounts));
        document.getElementById('insightDay').innerText = Math.max(...dayCounts) > 0 ? dayNames[maxDayIdx] : '-';

        document.getElementById('insightSavedTemptation').innerText = stats.savedFromTemptation.toLocaleString();
        document.getElementById('insightWinTemptCount').innerText = stats.temptationAbandonedCount || 0;
        document.getElementById('insightLoseTemptCount').innerText = stats.temptationYieldedCount || 0;

        let futureMoneySum = transactions.flatMap(t => t.installments || []).filter(i => !i.paid).reduce((s,i) => s + i.amount, 0);
        document.getElementById('insightFutureMoney').innerText = futureMoneySum.toLocaleString();
        
        let futurePct = totalInc > 0 ? (futureMoneySum / totalInc) * 100 : 0;
        let futureAdviceTxt = `‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô ${Math.round(futurePct)}% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö<br>`;
        if (futurePct === 0) futureAdviceTxt += `<span style="color:var(--success);">‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å‡∏ö‡∏≠‡∏™! ‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏¢</span>`;
        else if (futurePct <= 15) futureAdviceTxt += `<span style="color:var(--success);">‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÅ‡∏ï‡πà‡∏Å‡πá‡∏≠‡∏¢‡πà‡∏≤‡∏£‡∏π‡∏î‡πÄ‡∏û‡∏•‡∏¥‡∏ô‡∏ô‡∏∞</span>`;
        else if (futurePct <= 30) futureAdviceTxt += `<span style="color:#f59e0b;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏¢‡∏≠‡∏∞‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞‡∏ö‡∏≠‡∏™! ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏ä‡πá‡∏≠‡∏ï‡∏ô‡∏∞</span>`;
        else futureAdviceTxt += `<span style="color:var(--danger); font-weight:bold;">‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏°‡∏≤‡∏Å! ‡∏¢‡∏∑‡∏°‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡∏°‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 30% ‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏π‡∏î‡∏î‡πà‡∏ß‡∏ô!</span>`;
        document.getElementById('insightFutureAdvice').innerHTML = futureAdviceTxt;

        if(filteredTx.length === 0) { document.getElementById('analyticsChart').style.display = 'none';
        document.getElementById('noDataText').style.display = 'block'; document.getElementById('aiAdviceText').innerText = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏•‡∏¢‡∏ö‡∏≠‡∏™ ‡∏•‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏Ç‡∏≤‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏´‡πâ!"; return; }

        document.getElementById('analyticsChart').style.display = 'block';
        document.getElementById('noDataText').style.display = 'none';
        let totals = {}; filteredTx.forEach(t => totals[t.cat] = (totals[t.cat] || 0) + t.amount);
        let labels = Object.keys(totals);
        let data = Object.values(totals);

        let ctx = document.getElementById('analyticsChart').getContext('2d'); if(analyticsChartInstance) analyticsChartInstance.destroy();
        analyticsChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: labels, datasets: [{ data: data, backgroundColor: ['#a13a1e','#a79058','#8babca','#f1c166', '#542916'], borderWidth: 2, borderColor: '#fbfaf0' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } }, cutout: '55%' } });
        let maxCat = labels[data.indexOf(Math.max(...data))];
        let advice = `üí° ‡∏ö‡∏≠‡∏™‡∏Ñ‡∏£‡∏±‡∏ö! ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏´‡∏•‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏Å‡∏±‡∏ö <strong>${maxCat}</strong> ‡πÄ‡∏¢‡∏≠‡∏∞‡∏™‡∏∏‡∏î‡πÄ‡∏•‡∏¢‡∏ô‡∏∞ ‡∏™‡∏≤‡∏¢‡πÄ‡∏õ‡∏¢‡πå‡πÑ‡∏õ‡πÑ‡∏´‡∏ô!<br>`;
        if (smallWinEatPct > 50) {
            advice += `<br><br>üö® <strong>‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏¥‡πÄ‡∏•‡∏™:</strong> ‡∏ö‡∏≠‡∏™‡πÄ‡∏≠‡∏≤ Small Win ‡∏Å‡∏¥‡∏ô‡∏á‡∏ö Big Win ‡πÑ‡∏õ‡∏ï‡∏±‡πâ‡∏á ${smallWinEatPct}% ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞! ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà‡∏à‡∏∞‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏ô‡∏µ‡πà‡∏¢!`;
        }

        let stressedTxs = filteredTx.filter(t => t.tank === 'joy' && t.emotion && t.emotion.includes('‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î'));
        let stressedSum = stressedTxs.reduce((s,t) => s + t.amount, 0);
        if(stressedSum > 0) {
            advice += `<br><br>üé≠ <strong>‡∏ä‡πâ‡∏≠‡∏õ‡∏ö‡∏≥‡∏ö‡∏±‡∏î:</strong> ‡∏ö‡∏≠‡∏™‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏õ‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏° '‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î' ‡∏ø${stressedSum.toLocaleString()} ‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡∏Æ‡∏µ‡∏•‡πÉ‡∏à‡∏ü‡∏£‡∏µ‡πÜ ‡∏î‡∏π‡∏ö‡πâ‡∏≤‡∏á‡∏ô‡∏∞`;
        }

        let lowNeedTxs = filteredTx.filter(t => t.tank === 'essential' && t.needRating <= 2);
        let lowNeedSum = lowNeedTxs.reduce((s,t) => s + t.amount, 0);
        if(lowNeedSum > 0) {
            advice += `<br><br>‚öñÔ∏è <strong>‡∏£‡∏≠‡∏¢‡∏£‡∏±‡πà‡∏ß‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô:</strong> ‡∏´‡∏±‡∏Å‡∏ñ‡∏±‡∏á Essential ‡πÅ‡∏ï‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏Ñ‡πà 1-2 ‡∏î‡∏≤‡∏ß ‡πÑ‡∏õ ‡∏ø${lowNeedSum.toLocaleString()} ‡∏≠‡∏¢‡πà‡∏≤‡∏´‡∏•‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏™‡∏¥‡∏ö‡∏≠‡∏™!`;
        }

        if(period === 'quarter') {
            let prevQFiltered = transactions.filter(t => { if(t.type !== 'expense') return false; let diffDays = (now - new Date(t.dateObj)) / (1000 * 3600 * 24); return diffDays > 90 && diffDays <= 180; });
            let prevQExp = prevQFiltered.reduce((s,t)=>s+t.amount, 0);
            if(prevQExp > 0) {
                if(totalExp < prevQExp) advice += `<br><br>üìâ <strong>‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å‡∏ö‡∏≠‡∏™!</strong> ‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏ø${(prevQExp - totalExp).toLocaleString()} ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö`;
                else advice += `<br><br>üìà <strong>‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ö‡∏≠‡∏™!</strong> ‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™‡∏ô‡∏µ‡πâ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏ø${(totalExp - prevQExp).toLocaleString()} ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÑ‡∏î‡πâ‡∏î‡∏π‡∏ô‡∏∞`;
            }

            let essTxs = filteredTx.filter(t=>t.tank === 'essential');
            let essSpent = essTxs.reduce((s,t)=>s+t.amount, 0);
            let totalIncQ = incTxs.reduce((s,t)=>s+t.amount, 0);
            let ratedEssTxs = essTxs.filter(t=>t.needRating);
            let avgNeed = ratedEssTxs.length > 0 ? (ratedEssTxs.reduce((s,t)=>s+t.needRating,0) / ratedEssTxs.length) : 0;
            if (totalIncQ > 0) {
                let essSpentPct = (essSpent / totalIncQ) * 100;
                if (essSpentPct > (cfg.e + 5) && avgNeed >= 3.5) { 
                    let newE = Math.min(60, Math.ceil(essSpentPct/5)*5);
                    let diff = newE - cfg.e;
                    let newS = cfg.s; let newG = cfg.g; let newJ = cfg.j;
                    if (newJ > diff && diff > 0) { newJ -= diff; }
                    else if (newG > diff && diff > 0) { newG -= diff; }
                    else if (newS > diff && diff > 0) { newS -= diff; }

                    advice += `<br><br>ü§ñ <strong>AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°:</strong> ‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™‡∏ô‡∏µ‡πâ‡∏ö‡∏≠‡∏™‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏°‡∏ß‡∏î‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏á‡∏ö‡πÑ‡∏õ‡∏ô‡∏∞ (‡πÉ‡∏ä‡πâ‡πÑ‡∏õ ${essSpentPct.toFixed(1)}%) ‡πÅ‡∏ï‡πà‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô ‡∏ö‡∏≠‡∏™‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏ï‡πà‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÜ (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ${avgNeed.toFixed(1)} ‡∏î‡∏≤‡∏ß)<br>üëâ ‡∏ö‡∏≠‡∏™‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ü‡∏∏‡πà‡∏°‡πÄ‡∏ü‡∏∑‡∏≠‡∏¢‡∏´‡∏£‡∏≠‡∏Å ‡πÅ‡∏Ñ‡πà‡∏á‡∏ö‡∏°‡∏±‡∏ô‡∏ï‡∏∂‡∏á‡πÑ‡∏õ! AI ‡∏Ç‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô <strong>Growth ${newG}% - Security ${newS}% - Essential ${newE}% - Joy ${newJ}%</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ö‡∏≠‡∏™‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡πÄ‡∏≠‡∏≤‡πÑ‡∏´‡∏°?`;
                    advice += `<br><button class="btn-main" style="padding:5px 10px; font-size:12px; background:#0ea5e9; margin-top:5px; width:100%;" onclick="applyAiSuggestion(${newG}, ${newS}, ${newE}, ${newJ})">‚ú® ‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</button>`;
                }
            }
        }

        if(stats.crossTankCount >= 3) advice += `<br><br>‚ö†Ô∏è <strong>‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ï‡∏¥:</strong> ‡∏ö‡∏≠‡∏™‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏î‡∏∂‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ö‡πà‡∏≠‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞ ‡∏î‡∏∂‡∏á‡∏™‡∏ï‡∏¥‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏¢‡∏¢‡∏¢!`;

        document.getElementById('aiAdviceText').innerHTML = advice;
    }

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏î‡∏£‡∏≠‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå (Receivables) ---
    function renderReceivables() {
        let list = document.getElementById('receivableList');
        if(!list) return;
        list.innerHTML = '';
        let pendingRx = transactions.filter(t => t.type === 'receivable' && !t.paid);
        if(pendingRx.length === 0) { list.innerHTML = '<li style="font-size:12px; color:#888;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏¥‡∏•‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå (‡∏™‡∏ö‡∏≤‡∏¢‡πÉ‡∏à‡πÑ‡∏î‡πâ‡∏ö‡∏≠‡∏™!)</li>'; return; }
        
        pendingRx.forEach(r => {
            list.innerHTML += `
            <li class="list-item" style="border-bottom:1px dashed #fcd34d;">
                <div class="list-info">
                    <h4 style="margin:0; font-size:13px; color:#b45309;">${r.cat} <span class="tank-badge bg-${r.tank}">${r.tank}</span></h4>
                    <p style="margin:0; font-size:11px; color:#d97706;">‡∏à‡∏≤‡∏Å: ${r.note}</p>
                </div>
                <div style="display:flex; align-items:center; gap:5px;">
                    <span style="color:#d97706; font-weight:bold; font-size:14px;">‡∏ø${r.amount.toLocaleString()}</span>
                    <button class="btn-main" style="width:auto; padding:4px 8px; font-size:10px; background:#d97706; margin:0;" onclick="resolveReceivable(${r.id})">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß</button>
                </div>
            </li>`;
        });
    }

    function resolveReceivable(id) {
        let r = transactions.find(t => t.id === id);
        if(r && confirm(`‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡∏ø${r.amount} ‡∏à‡∏≤‡∏Å ${r.note} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°? (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏≠‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ ${r.tank} ‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)`)) {
            r.paid = true;
            currentBalances[r.tank] += r.amount; 
            saveStorage(); updateUI();
            showToast(`‚úÖ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô ‡∏ø${r.amount} ‡πÄ‡∏Ç‡πâ‡∏≤ ${r.tank} ‡πÅ‡∏•‡πâ‡∏ß!`);
        }
    }

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏≤‡∏¢‡∏ô‡πâ‡∏≥ Sankey ---
    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏≤‡∏¢‡∏ô‡πâ‡∏≥ Sankey ---
    function drawSankey() {
        if (!document.getElementById('view-cashflow').classList.contains('active')) return;
        
        let container = document.getElementById('sankey_basic');
        container.innerHTML = '<p style="color:#888;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≤‡∏¢‡∏ô‡πâ‡∏≥...</p>';
        
        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡πâ‡∏ô‡∏à‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏±‡∏î‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô‡∏ï‡∏±‡∏î‡πÅ‡∏´‡∏ß‡πà‡∏á)
        container.style.justifyContent = "flex-start";

        let data = new google.visualization.DataTable();
        data.addColumn('string', 'From');
        data.addColumn('string', 'To');
        data.addColumn('number', 'Amount (‡∏ø)');

        let rows = [];
        let now = new Date();
        let currentMonth = now.getMonth(); let currentYear = now.getFullYear();

        let monthlyTx = transactions.filter(t => {
            let d = new Date(t.dateObj); return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
        });

        let tankIn = { growth: 0, security: 0, essential: 0, joy: 0 };
        monthlyTx.filter(t => t.type === 'main_income' || t.type === 'income').forEach(t => {
            if(t.type === 'main_income') {
                tankIn.growth += t.amount * (cfg.g/100); tankIn.security += t.amount * (cfg.s/100);
                tankIn.essential += t.amount * (cfg.e/100); tankIn.joy += t.amount * (cfg.j/100);
            } else if (t.type === 'income' && t.tank) {
                tankIn[t.tank] += t.amount;
            }
        });

        let totalIn = tankIn.growth + tankIn.security + tankIn.essential + tankIn.joy;
        if(totalIn <= 0 && monthlyTx.filter(t=>t.type==='expense').length === 0) {
            container.innerHTML = '<p style="text-align:center; padding:20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢‡∏ö‡∏≠‡∏™!</p>'; return;
        }

        // ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡πÉ‡∏´‡πâ‡∏™‡∏±‡πâ‡∏ô‡∏•‡∏á ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡∏ö‡∏Å‡∏±‡∏ô
        if(tankIn.essential > 0) rows.push(['üì• ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö', 'üõí Essential', tankIn.essential]);
        if(tankIn.joy > 0) rows.push(['üì• ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö', 'üéâ Joy', tankIn.joy]);
        if(tankIn.security > 0) rows.push(['üì• ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö', 'üõ°Ô∏è Security', tankIn.security]);
        if(tankIn.growth > 0) rows.push(['üì• ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö', 'üå± Growth', tankIn.growth]);

        let tankExp = { growth: {}, security: {}, essential: {}, joy: {} };
        monthlyTx.filter(t => t.type === 'expense').forEach(t => {
            if(!tankExp[t.tank]) return;
            tankExp[t.tank][t.cat] = (tankExp[t.tank][t.cat] || 0) + t.amount;
        });

        const nameMap = { 'essential': 'üõí Essential', 'joy': 'üéâ Joy', 'security': 'üõ°Ô∏è Security', 'growth': 'üå± Growth' };

        ['essential', 'joy', 'security', 'growth'].forEach(tank => {
            let tName = nameMap[tank];
            let totalSpent = 0;
            for(let cat in tankExp[tank]) {
                if(tankExp[tank][cat] > 0) { rows.push([tName, cat, tankExp[tank][cat]]); totalSpent += tankExp[tank][cat]; }
            }
            let remaining = tankIn[tank] - totalSpent;
            // ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡πÉ‡∏´‡πâ‡∏™‡∏±‡πâ‡∏ô‡∏•‡∏á
            if(remaining > 0) { rows.push([tName, `üí∞ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (${tank})`, remaining]); }
            if(remaining < 0) { rows.push(['‚ö†Ô∏è ‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡∏¥‡∏ô', tName, Math.abs(remaining)]); }
        });

        rows = rows.filter(r => r[2] > 0);
        if(rows.length === 0) { container.innerHTML = '<p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏Ñ‡∏£‡∏±‡∏ö</p>'; return; }

        data.addRows(rows);
        
        let options = {
            width: 800,     // <--- [‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á 800px ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏ö‡∏≠‡∏™‡∏õ‡∏±‡∏î‡∏ô‡∏¥‡πâ‡∏ß‡πÄ‡∏≠‡∏≤
            height: 450,
            sankey: {
                node: { label: { fontName: 'Kanit', fontSize: 13, color: '#542916', bold: true }, colors: ['#8babca', '#a13a1e', '#f1c166', '#a79058', '#22c55e'], nodePadding: 35 },
                link: { colorMode: 'gradient', color: { fillOpacity: 0.7 } }
            }
        };
        let chart = new google.visualization.Sankey(container);
        chart.draw(data, options);
    }

    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function showToast(msg) { let t = document.getElementById('toastMsg'); t.innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
    function clearData() { if(confirm('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏î‡∏¥‡∏ö‡∏≠‡∏™? (‡∏´‡∏≤‡∏¢‡πÄ‡∏Å‡∏•‡∏µ‡πâ‡∏¢‡∏á‡πÄ‡∏•‡∏¢‡∏ô‡∏∞!)')) { localStorage.clear(); location.reload(); } }

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ
    function openConfigModal() {
        document.getElementById('userNameInput').value = userName; 
        document.getElementById('userAgeInput').value = userAge > 0 ? userAge : '';
        document.getElementById('cfgG').value = cfg.g;
        document.getElementById('cfgS').value = cfg.s;
        document.getElementById('cfgE').value = cfg.e;
        document.getElementById('cfgJ').value = cfg.j;
        
        // ‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô 4 ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏´‡πâ‡∏ö‡∏≠‡∏™‡πÅ‡∏Å‡πâ
        document.getElementById('initG').value = currentBalances.growth;
        document.getElementById('initS').value = currentBalances.security;
        document.getElementById('initE').value = currentBalances.essential;
        document.getElementById('initJ').value = currentBalances.joy;
        
        openModal('configModal');
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ã‡∏ü‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà
    function applyInitialBalances() {
        let g = parseFloat(document.getElementById('initG').value) || 0;
        let s = parseFloat(document.getElementById('initS').value) || 0;
        let e = parseFloat(document.getElementById('initE').value) || 0;
        let j = parseFloat(document.getElementById('initJ').value) || 0;

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤
        currentBalances.growth = g;
        currentBalances.security = s;
        currentBalances.essential = e;
        currentBalances.joy = j;

        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡∏•‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏° 100% (‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡∏Å‡πâ‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà)
        baseAmounts.growth = g;
        baseAmounts.security = s;
        baseAmounts.essential = e;
        baseAmounts.joy = j;

        saveStorage();
        updateUI();
        
        // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ Dashboard ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
        if(typeof renderAnalyticsChart === 'function') renderAnalyticsChart('week'); 
        
        closeModal('configModal');
        showToast('‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
    }

    window.onload = () => { 
        loadStorage(); 
        document.getElementById('cfgG').value=cfg.g;
        document.getElementById('cfgS').value=cfg.s; 
        document.getElementById('cfgE').value=cfg.e; document.getElementById('cfgJ').value=cfg.j; 
        updateUI(); 
    };
</script>

</body>
</html>